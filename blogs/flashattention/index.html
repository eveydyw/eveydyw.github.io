<!doctype html><html lang=en class=no-js><head><script src=/js/critical.bundle.min.85a7f5f23dc031d38877ecdb71b00d49e8a62c54f1ba98e75a734706ea09f30a.js integrity="sha256-haf18j3AMdOId+zbcbANSeimLFTxupjnWnNHBuoJ8wo=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.143.1"><meta name=theme content="Hinode 0.29.3"><link rel=stylesheet href="/css/main.min.2035ba2641dd892fae7cbd28eb9f8ed3c3c8330a06d3f53264b92e4aa28df477.css" integrity="sha256-IDW6JkHdiS+ufL0o65+O08PIMwoG0/UyZLkuSqKN9Hc=" crossorigin=anonymous><link rel=preload href=/fonts/inter-v12-latin-regular.woff2 as=font type=font/woff2 crossorigin><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>EV's Blog - FlashAttention</title>
<meta name=description content="FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="FlashAttention"><meta property="og:description" content="FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"><meta property="og:url" content="https://eveydyw.github.io/blogs/flashattention/"><meta property="og:site_name" content="EV's Blog"><meta property="article:published_time" content="2024-06-05T22:58:50+08:00"><meta property="article:modified_time" content="2024-06-05T22:58:50+08:00"><meta property="og:image" content="https://eveydyw.github.io/img/logo1280x640.png"><meta property="og:image:alt" content="FlashAttention"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="FlashAttention"><meta name=twitter:description content="FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"><meta name=twitter:image content="https://eveydyw.github.io/img/logo1280x640.png"><meta name=twitter:image:alt content="FlashAttention"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://eveydyw.github.io/#/schema/organization/1","name":"Hinode","url":"https://eveydyw.github.io/","sameAs":[null,"https://github.com/gethinode/hinode"],"logo":{"@type":"ImageObject","@id":"https://eveydyw.github.io/#/schema/image/1","url":"https://eveydyw.github.io/img/logo512x512.png","width":512,"height":512,"caption":"Hinode"},"image":{"@id":"https://eveydyw.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://eveydyw.github.io/#/schema/website/1","url":"https://eveydyw.github.io/","name":"EV\u0027s Blog","description":"Hinode is a clean documentation and blog theme for your Hugo site based on Bootstrap 5.","publisher":{"@id":"https://eveydyw.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/flashattention/","url":"https://eveydyw.github.io/blogs/flashattention/","name":"FlashAttention","description":"FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness","isPartOf":{"@id":"https://eveydyw.github.io/#/schema/website/1"},"about":{"@id":"https://eveydyw.github.io/#/schema/organization/1"},"datePublished":"2024-06-05T22:58:50CET","dateModified":"2024-06-05T22:58:50CET","breadcrumb":{"@id":"https://eveydyw.github.io/blogs/flashattention/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://eveydyw.github.io/blogs/flashattention/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eveydyw.github.io/blogs/flashattention/"]}]},{"@type":"BreadcrumbList","@id":"https://eveydyw.github.io/blogs/flashattention/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/","url":"https://eveydyw.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/","url":"https://eveydyw.github.io/blogs/","name":"Blogs"}},{"@type":"ListItem","position":3,"item":{"@id":"https://eveydyw.github.io/blogs/flashattention/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://eveydyw.github.io/blogs/flashattention/#/schema/image/2","url":"https://eveydyw.github.io/img/logo1280x640.png","contentUrl":"https://eveydyw.github.io/img/logo1280x640.png","caption":"FlashAttention"}]}]}</script><link rel=icon type=image/png sizes=16x16 href=/img/my_logo_hu_10729e67805acfd8.png><link rel=icon type=image/png sizes=32x32 href=/img/my_logo_hu_f267cd4735c3fb50.png><link rel=icon type=image/png sizes=48x48 href=/img/my_logo_hu_bc348718a5ba4099.png><link rel=apple-touch-icon sizes=180x180 href=/img/my_logo_hu_a8f52fe79483cdab.png><script>MathJax={loader:{load:["[tex]/html","[tex]/ams","[tex]/amscd"]},tex:{inlineMath:[["\\(","\\)"],["$","$"]],displayMath:[["\\[","\\]"],["$$","$$"]],processEscapes:!0,packages:["base","ams","amscd"],tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],renderActions:{addMenu:[0,"",""],checkLoading:[0,"",""]}},chtml:{scale:1,displayAlign:"center",displayIndent:"0em",lineWidth:"container"},svg:{fontCache:"global"}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js></script></head><body><div class="d-flex flex-column min-vh-100"><div class="d-flex flex-column"><div class="container-fluid fixed-top p-0"><nav class="navbar p-4 bg-body navbar-fixed-top navbar-expand-md"><div class="container-xxl p-0"><div class="d-flex navbar-container justify-content-center"><div class="d-flex align-items-center"><button class="navbar-toggler collapsed p-0 mx-auto invisible fw-30" type=button><svg class="svg-inline--fa fas fa-ellipsis fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-ellipsis"/></svg></button></div><div class=mx-auto><a class=navbar-brand href=/ aria-label=Home><img src=/img/my_logo.svg alt="EV's Blog logo" height=30 width=30></a></div><div class="d-flex align-items-center"><button class="navbar-toggler main-nav-toggler collapsed p-0" type=button data-bs-toggle=collapse data-bs-target=#navbar-0-collapse aria-controls=navbar-0 aria-expanded=false aria-label="Toggle main navigation">
<span class="toggler-icon top-bar emphasis"></span>
<span class="toggler-icon middle-bar emphasis"></span>
<span class="toggler-icon bottom-bar emphasis"></span></button></div></div><div class="navbar-collapse collapse" id=navbar-0-collapse><div class="d-flex flex-fill ms-md-3 mt-4 mt-md-0"><form class="search flex-fill position-relative me-auto"><input class="search-input form-control is-search" type=search placeholder="Search this site" aria-label="Search this site" autocomplete=off name=search-input><div class="search-suggestions shadow bg-body rounded d-none" data-no-results="No results for"></div></form></div><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link data-nav=main data-nav-main=home href=/><span>Home</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=blogs href=/Blogs/><span>Blogs</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=tags href=/tags><span>Tags</span>&nbsp;</a></li><li class="d-flex mode-switch align-items-center" id=navbar-mode><input type=checkbox class="checkbox navbar-mode-selector" id=navbar-mode-checkbox aria-label="Toggle theme">
<label class=label for=navbar-mode-checkbox><svg class="svg-inline--fa fas fa-sun fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 512 512"><use href="#fas-sun"/></svg><svg class="svg-inline--fa fas fa-moon fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 384 512"><use href="#fas-moon"/></svg><div class=ball></div></label></li></ul></div></div></nav></div><div class=main-content></div></div><div class="container-xxl flex-fill p-4 px-xxl-0"><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3"><div class="col col-lg-2 d-none d-lg-block sidebar-overflow sticky-top pt-5"></div><div class="col-12 col-md-9 col-lg-8 mb-5 p-4"><nav aria-label=breadcrumb class=d-sm-none><ol class=breadcrumb><li class=breadcrumb-item><a href=/blogs/><svg class="svg-inline--fa fas fa-angle-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-angle-left"/></svg>&nbsp;&nbsp;Blogs</a></li></ol></nav><nav aria-label=breadcrumb class="d-none d-sm-block"><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/blogs/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>FlashAttention</li></ol></nav><p class="display-4 mt-5">FlashAttention</p><small class="text-body-secondary text-uppercase">Posted on June 5, 2024
&bull;
10&nbsp;min read &bull;
2,093&nbsp;words</small><p class="lead mb-5 mt-3">FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</p><div class="d-md-none pb-5"><div class="d-grid gap-2 mx-auto"><a aria-label="On this page" href=#toc-collapse class="btn btn-outline-secondary position-relative toc-button" data-bs-toggle=collapse aria-expanded=false aria-controls=toc-collapse role=button><span class="d-flex justify-content-between"><span class=my-auto>On this page</span><span class="align-self-center ps-1"><svg class="svg-inline--fa fas fa-sort" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-sort"/></svg></span></span></a></div><div class="collapse border bg-body-tertiary rounded p-1 navbar-nav-scroll" id=toc-collapse><small><div class="toc toc-panel text-body p-2"><a class="toc-item toc-level-1" href=/blogs/flashattention/#background>Background </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#structure-of-gpu-memory>Structure of GPU Memory </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#attention-的计算复杂度>Attention 的计算复杂度 </a><a class="toc-item toc-level-1" href=/blogs/flashattention/#flashattention>FlashAttention </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#tiling-and-recomputation>Tiling and Recomputation </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#io-complexity-of-flashattention>IO Complexity of FlashAttention</a></div></small></div></div><div class=content><h2 id=background class=heading>Background<a href=#background aria-labelledby=background><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=structure-of-gpu-memory class=heading>Structure of GPU Memory<a href=#structure-of-gpu-memory aria-labelledby=structure-of-gpu-memory><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250310221404825.png width=35% alt></center><p>在 GPU 当中，memory 也跟 CPU memory 一样分成不同的 level，通常 <strong>越上层空间越小</strong> 但是 <strong>速度越快</strong></p><blockquote class=blockquote><ul><li><p><strong>HBM</strong>：平常主要提到的 GPU memory 通常是指 <strong>high bandwidth memory (HBM)</strong></p><ul><li>A100 的 <strong>HBM</strong> 大概
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>40</mn></mrow><annotation encoding="application/x-tex">40</annotation></semantics></math></span>
</span>GB~
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>80</mn></mrow><annotation encoding="application/x-tex">80</annotation></semantics></math></span>
</span>GB，</li><li><strong>HBM</strong> 的bandwidth为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.5</mn></mrow><annotation encoding="application/x-tex">1.5</annotation></semantics></math></span>
</span>–
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2.0</mn></mrow><annotation encoding="application/x-tex">2.0</annotation></semantics></math></span>
</span>TB/s。</li></ul></li><li><p><strong>SRAM</strong>：再往上一层的 memory 称为 <strong>SRAM</strong></p><ul><li>总容量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>192</mn><mtext>KB</mtext><mo>×</mo><mn>108</mn></mrow><annotation encoding="application/x-tex">192 \text{KB} \times 108</annotation></semantics></math></span>
</span>(streaming multi-processors) ，</li><li>bandwidth 可以达到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>19</mn></mrow><annotation encoding="application/x-tex">19</annotation></semantics></math></span>
</span>TB/s</li></ul><p>因此当有运算需要从 HBM 当中不断读写资料的时候，这样的速度差就容易导致 <strong>HBM</strong> 的读取变成整体效能的 bottleneck。</p></li></ul></blockquote><p>在 GPU 当中有非常大量的 threads (kernel) 负责执行 operation 的运算，而整个运算的过程基本上是从 <strong>HBM</strong> 当中将资料载入至 <strong>SRAM</strong> 中，执行运算并将 output 存回 <strong>HBM</strong> 当中。</p><p>根据每个 operation <strong>实际运算时间</strong>和 <strong>memory 存取的时间</strong>多寡，我们可以将 operations 归纳为两个类别，分别是 <strong>compute-bound</strong> 以及 <strong>memory-bound</strong></p><blockquote class=blockquote><ul><li><strong>Compute-bound</strong> ：运算的主要时间都耗费在 operation 的计算上，<strong>HBM</strong> 的存取只占了其中一点点的时间<ul><li><strong>多维度的矩阵相乘</strong></li><li><strong>高 channel 数的 convolution</strong></li></ul></li><li><strong>Memory-bound</strong>：运算主要时间都耗费在 memory 的读取上，而实际的运算只占了其中一点点的时间<ul><li><strong>element-wise</strong> (eg, activation, dropout)</li><li><strong>reduction</strong> (eg, sum, softmax, batch norm, layer norm) 皆属于 memory-bound。</li></ul></li></ul></blockquote><h3 id=attention-的计算复杂度 class=heading>Attention 的计算复杂度<a href=#attention-%e7%9a%84%e8%ae%a1%e7%ae%97%e5%a4%8d%e6%9d%82%e5%ba%a6 aria-labelledby=attention-的计算复杂度><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><h4 id=attention-的计算过程 class=heading>Attention 的计算过程<a href=#attention-%e7%9a%84%e8%ae%a1%e7%ae%97%e8%bf%87%e7%a8%8b aria-labelledby=attention-的计算过程><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><blockquote class=blockquote><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>：序列长度</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span>
</span>：hidden size</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span>
</span>: head dimension</li></ul></blockquote><ul><li><p><strong>线性变换</strong>：</p><ul><li>对输入序列
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>k</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf X\in \mathbb{R}^{N\times k}</annotation></semantics></math></span>
</span>进行线性变换，分别乘以三个不同的权重矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf W^Q</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf W^K</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf W^V</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>k</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{k\times d} </annotation></semantics></math></span>
</span>得到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times d} </annotation></semantics></math></span>
</span>。</li><li>该步骤的复杂度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>3</mn><mi>N</mi><mi>k</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(3Nkd)</annotation></semantics></math></span>
</span>。</li></ul></li><li><p><strong>计算相似度得分</strong>：</p><ul><li>通过
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>两个矩阵计算相似度得分，得到注意力权重矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi mathvariant="normal">⊤</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf Q \mathbf K^{\top}\in \mathbb{R}^{N\times N} </annotation></semantics></math></span></span></li><li><strong>该步骤的复杂度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>N</mi><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(NNd)</annotation></semantics></math></span>
</span>。</strong></li></ul></li><li><p><strong>Softmax</strong>: 该步骤的复杂度为:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span></span></p></li><li><p><strong>加权平均</strong>：</p><ul><li>将 Softmax 之后的注意力权重矩阵与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>矩阵相乘。</li><li><strong>该步骤的复杂度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2d)</annotation></semantics></math></span>
</span>。</strong></li></ul></li></ul><p>通常情况下有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>≫</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">N \gg d</annotation></semantics></math></span>
</span>（GPT2中，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>1024</mn></mrow><annotation encoding="application/x-tex">N=1024</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d=64</annotation></semantics></math></span>
</span>），因此<strong>总体的计算复杂度约为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2d)</annotation></semantics></math></span></span></strong></p><h2 id=flashattention class=heading>FlashAttention<a href=#flashattention aria-labelledby=flashattention><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=tiling-and-recomputation class=heading>Tiling and Recomputation<a href=#tiling-and-recomputation aria-labelledby=tiling-and-recomputation><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>FlashAttention</strong> 通过利用 GPU 硬件中的特殊设计，针对全局内存和共享存储的 I/O 速度的不同，尽可能</p><ol><li><strong>高效地使用 SRAM 来加快计算速度</strong></li><li><strong>避免 HBM 中读取或写入注意力矩阵</strong></li></ol><p>达成该目标需要能 <strong>做到在不访问整个输入的情况下计算 Softmax 函数，并且后向传播中不能存储中间注意力矩阵</strong>。</p><ul><li>标准 Attention 算法中，Softmax 计算按行进行，即在与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>做矩阵乘法之前，需要将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>的各个分块完成一整行的计算。</li><li>得到 Softmax 的结果后，再与矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>分块做矩阵乘。</li></ul><p>在 <strong>FlashAttention</strong> 中，将输入分割成块，并在输入块上进行多次传递，从而 <strong>以增量方式</strong> 执行 Softmax 计算。</p><ol><li><strong>Tiling (在向前和向后传递时使用)-基本上将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N \times N</annotation></semantics></math></span>
</span>softmax/scores 矩阵分块成块。</strong></li><li><strong>Recomputation (重算，仅在向后传递中使用)</strong></li></ol><h4 id=tiling-平铺 class=heading>Tiling 平铺<a href=#tiling-%e5%b9%b3%e9%93%ba aria-labelledby=tiling-平铺><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><blockquote class=blockquote><p><strong>Theorem 1</strong></p><p><strong>FlashAttention</strong> 的算法能够在
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2d)</annotation></semantics></math></span>
</span>FLOPs 内正确的返回
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi mathvariant="bold">Q</mi><msup><mi mathvariant="bold">K</mi><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">O=\mathrm{softmax}(\mathbf Q \mathbf K^{\top})\mathbf V</annotation></semantics></math></span>
</span>，除去输入和输出之外还需要
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span>
</span>大小的空间</p></blockquote><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250311223109005.png width=85% alt></center><ul><li><strong>输入</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi><mo separator="true">,</mo><mi mathvariant="bold">K</mi><mo separator="true">,</mo><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf Q,\mathbf K,\mathbf V</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times d} </annotation></semantics></math></span>
</span>位于高速显存（HBM）中，GPU 芯片中的 <strong>SRAM 大小</strong> 为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span></span></li><li><strong>输出</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span></span></li></ul><h5 id=初始化 class=heading>初始化<a href=#%e5%88%9d%e5%a7%8b%e5%8c%96 aria-labelledby=初始化><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h5><h6 id=设置块大小-block-size class=heading>设置块大小 block size<a href=#%e8%ae%be%e7%bd%ae%e5%9d%97%e5%a4%a7%e5%b0%8f-block-size aria-labelledby=设置块大小-block-size><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h6><ul><li><p>block 的列大小：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">B_c =[\frac{M}{4d}]</annotation></semantics></math></span></span></p></li><li><p>block 的行大小：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mi>min</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mo stretchy="false">[</mo><mfrac><mi>M</mi><mrow><mn>4</mn><mi>d</mi></mrow></mfrac><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>d</mi><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">B_r = \min \big([\frac{M}{4d}], d \big)</annotation></semantics></math></span></span></p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\min</annotation></semantics></math></span>
</span>函数的目的是防止块大小
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><msub><mi>B</mi><mi>r</mi></msub><mo>&gt;</mo><mfrac><mi>M</mi><mn>4</mn></mfrac></mrow><annotation encoding="application/x-tex">B_c \times B_r &gt; \frac{M}{4}</annotation></semantics></math></span>
</span>, 这样就无法把
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个这样的块放到 SRAM。</p></li></ul><h6 id=hbm-中初始化 class=heading>HBM 中初始化<a href=#hbm-%e4%b8%ad%e5%88%9d%e5%a7%8b%e5%8c%96 aria-labelledby=hbm-中初始化><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h6><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi><mo>=</mo><msub><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf O = \begin{bmatrix}0\end{bmatrix}_{N \times d} \in \mathbb{R}^{N\times d}</annotation></semantics></math></span>
</span>：<strong>结果矩阵</strong>
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span>初始化为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span>
</span>，后面会逐步把<strong>中间结果</strong>累加进去</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">l</mi><mo>=</mo><msub><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>N</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf l = \begin{bmatrix}0\end{bmatrix}_{N}\in \mathbb{R}^{N}</annotation></semantics></math></span>
</span>：对于每一行来说，它是一个标量，用于<strong>累加指数和</strong>，由于输出有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>行，所以这里的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">l</mi></mrow><annotation encoding="application/x-tex">\mathbf l</annotation></semantics></math></span>
</span>是长度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>的向量</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">m</mi><mo>=</mo><msub><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>N</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>N</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf m= \begin{bmatrix}- \infty\end{bmatrix}_N \in \mathbb{R}^{N}</annotation></semantics></math></span>
</span>：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">m</mi></mrow><annotation encoding="application/x-tex">\mathbf m</annotation></semantics></math></span>
</span>用于记录 <strong>每一行当前最大的值</strong>，所以也是长度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>，而
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow><annotation encoding="application/x-tex">-\infty</annotation></semantics></math></span>
</span>是求
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>max</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">\max</annotation></semantics></math></span>
</span>的合适初始值。</li></ul><h6 id=切分子块--mathbf-qmathbf-kmathbf-v class=heading>切分子块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span><a href=#%e5%88%87%e5%88%86%e5%ad%90%e5%9d%97--mathbf-qmathbf-kmathbf-v aria-labelledby=切分子块--mathbf-qmathbf-kmathbf-v><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h6><ul><li><p>将矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>按行切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>r</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_r = [\frac{N}{B_r}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">Q</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">Q</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf Q_1, \cdots , \mathbf Q_{T_r}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">Q</mi><mi>i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf Q_i\in \mathbb{R}^{B_r\times d}</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">Q</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>Q</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    \mathbf Q_i =\begin{pmatrix}
    Q_{i_11} &amp; Q_{i_12} &amp; \ldots &amp; Q_{i_1d} \\
    Q_{i_21} &amp; Q_{i_22} &amp; \ldots &amp; Q_{i_2d}\\
    \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
    Q_{i_{B_r}1} &amp; Q_{i_{B_r}2}  &amp; \ldots &amp; Q_{i_{B_r}d}\\
    \end{pmatrix}
    </annotation></semantics></math></span></div></li><li><p>将矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>按行切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_c = [\frac{N}{B_c}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">K</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">K</mi><msub><mi>T</mi><mi>c</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf K_1, \cdots , \mathbf K_{T_c}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">K</mi><mi>j</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf K_j\in \mathbb{R}^{B_c\times d}</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">K</mi><mi>j</mi><mi>T</mi></msubsup><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>1</mn><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>1</mn><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>1</mn><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>2</mn><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>2</mn><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mn>2</mn><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mi>d</mi><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mi>d</mi><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>K</mi><mrow><mi>d</mi><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    \mathbf K_j^T =\begin{pmatrix}
    K_{1j_1} &amp; K_{1j_2} &amp; \ldots &amp; K_{1j_{B_c}} \\
    K_{2j_1} &amp; K_{2j_2}&amp; \ldots &amp; K_{2j_{B_c}}\\
    \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
    K_{dj_1} &amp; K_{dj_2}  &amp; \ldots &amp; K_{dj_{B_c}}\\
    \end{pmatrix}
    </annotation></semantics></math></span></div></li><li><p>将矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>按行切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_c = [\frac{N}{B_c}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">V</mi><msub><mi>T</mi><mi>c</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf V_1, \cdots , \mathbf V_{T_c}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mi>j</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf V_j\in \mathbb{R}^{B_c\times d}</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mi>j</mi></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>1</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>1</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>1</mn></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>2</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>2</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><mn>2</mn></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>V</mi><mrow><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    \mathbf V_j =\begin{pmatrix}
    V_{j_11} &amp; V_{j_12} &amp; \ldots &amp; V_{j_1d} \\
    V_{j_21} &amp; V_{j_22}&amp; \ldots &amp; V_{j_2d}\\
    \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
    V_{j_{B_c}1} &amp; V_{j_{B_c}2}  &amp; \ldots &amp; V_{j_{B_c}d}\\
    \end{pmatrix}
    </annotation></semantics></math></span></div></li></ul><h6 id=切分子块-mathbf-omathbf-lmathbf-m class=heading>切分子块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">l</mi></mrow><annotation encoding="application/x-tex">\mathbf l</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">m</mi></mrow><annotation encoding="application/x-tex">\mathbf m</annotation></semantics></math></span>
</span><a href=#%e5%88%87%e5%88%86%e5%ad%90%e5%9d%97-mathbf-omathbf-lmathbf-m aria-labelledby=切分子块-mathbf-omathbf-lmathbf-m><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h6><ul><li><p>将矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span>切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>M</mi><msub><mi>B</mi><mi>r</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_r = [\frac{M}{B_r}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">O</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">O</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf O_1, \cdots , \mathbf O_{T_r}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">O</mi><mi>i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf O_i\in \mathbb{R}^{B_r\times d}</annotation></semantics></math></span></span></p></li><li><p>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">l</mi></mrow><annotation encoding="application/x-tex">\mathbf l</annotation></semantics></math></span>
</span>切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>M</mi><msub><mi>B</mi><mi>r</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_r = [\frac{M}{B_r}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">l</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf l_1, \cdots , \mathbf l_{T_r}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf l_i\in \mathbb{R}^{B_r}</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">l</mi><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">l</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">l</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><mn>1</mn></msub></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    \mathbf l =\begin{pmatrix}
    \mathbf l_{1}\\
    \vdots \\
    \mathbf l_{i} \\ 
    \vdots \\
    \mathbf l_{T_r}\\
    \end{pmatrix} , \quad \mathbf l_i = \begin{pmatrix}
    l_{i_1}\\
    \vdots \\
    l_{i_{B_r}}\\
    \end{pmatrix}
    </annotation></semantics></math></span></div></li><li><p>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">m</mi></mrow><annotation encoding="application/x-tex">\mathbf m</annotation></semantics></math></span>
</span>切分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub><mo>=</mo><mo stretchy="false">[</mo><mfrac><mi>M</mi><msub><mi>B</mi><mi>r</mi></msub></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">T_r = [\frac{M}{B_r}]</annotation></semantics></math></span>
</span>块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">m</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi mathvariant="bold">m</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf m_1, \cdots , \mathbf m_{T_r}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">m_i\in \mathbb{R}^{B_r}</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold">m</mi><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">m</mi><mn>1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">m</mi><msub><mi>T</mi><mi>r</mi></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">,</mo><mspace width="1em"/><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>m</mi><msub><mi>i</mi><mn>1</mn></msub></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>m</mi><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
    \mathbf m =\begin{pmatrix}
    \mathbf m_{1}\\
    \vdots \\
    \mathbf m_{i} \\ 
    \vdots \\
    \mathbf m_{T_r}\\
    \end{pmatrix} , \quad \mathbf m_i = \begin{pmatrix}
    m_{i_1}\\
    \vdots \\
    m_{i_{B_r}}\\
    \end{pmatrix}
    </annotation></semantics></math></span></div></li></ul><h5 id=循环 class=heading>循环<a href=#%e5%be%aa%e7%8e%af aria-labelledby=循环><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h5><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250311224027301.png width=35% alt></center><p><strong>for
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">j = 1</annotation></semantics></math></span>
</span>to
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span>
</span>do （列）：</strong></p><ul><li><p>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">K</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf K_j</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf V_j</annotation></semantics></math></span>
</span>从 <strong>HBM</strong> 中读入芯片存储 <strong>SRAM</strong></p></li><li><p><strong>for
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i = 1</annotation></semantics></math></span>
</span>to
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">T_r</annotation></semantics></math></span>
</span>do （行）：</strong></p><ul><li><p>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf Q_i</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">O</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf O_i</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf l_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf m_i</annotation></semantics></math></span>
</span>从 <strong>HBM</strong> 中读入芯片存储 <strong>SRAM</strong></p></li><li><p><strong>计算 当前的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf {\tilde{m}}_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">l</mi><mo>~</mo></mover><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{l}}_i</annotation></semantics></math></span></span></strong></p><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi mathvariant="bold">Q</mi><mi>i</mi></msub><msubsup><mi mathvariant="bold">K</mi><mi>j</mi><mi>T</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf S_{ij} = \mathbf{Q}_i\mathbf{K}_j^T \in \mathbb{R}^{B_r\times B_c}</annotation></semantics></math></span></span></li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold">S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
        \mathbf S_{ij} =\begin{pmatrix}
        S_{i_1j_1} &amp; S_{i_1j_2}&amp; \ldots &amp; S_{i_1j_{B_c}}\\
        S_{i_2j_1} &amp; S_{i_2j_2} &amp; \ldots &amp; S_{i_2j_{B_c}}\\
        \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
        S_{i_{B_r}j_1} &amp; S_{i_{B_r}j_2}  &amp; \ldots &amp; S_{i_{B_r}j_{B_c}}\\
        \end{pmatrix}
        </annotation></semantics></math></span></div><p>其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mi>n</mi></msub><msub><mi>j</mi><mi>m</mi></msub></mrow></msub><mo>=</mo><msub><mi>Q</mi><mrow><msub><mi>i</mi><mi>n</mi></msub><mn>1</mn></mrow></msub><msub><mi>K</mi><mrow><mn>1</mn><msub><mi>j</mi><mi>m</mi></msub></mrow></msub><mo>+</mo><msub><mi>Q</mi><mrow><msub><mi>i</mi><mi>n</mi></msub><mn>2</mn></mrow></msub><msub><mi>K</mi><mrow><mn>2</mn><msub><mi>j</mi><mi>m</mi></msub></mrow></msub><mo>+</mo><mo>…</mo><mo>+</mo><msub><mi>Q</mi><mrow><msub><mi>i</mi><mi>n</mi></msub><mi>d</mi></mrow></msub><msub><mi>K</mi><mrow><mi>d</mi><msub><mi>j</mi><mi>m</mi></msub></mrow></msub></mrow><annotation encoding="application/x-tex">S_{i_nj_m} = Q_{i_n1}K_{1j_m} + Q_{i_n2}K_{2j_m}  + \ldots + Q_{i_nd}K_{dj_m}</annotation></semantics></math></span></span></p><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">w</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{m}}_{ij} = \mathrm{rowmax} (\mathbf S_{ij}) \in \mathbb{R}^{B_r}</annotation></semantics></math></span>
</span>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{m}}_{ij}</annotation></semantics></math></span>
</span>逐行计算，找到每一行的最大值</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
        \mathbf{\tilde{m}}_{ij} =\begin{pmatrix}
        \tilde{m}_{i_1j}\\
        \tilde{m}_{i_2j} \\
        \vdots \\
        \tilde{m}_{i_{B_r}j}\\
        \end{pmatrix}
        </annotation></semantics></math></span></div><p>其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mi>k</mi></msub><mi>j</mi></mrow></msub><mo>=</mo><mi>max</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.8em" maxsize="1.8em">{</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mi>k</mi></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mi>k</mi></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>S</mi><mrow><msub><mi>i</mi><mi>k</mi></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo><mo fence="false" stretchy="true" minsize="1.8em" maxsize="1.8em">}</mo></mrow><annotation encoding="application/x-tex">\tilde{m}_{i_kj} = \max \Big\{ \big[\begin{matrix} S_{i_kj_1} &amp; S_{i_kj_2}&amp; \ldots &amp; S_{i_kj_{B_c}}\end{matrix} \big] \Big\}</annotation></semantics></math></span></span></p><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{P}}_{ij} =\exp(S_{ij} - \tilde{m}_{ij}) \in \mathbb{R}^{B_r \times B_c}</annotation></semantics></math></span>
</span>：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf {\tilde{P}}_{ij}</annotation></semantics></math></span>
</span>逐点运算，把
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf S_{ij}</annotation></semantics></math></span>
</span>减去第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
</span>行的最大值
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{m}}_{ij}</annotation></semantics></math></span>
</span>(注意：这个下标
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span><strong>表示这是第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span>次计算</strong>），然后计算指数</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>S</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub><mo>−</mo><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo><mo>=</mo><mi>exp</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>1</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><mn>2</mn></msub></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
        \mathbf {\tilde{P}}_{ij} =\exp \big(
        \begin{pmatrix}
        S_{i_1j_1}-\tilde{m}_{i_1j}&amp; S_{i_1j_2}-\tilde{m}_{i_1j} &amp; \ldots &amp; S_{i_1j_{B_c}}-\tilde{m}_{i_1j}\\
        S_{i_2j_1}-\tilde{m}_{i_2j} &amp; S_{i_2j_2}-\tilde{m}_{i_2j} &amp; \ldots &amp; S_{i_2j_{B_c}}-\tilde{m}_{i_2j}\\
        \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
        S_{i_{B_r}j_1}-\tilde{m}_{i_{B_r}j} &amp; S_{i_{B_r}j_2}-\tilde{m}_{i_{B_r}j} &amp; \ldots &amp; S_{i_{B_r}j_{B_c}}-\tilde{m}_{i_{B_r}j}\\
        \end{pmatrix}
        \big) = \exp\big(
        \begin{pmatrix}
        \tilde{P}_{i_1j_1} &amp; \tilde{P}_{i_1j_2}&amp; \ldots &amp; \tilde{P}_{i_1j_{B_c}}\\
        \tilde{P}_{i_2j_1} &amp; \tilde{P}_{i_2j_2} &amp; \ldots &amp; \tilde{P}_{i_2j_{B_c}}\\
        \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
        \tilde{P}_{i_{B_r}j_1} &amp; \tilde{P}_{i_{B_r}j_2}  &amp; \ldots &amp; \tilde{P}_{i_{B_r}j_{B_c}}\\
        \end{pmatrix}
        \big)
        </annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mi mathvariant="normal">r</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">w</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{l}}_{ij} = \mathrm{rowsum} (\tilde P_{ij}) \in \mathbb{R}^{B_r}</annotation></semantics></math></span>
</span>：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{l}}_{ij}</annotation></semantics></math></span>
</span>逐行计算，把每一行的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{P}}_{ij}</annotation></semantics></math></span>
</span>加起来</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>2</mn></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
        \mathbf{\tilde{l}}_{ij} =\begin{pmatrix}
        \tilde{l}_{i_1j}\\
        \tilde{l}_{i_2j} \\
        \vdots \\
        \tilde{l}_{i_{B_r}j}\\
        \end{pmatrix}
        </annotation></semantics></math></span></div><p>其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>l</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mi>k</mi></msub><mi>j</mi></mrow></msub><mo>=</mo><msub><mo>∑</mo><mrow><msub><mi>j</mi><mi>n</mi></msub><mo>∈</mo><mo stretchy="false">[</mo><msub><mi>j</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>j</mi><msub><mi>B</mi><mi>c</mi></msub></msub><mo stretchy="false">]</mo></mrow></msub><msub><mover accent="true"><mi>P</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mi>k</mi></msub><msub><mi>j</mi><mi>n</mi></msub></mrow></msub></mrow><annotation encoding="application/x-tex">\tilde{l}_{i_kj} = \sum_{j_n \in[j_1, j_{B_c}]} \tilde P_{i_kj_n} </annotation></semantics></math></span></span></p></li><li><p><strong>更新
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf m_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf l_i</annotation></semantics></math></span>
</span></strong>：</p><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup><mo>=</mo><msub><mi mathvariant="bold">m</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi mathvariant="bold">m</mi><mrow><mi>i</mi><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false">)</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf m^{\mathrm {new}}_{i} = \mathbf m_{ij}=\max(\mathbf m_{ij-1}, \mathbf{\tilde{m}}_{ij} ) \in \mathbb{R}^{B_r}</annotation></semantics></math></span>
</span>： 更新每一行到当前的最大值，同理，此时的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span><strong>表示的是第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span>次更新</strong>。</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mtext>new</mtext></msubsup><mo>=</mo><msub><mi mathvariant="bold">m</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>max</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><msub><mi>m</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>j</mi></mrow></msub><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>max</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><msub><mi>m</mi><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mover accent="true"><mi>m</mi><mo>~</mo></mover><mrow><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mi>j</mi></mrow></msub><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
            \mathbf m_{i}^{\text{new}} = \mathbf m_{ij}= \begin{pmatrix}
            \max\big[m_{i_1j-1 } ,&amp;\tilde{m}_{i_1j}\big]\\
            \vdots \\
            \max\big [m_{i_{B_r}j-1 } ,&amp;\tilde{m}_{i_{B_r}j}\big]\\
            \end{pmatrix}
            </annotation></semantics></math></span></div></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">l</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup><mo>=</mo><msub><mi mathvariant="bold">l</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msup><mi>e</mi><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup><msub><mi mathvariant="bold">l</mi><mrow><mi>i</mi><mi>j</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>+</mo><msup><mi>e</mi><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup><msub><mover accent="true"><mi mathvariant="bold">l</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf l^{\mathrm {new}}_{i} = \mathbf l_{ij} = e^{\mathbf m_i-\mathbf m^{\mathrm {new}}_i} \mathbf l_{ij-1} + e^{\mathbf{\tilde m}_{ij}-\mathbf m^{\mathrm {new}}_i}\mathbf {\tilde l}_{ij} \in \mathbb{R}^{B_r}</annotation></semantics></math></span>
</span>：更新每一行的修正过后的累加值，同理，此时的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span><strong>表示的是第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span>次更新</strong>。</p></li></ul></li><li><p><strong>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi><mo>←</mo><munder><munder><mrow><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">g</mi></mrow><mo stretchy="false">(</mo><msubsup><mi mathvariant="bold">l</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">(</mo><mn>3</mn><mo stretchy="false">)</mo></mrow></munder><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">(</mo><munder><munder><mrow><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">g</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub><mo stretchy="false">)</mo><msup><mi>e</mi><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup><msub><mi mathvariant="bold">O</mi><mi>i</mi></msub></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></munder><mo>+</mo><munder><munder><mrow><msup><mi>e</mi><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mi>i</mi></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">V</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></munder><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">)</mo></mrow><annotation encoding="application/x-tex">\mathbf O\leftarrow \underbrace{\mathrm{diag}(\mathbf l^{\mathrm {new}}_i)^{-1}}_{(3)} \bigg(\underbrace{\mathrm{diag}(\mathbf l_i)e^{\mathbf m_i-\mathbf m^{\mathrm {new}}_i}\mathbf O_i}_{(1)} + \underbrace{e^{\mathbf{\tilde m}_i-\mathbf m^{\mathrm {new}}_i} \mathbf{\tilde P}_{ij}\mathbf V_{ij}}_{(2)}\bigg)</annotation></semantics></math></span>
</span>写回 HBM 中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">V</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{\tilde{P}}_{ij} \mathbf{V}_{ij} \in \mathbb{R}^{B_r\times d}</annotation></semantics></math></span></span></strong></p><p>(1)
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">O</mi><msub><mi>i</mi><mi>n</mi></msub></msub></mrow><annotation encoding="application/x-tex">\mathbf O_{i_n}</annotation></semantics></math></span>
</span>表示同一行中当前块之前块的 softmax，乘以
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf l_i</annotation></semantics></math></span>
</span>恢复得到之前块的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf P\mathbf V</annotation></semantics></math></span>
</span>, 乘以
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup></mrow><annotation encoding="application/x-tex">e^{\mathbf m_i-\mathbf m^{\mathrm {new}}_i}</annotation></semantics></math></span>
</span>得到修正后的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf P\mathbf V</annotation></semantics></math></span></span></p><p>(2) 表示当前块，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><msub><mover accent="true"><mi mathvariant="bold">m</mi><mo>~</mo></mover><mi>i</mi></msub><mo>−</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow></msup><msub><mover accent="true"><mi mathvariant="bold">P</mi><mo>~</mo></mover><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi mathvariant="bold">V</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e^{\mathbf {\tilde m}_i-\mathbf m^{\mathrm {new}}_i} \mathbf{\tilde P}_{ij}\mathbf V_{ij}</annotation></semantics></math></span>
</span>为修正后的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf P \mathbf V</annotation></semantics></math></span></span></p><p>(3) (1)+(2) 得到新的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf P \mathbf V</annotation></semantics></math></span>
</span>除以
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">l</mi><mi>i</mi><mtext>new</mtext></msubsup></mrow><annotation encoding="application/x-tex">\mathbf l_i^{\text{new}}</annotation></semantics></math></span>
</span>得到新的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span></span></p></li><li><p><strong>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">l</mi><mi>i</mi></msub><mo>←</mo><msubsup><mi mathvariant="bold">l</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf l_i \leftarrow \mathbf l^{\mathrm{new}}_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">m</mi><mi>i</mi></msub><mo>←</mo><msubsup><mi mathvariant="bold">m</mi><mi>i</mi><mrow><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">w</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf m_i \leftarrow \mathbf m^{\mathrm{new}}_i</annotation></semantics></math></span>
</span>写回 HBM 中</strong></p></li></ul></li></ul><hr><p>其中:</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>l</mi><mi>i</mi></msub><mo>=</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><mn>1</mn></msub></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋯</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub></msub></mstyle></mtd></mtr></mtable><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>B</mi><mi>r</mi></msub></msup></mrow><annotation encoding="application/x-tex">
l_i = \big[ \begin{matrix}  l_{i_1} &amp;\cdots &amp; l_{i_{B_r}} \end{matrix}\big]\in \mathbb{R}^{B_r}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnspacing="1em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">g</mi></mrow><mo stretchy="false">(</mo><msub><mi>l</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><mn>1</mn></msub></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><mn>2</mn></msub></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>i</mi><msub><mi>B</mi><mi>r</mi></msub></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{equation}
\mathrm{diag}(l_i)=
\left( \begin{array}{cccc}
l_{i_1} &amp; 0 &amp; \ldots &amp; 0 \\
0 &amp; l_{i_2} &amp; \ldots &amp; 0 \\
\vdots &amp; \vdots &amp; \ddots &amp; \vdots \\
0 &amp; 0 &amp; \ldots &amp; l_{i_{B_r}} \\
\end{array} \right)
\end{equation}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><mn>2</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo>×</mo><mtext> </mtext><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>1</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>2</mn></mrow></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><mrow><mi>i</mi><mn>2</mn><mi>d</mi></mrow></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mn>1</mn></mrow></msub></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mn>2</mn></mrow></msub></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mi>d</mi></mrow></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo>=</mo><mtext> </mtext><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>1</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>1</mn></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>1</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mn>2</mn></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>1</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>1</mn></msub><mi>d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>2</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>1</mn></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>2</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><msub><mi>i</mi><mn>2</mn></msub><mn>2</mn></mrow></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><mn>2</mn></msub><mo>×</mo><msub><mi>O</mi><mrow><mi>i</mi><mn>2</mn><mi>d</mi></mrow></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mo>×</mo><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mn>1</mn></mrow></msub></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mo>×</mo><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mn>2</mn></mrow></msub></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub><mo>×</mo><msub><mi>O</mi><msub><mi>i</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mi>d</mi></mrow></msub></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\begin{pmatrix}
                  l_{1} &amp; 0 &amp; \ldots &amp; 0 \\
                  0 &amp; l_{2} &amp; \ldots &amp; 0\\
                  \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
                  0 &amp; 0 &amp; \ldots &amp; l_{B_r}\\
                  \end{pmatrix} \times \
                  \begin{pmatrix}
                  O_{i_11} &amp; O_{i_12} &amp; \ldots &amp; O_{i_1d} \\
                  O_{i_21} &amp; O_{i_22} &amp; \ldots &amp; O_{i2d}\\
                  \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
                  O_{i_{B_r1}} &amp; O_{i_{B_r2}} &amp; \ldots &amp; O_{i_{B_rd}}\\
                  \end{pmatrix}= \
                  \begin{pmatrix}
                  l_1 \times O_{i_11} &amp; l_{1} \times O_{i_12} &amp; \ldots &amp; l_{1} \times O_{i_1d}\\
                  l_2 \times O_{i_21} &amp; l_2 \times O_{i_22} &amp; \ldots &amp; l_2 \times O_{i2d}\\
                  \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\
                  l_{B_r} \times O_{i_{B_r1}} &amp; l_{B_r} \times O_{i_{B_r2}} &amp; \ldots &amp; l_{B_r} \times O_{i_{B_rd}}
                  \end{pmatrix}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msup><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><mn>2</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>=</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><msub><mi>l</mi><mn>1</mn></msub></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><msub><mi>l</mi><mn>2</mn></msub></mfrac></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">⋱</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi><mi mathvariant="normal">⋮</mi><mpadded height="0em" voffset="0em"><mspace mathbackground="black" width="0em" height="1.5em"></mspace></mpadded></mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mo lspace="0em" rspace="0em">…</mo></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mfrac><mn>1</mn><msub><mi>l</mi><msub><mi>B</mi><mi>r</mi></msub></msub></mfrac></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\begin{pmatrix} l_{1} &amp; 0 &amp; \ldots &amp; 0 \\ 0 &amp; l_{2} &amp; \ldots &amp; 0\\ \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\ 0 &amp; 0 &amp; \ldots &amp; l_{B_r}\\ \end{pmatrix}^{-1} = \begin{pmatrix} \frac{1}{l_{1}} &amp; 0 &amp; \ldots &amp; 0 \\ 0 &amp; \frac{1}{l_{2}} &amp; \ldots &amp; 0\\ \vdots &amp; \vdots &amp; \ddots &amp;\vdots\\ 0 &amp; 0 &amp; \ldots &amp; \frac{1}{l_{B_{r}}}\\ \end{pmatrix}
</annotation></semantics></math></span></div><hr><p><strong>分块 <code>Softmax </code></strong>：</p><ol><li><p>对向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>B</mi></msup></mrow><annotation encoding="application/x-tex">X\in \mathbb{R}^{B} </annotation></semantics></math></span>
</span>， softmax 计算公式为：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo><mo>:</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>:</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mrow><mi>max</mi><mo>⁡</mo></mrow><mi>i</mi></munder><msub><mi>x</mi><mi>i</mi></msub></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>:</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">[</mo><msup><mi>e</mi><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mspace width="1em"/><mo>…</mo><mspace width="1em"/><msup><mi>e</mi><mrow><msub><mi>x</mi><mi>B</mi></msub><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">]</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>:</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    \mathrm {softmax}(X):&amp;= \frac{f(x)}{l(x)} \\ \\
    m(x): &amp;= \max_i x_i\\ \\
    f(x): &amp;=\big [e^{x_1-m(x)} \quad \dots \quad e^{x_B-m(x)}\big]\\ \\
    l(x): &amp;= \sum_{i} f(x)_i \\
    \end{align}
    </annotation></semantics></math></span></div></li><li><p>那么对 向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>X</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>B</mi></msup></mrow><annotation encoding="application/x-tex">X^{(1)}, X^{(2)} \in \mathbb{R}^{B}</annotation></semantics></math></span>
</span>， 可以将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mo stretchy="false">[</mo><msup><mi>X</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>X</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">]</mo><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>2</mn><mi>B</mi></mrow></msup></mrow><annotation encoding="application/x-tex">X = [X^{(1)}, X^{(2)}] \in \mathbb{R}^{2B}</annotation></semantics></math></span>
</span>的 <code>softmax</code> 计算拆解为：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mo>=</mo><mi>m</mi><mo stretchy="false">(</mo><mo stretchy="false">[</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo separator="true">,</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">]</mo><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>e</mi><mrow><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>e</mi><mrow><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>+</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></msup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>:</mo><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><msub><mo stretchy="false">)</mo><mi>i</mi></msub></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>+</mo><msup><mi>e</mi><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></msup><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
   \begin{align}
   \mathrm{softmax}(X) &amp;:= \frac{f(x)}{l(x)} \\ \\
   m(x) &amp;:=  m([x^{(1)}, x^{(2)}]) = \max \big(m(x^{(1)}), m(x^{(2)})) \\ \\
   f(x) &amp;:= \begin{bmatrix} 
   e^{x^{(1)} - m(x)} &amp; e^{x^{(2)} - m(x)} 
   \end{bmatrix} \\ 
   &amp;= \begin{bmatrix} 
   e^{m(x^{(1)}) - m(x) + x^{(1)} - m(x^{(1)})} &amp; e^{m(x^{(2)}) - m(x) + x^{(2)} - m(x^{(2)})}
   \end{bmatrix} \\ 
   &amp;= \begin{bmatrix} 
   e^{m(x^{(1)}) - m(x)} f(x^{(1)}) &amp; e^{m(x^{(2)}) - m(x)} f(x^{(2)}) 
   \end{bmatrix} \\ \\
   l(x) &amp;:= \sum_{i} f(x)_i \\ 
        &amp;= e^{m(x^{(1)}) - m(x)} l(x^{(1)}) + e^{m(x^{(2)}) - m(x)} l(x^{(2)})
   \end{align}
   </annotation></semantics></math></span></div></li></ol><hr><p><strong>Example1</strong></p><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x=[1,3,2,4]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x^{(1)}=[1,3]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">m(x^{(1)})=3</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f(x^{(1)})=[e^{-2},1]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l(x^{(1)})=(e^{-2}+1)</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><mrow><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo stretchy="false">[</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><mn>1</mn><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathrm{softmax} (x^{(1)}) = \frac{f(x^{(1)})}{l(x^{(1)})}=[\frac{e^{-2}}{e^{-2}+1}, \frac{1}{e^{-2}+1}]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo>=</mo><mo stretchy="false">[</mo><mn>2</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x^{(2)}=[2,4]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">m(x^{(2)})=4</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f(x^{(2)})=[e^{-2},1]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l(x^{(2)})=(e^{-2}+1)</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow><mrow><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo stretchy="false">[</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><mn>1</mn><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathrm{softmax} (x^{(2)}) = \frac{f(x^{(2)})}{l(x^{(2)})}=[\frac{e^{-2}}{e^{-2}+1}, \frac{1}{e^{-2}+1}]</annotation></semantics></math></span></span></p></li></ul><p>根据分块 softmax 的公式计算前两个块的结果：</p><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>m</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">m(x) = \max(m(x^{(1)}),m(x^{(2)})) = \max(3,4) = 4 </annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>4</mn></mrow></msup><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo separator="true">,</mo><msup><mi>e</mi><mrow><mn>4</mn><mo>−</mo><mn>4</mn></mrow></msup><mi>f</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo>=</mo><mo stretchy="false">[</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo separator="true">,</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo separator="true">,</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f(x) =[e^{3-4}f(x^{(1)}) , e^{4-4} f(x^{(2)})] =[e^{-3},e^{-1}, e^{-2}, 1]</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mn>3</mn><mo>−</mo><mn>4</mn></mrow></msup><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>+</mo><msup><mi>e</mi><mrow><mn>4</mn><mo>−</mo><mn>4</mn></mrow></msup><mi>l</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mrow><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></msup><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">(</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">l(x) =e^{3-4} l(x^{(1)}) + e^{4-4} l(x^{(2)})=(e^{-3}+e^{-2}+e^{-1}+1) </annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><mo stretchy="false">[</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo separator="true">,</mo><mfrac><mn>1</mn><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>3</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>2</mn></mrow></msup><mo>+</mo><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo>+</mo><mn>1</mn></mrow></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\mathrm{softmax} (x) = \frac{f(x)}{l(x)} = [\frac{e^{-3}}{e^{-3}+e^{-2}+e^{-1}+1}, \frac{e^{-1}}{e^{-3}+e^{-2}+e^{-1}+1}, \frac{e^{-2}}{e^{-3}+e^{-2}+e^{-1}+1}, \frac{1}{e^{-3}+e^{-2}+e^{-1}+1}]</annotation></semantics></math></span></span></p></li></ul><p>与直接计算
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{softmax} (x)</annotation></semantics></math></span>
</span>的值一致</p><p>从上面简单的例子可以发现：</p><ol><li>我们可以把一个很大的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span>
</span>拆分成长度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span>
</span>的块，</li><li>用上面的算法先计算第 1 块和第 2 块，然后合并其结果；接着计算第 3 块，合并前 3 块结果</li><li>如果我们定义空块
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mo stretchy="false">[</mo><mspace width="1em"/><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x=[\quad]</annotation></semantics></math></span>
</span>时
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mi>inf</mi><mo>⁡</mo></mrow><annotation encoding="application/x-tex">m(x)=-\inf</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mo stretchy="false">[</mo><mspace width="1em"/><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">f(x)=[\quad]</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">l(x)=0</annotation></semantics></math></span>
</span>，那么第一个块也可以看成它和空的合并，这样的话我们的代码的循环空从第一个块开始。</li></ol><hr><p><strong>Example2</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3>3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4>4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5>5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6>6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7>7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>torch</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>torch</span> <span class=kn>import</span> <span class=n>softmax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>s</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>v</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.6</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>,</span> <span class=mf>0.8</span><span class=p>,</span> <span class=mf>0.9</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p</span> <span class=o>=</span> <span class=n>softmax</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># tensor([0.2138, 0.2363, 0.2612, 0.2887])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>v</span><span class=p>))</span>  <span class=c1># tensor(0.7625)</span></span></span></code></pre></td></tr></table></div></div></div><ol><li><strong>计算第一个 block 的值</strong></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1>1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2>2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3>3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4>4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5>5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>s1</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>v1</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.6</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p1</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># tensor([0.4750, 0.5250])</span>
</span></span><span class=line><span class=cl><span class=n>output1</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>p1</span><span class=p>,</span> <span class=n>v1</span><span class=p>)</span>  <span class=c1># tensor(0.6525)</span>
</span></span><span class=line><span class=cl><span class=n>sum_exp1</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>s1</span><span class=p>))</span>  <span class=c1># tensor(2.3266)</span></span></span></code></pre></td></tr></table></div></div></div><p>同时我们将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0.1</mn><mo separator="true">,</mo><mn>0.2</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0.1, 0.2]</annotation></semantics></math></span>
</span>的 exponential summation (softmax 的分母)
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2.3266</mn></mrow><annotation encoding="application/x-tex">2.3266</annotation></semantics></math></span>
</span>存下来</p><ol start=2><li><strong>计算第二个 block 的值</strong></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>s2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.3</span><span class=p>,</span> <span class=mf>0.4</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>v2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>([</span><span class=mf>0.8</span><span class=p>,</span> <span class=mf>0.9</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>p2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span><span class=n>s2</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># tensor([0.4750, 0.5250])</span>
</span></span><span class=line><span class=cl><span class=n>output2</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>p2</span><span class=p>,</span> <span class=n>v2</span><span class=p>)</span>  <span class=c1># tensor(0.8525)</span>
</span></span><span class=line><span class=cl><span class=n>sum_exp2</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=n>s2</span><span class=p>))</span>  <span class=c1># tensor(2.8417)</span></span></span></code></pre></td></tr></table></div></div></div><p>并且得到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0.3</mn><mo separator="true">,</mo><mn>0.4</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0.3, 0.4]</annotation></semantics></math></span>
</span>的 exponential summation ( softmax 的分母)
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2.8417</mn></mrow><annotation encoding="application/x-tex">2.8417</annotation></semantics></math></span></span></p><ol start=3><li><strong>校准</strong></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>output</span> <span class=o>=</span> <span class=p>(</span><span class=n>output1</span> <span class=o>*</span> <span class=n>sum_exp1</span> <span class=o>+</span> <span class=n>output2</span> <span class=o>*</span> <span class=n>sum_exp2</span><span class=p>)</span> <span class=o>/</span> <span class=p>(</span><span class=n>sum_exp1</span> <span class=o>+</span> <span class=n>sum_exp2</span><span class=p>)</span>  <span class=c1># tensor(0.7625)</span></span></span></code></pre></td></tr></table></div></div></div><p>我们可以把每个 block 的 output 和 expoential summation 相乘来还原出还没经过 normalization 的值，并且再将两者的 expoential summation 相加作为新的 softmax 分母，也就是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0.6525</mn><mo>∗</mo><mn>2.3266</mn><mo>+</mo><mn>0.8525</mn><mo>∗</mo><mn>2.8417</mn><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mn>2.3266</mn><mo>+</mo><mn>2.8417</mn><mo stretchy="false">)</mo><mo>=</mo><mn>0.7625</mn></mrow><annotation encoding="application/x-tex">(0.6525*2.3266+0.8525*2.8417)/(2.3266+2.8417)= 0.7625</annotation></semantics></math></span></span></p><p>（实际会先减去 max value 来避免经过 exponential 后 overflow，这里为了简化就略过这个步骤了）</p><p>通过以上三个步骤发现，只需要额外多存下每个 sub block 的 exponential summation ，这使得我们可以从头到尾只将 sub-block 1 对应的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>从 HBM load 到 SRAM 一次便可以直接算出最后的 O，中间也完全不用再多存取任何东西。</p><p>尽管这样的方式不能让我们避免
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span>
</span>的时间复杂度 ( 因为我们需要 for loop 将每个
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>做内积)，但是这样切割成 sub-block 直接计算出结果，且 <strong>不用整个 row 一起存取</strong> 的方式可以让我们 <strong>将整个时间复杂度除以 M (sub-block 数量)</strong>，同时减少许多
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span>
</span>memory 存取的次数，可以达到非常显著的效果提升。</p><h4 id=recomputation-重计算 class=heading>Recomputation 重计算<a href=#recomputation-%e9%87%8d%e8%ae%a1%e7%ae%97 aria-labelledby=recomputation-重计算><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>为了后向传递计算梯度，前向计算时通常需要将某些中间结果写回到 <strong>HBM</strong> 中，这会产生额外的 HBM 读写次数，减慢运行时间。因此，Flash Attention 没有为后向传递保存很大的中间结果矩阵。</p><p>标准注意力实现中, 后向传递计算
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>的梯度时, 需要将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf S</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span>
</span>这两个
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">N \times N</annotation></semantics></math></span>
</span>的矩阵存入 <strong>HBM</strong>，并且在 backward 时再将他们两个从 <strong>HBM</strong> load 到 <strong>SRAM</strong>。</p><p>Flash attention 保存了两个统计量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">m</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf m(x)</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">l</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf l(x)</annotation></semantics></math></span>
</span>，后向传递时在 <strong>SRAM</strong> 上快速地重新计算 Attention, 通过分块的方式重新计算注意力矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf S</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span>
</span>。相比于标准注意力中, 从 HBM 中读取很大的中间注意力矩阵的方法, 重计算的方法要快得多。</p><hr><h3 id=io-complexity-of-flashattention class=heading>IO Complexity of FlashAttention<a href=#io-complexity-of-flashattention aria-labelledby=io-complexity-of-flashattention><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><blockquote class=blockquote><p><strong>【Theorem 2】</strong></p><p>假设序列长度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>，head 的维度为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span>
</span>，SRAM 的大小是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span>
</span>，并且我们假设
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>≤</mo><mi>M</mi><mo>≤</mo><mi>N</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">d\le M \le Nd</annotation></semantics></math></span>
</span>。标准的 Attention 算法需要
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd+N^2)</annotation></semantics></math></span>
</span>的 HBM 访问，而 FlashAttention 算法需要
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mfrac><mrow><msup><mi>N</mi><mn>2</mn></msup><msup><mi>d</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mi>M</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(\frac{N^2d^2)}{M})</annotation></semantics></math></span>
</span>的 HBM 访问。</p></blockquote><p>因为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span>
</span>：64~128，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi></mrow><annotation encoding="application/x-tex">M</annotation></semantics></math></span>
</span>：100KB， 所以
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>d</mi><mn>2</mn></msup><mo>≪</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">d^2 \ll M</annotation></semantics></math></span>
</span>， 所以 <code>FlashAttention </code>算法的复杂度远远小于标准 Attention 的复杂度</p><h4 id=标准-attention-实现的-io-情况 class=heading><strong>标准 Attention 实现的 IO 情况</strong><a href=#%e6%a0%87%e5%87%86-attention-%e5%ae%9e%e7%8e%b0%e7%9a%84-io-%e6%83%85%e5%86%b5 aria-labelledby=标准-attention-实现的-io-情况><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250311225451934.png width=75% alt></center><ol><li><p>从全局内存中读取矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times d} </annotation></semantics></math></span>
</span>，并将计算好的 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf S</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times N}</annotation></semantics></math></span>
</span></strong>再写入 <strong>HBM</strong></p><p>需要进行
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + N^2)</annotation></semantics></math></span>
</span>次 HBM 访问</p></li><li><p>从 <strong>HBM</strong> 中获取 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf S</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times N}</annotation></semantics></math></span>
</span></strong>，计算 Softmax 得到 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times N}</annotation></semantics></math></span>
</span></strong>，再写入 <strong>HBM</strong></p><p>需要进行
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span>
</span>次 HBM 访问</p></li><li><p>从 <strong>HBM</strong> 中读取 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>N</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times N}</annotation></semantics></math></span>
</span></strong>和 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times d}</annotation></semantics></math></span>
</span></strong>，计算得到 <strong>矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\in \mathbb{R}^{N\times d}</annotation></semantics></math></span>
</span></strong>, 将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span>写入 <strong>HBM</strong>。</p><p>需要进行
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + N^2)</annotation></semantics></math></span>
</span>次 HBM 访问</p></li></ol><p><strong>因此，标准 Attention 算法的总 HBM 访问次数为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span>
</span>（通常情况下
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>≫</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">N \gg d</annotation></semantics></math></span>
</span>(e.g., GPT2,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑁</mi><mo>=</mo><mn>1024</mn></mrow><annotation encoding="application/x-tex">𝑁 = 1024 </annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝑑</mi><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">𝑑 = 64</annotation></semantics></math></span>
</span>)）。</strong></p><blockquote class=blockquote><p><strong>过程中存储
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">P</mi></mrow><annotation encoding="application/x-tex">\mathbf P</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">S</mi></mrow><annotation encoding="application/x-tex">\mathbf S</annotation></semantics></math></span>
</span>的理由</strong>：</p><ol><li>需要这些 intermediate activations 来帮助 backward 的时候通过反向传播计算 gradients，这也使得我们很难将多个 operations fuse 成一个 operation。</li><li>由于 SRAM 本身不够大，而 softmax 这种需要计算 sum 的 operation，需要整个 row 的元素都到齐后才可以计算，使得我们没有办法应用一些分治的算法，更使得我们没有办法把所有运算一口气在 SRAM 当中计算完</li></ol></blockquote><h4 id=flashattention-算法的-io-情况 class=heading>FlashAttention 算法的 IO 情况<a href=#flashattention-%e7%ae%97%e6%b3%95%e7%9a%84-io-%e6%83%85%e5%86%b5 aria-labelledby=flashattention-算法的-io-情况><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ol><li><p>外层循环遍历
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span>
</span>次，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">K</mi></mrow><annotation encoding="application/x-tex">\mathbf K</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">V</mi></mrow><annotation encoding="application/x-tex">\mathbf V</annotation></semantics></math></span>
</span>从 HBM 加载到 SRAM 一次，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Q</mi></mrow><annotation encoding="application/x-tex">\mathbf Q</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">O</mi></mrow><annotation encoding="application/x-tex">\mathbf O</annotation></semantics></math></span>
</span>需要遍历
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span>
</span>次。每次都完整的把它们加载一遍。</p><p>需要进行
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><mo>+</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(Nd + NdT_c) = O(NdT_c)</annotation></semantics></math></span>
</span>次 HBM 访问</p></li><li><p>需要将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">K</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf K_j</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">V</mi><mi>j</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf V_j \in \mathbb{R}^{B_c\times d}</annotation></semantics></math></span>
</span>放到 <strong>SRAM</strong> 里，因此</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>B</mi><mi>c</mi></msub><mo>×</mo><mi>d</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo><mo>⇔</mo><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
   \begin{align}
   B_c \times d = O(M) \Leftrightarrow B_c = O(\frac{M}{d})
   \end{align}
   </annotation></semantics></math></span></div></li><li><p>需要将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">Q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf Q_i</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">O</mi><mi>i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf O_i \in \mathbb{R}^{B_r\times d}</annotation></semantics></math></span>
</span>放到 <strong>SRAM</strong> 里，因此</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><mi>d</mi><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo><mo>⇔</mo><msub><mi>B</mi><mi>r</mi></msub><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    B_r \times d = O(M) \Leftrightarrow B_r = O(\frac{M}{d})
    \end{align}
    </annotation></semantics></math></span></div></li><li><p>需要将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">S</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>∈</mo><msup><mi>R</mi><mrow><msub><mi>B</mi><mi>r</mi></msub><mo>×</mo><msub><mi>B</mi><mi>c</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf S_{ij} \in R^{B_r \times B_c}</annotation></semantics></math></span>
</span>放到 <strong>SRAM</strong> 里，因此</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>B</mi><mi>r</mi></msub><msub><mi>B</mi><mi>c</mi></msub><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>M</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    B_rB_c = O(M)
    \end{align}
    </annotation></semantics></math></span></div></li><li><p>因此设置：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>B</mi><mi>c</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>B</mi><mi>r</mi></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>O</mi><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">(</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo separator="true">,</mo><mfrac><mi>M</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">)</mo><mo>=</mo><mi>O</mi><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">(</mo><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><mfrac><mi>M</mi><mi>d</mi></mfrac><mo separator="true">,</mo><mi>d</mi><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="2.4em" maxsize="2.4em">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    B_c &amp;= O(\frac{M}{d}), \\
    B_r &amp;= O\bigg(\min(\frac{M}{d}, \frac{M}{B_c})\bigg)= O\bigg(\min(\frac{M}{d} , d)\bigg)
    \end{align}
    </annotation></semantics></math></span></div><p>因此有：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msub><mi>T</mi><mi>c</mi></msub><mo>=</mo><mfrac><mi>N</mi><msub><mi>B</mi><mi>c</mi></msub></mfrac><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>N</mi><mi>d</mi></mrow><mi>M</mi></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    T_c =\frac{N}{B_c}= O(\frac{Nd}{M})
    \end{align}
    </annotation></semantics></math></span></div><p>所以：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>d</mi><msub><mi>T</mi><mi>c</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mfrac><mrow><msup><mi>N</mi><mn>2</mn></msup><msup><mi>d</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><mi>M</mi></mfrac><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(NdT_c)=O(\frac{N^2d^2)}{M})</annotation></semantics></math></span></span></p></li></ol><h1 id=reference class=heading>Reference<a href=#reference aria-labelledby=reference><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h1><p><a href=https://arxiv.org/abs/2205.14135 class=markdown-link>FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness</a></p></div><div class="row row-cols-2 mt-5 mb-3"><div class=col><a class=next href=/blogs/lsh/><svg class="svg-inline--fa fas fa-arrow-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-arrow-left"/></svg>&nbsp;LSH</a></div><div class="col text-end"><a class=previous href=/blogs/pythontools/>PythonTools&nbsp;<svg class="svg-inline--fa fas fa-arrow-right" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-arrow-right"/></svg></a></div></div><a href=# id=back-to-top class=back-to-top><span>▲</span>
</a><a href=# id=scroll-to-bottom class=back-to-top><span>▼</span>
</a><script>document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("back-to-top"),t=document.getElementById("scroll-to-bottom");e.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),t.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})})})</script></div><div class="col col-md-3 col-lg-2 d-none d-md-block pt-5"><div class="toc toc-sidebar mb-5 my-md-0 mb-lg-5 p-3 text-body-secondary sticky-top"><strong class="d-block h6 my-2 pt-4">On this page:</strong><nav class=toc><a class="toc-item toc-level-1" href=/blogs/flashattention/#background>Background </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#structure-of-gpu-memory>Structure of GPU Memory </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#attention-的计算复杂度>Attention 的计算复杂度 </a><a class="toc-item toc-level-1" href=/blogs/flashattention/#flashattention>FlashAttention </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#tiling-and-recomputation>Tiling and Recomputation </a><a class="toc-item toc-level-2" href=/blogs/flashattention/#io-complexity-of-flashattention>IO Complexity of FlashAttention</a></nav></div></div></div></div><footer class="container-fluid footer text-center p-3"><div class="container-xxl text-center"><small>Copyright © 2025 EV's Blog All rights reserved.
|
Powered by
<a href=https://gethinode.com class="link-bg-footer markdown-link">Hinode</a>.</small></div></footer></div><div id=toast-container class="toast-container position-fixed bottom-0 end-0 p-3"><div id=toast-copied-code-message class=toast role=alert aria-live=assertive aria-atomic=true><div class=toast-header><strong class=me-auto>EV's Blog</strong>
<button type=button class=btn-close data-bs-dismiss=toast aria-label=Close></button></div><div class=toast-body>Code copied to clipboard</div></div></div><svg xmlns:xlink="http://www.w3.org/1999/xlink" display="none"><symbol id="fas-ellipsis"><path d="M8 256a56 56 0 11112 0A56 56 0 118 256zm160 0a56 56 0 11112 0 56 56 0 11-112 0zm216-56a56 56 0 110 112 56 56 0 110-112z"/></symbol><symbol id="fas-sun"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 11192 0 96 96 0 11-192 0zm224 0a128 128 0 10-256 0 128 128 0 10256 0z"/></symbol><symbol id="fas-moon"><path d="M223.5 32C1e2 32 0 132.3.0 256S1e2 480 223.5 480c60.6.0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9.0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></symbol><symbol id="fas-angle-left"><path d="M41.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol><symbol id="fas-sort"><path d="M137.4 41.4c12.5-12.5 32.8-12.5 45.3.0l128 128c9.2 9.2 11.9 22.9 6.9 34.9S301 224.1 288 224.1L32 224c-12.9.0-24.6-7.8-29.6-19.8s-2.2-25.7 6.9-34.9l128-128zm0 429.3-128-128c-9.2-9.2-11.9-22.9-6.9-34.9S19.1 288 32.1 288h256c12.9.0 24.6 7.8 29.6 19.8s2.2 25.7-6.9 34.9l-128 128c-12.5 12.5-32.8 12.5-45.3.0z"/></symbol><symbol id="fas-arrow-left"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.2 288H416c17.7.0 32-14.3 32-32s-14.3-32-32-32H109.3L214.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol><symbol id="fas-arrow-right"><path d="M438.6 278.6c12.5-12.5 12.5-32.8.0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3L338.8 224H32c-17.7.0-32 14.3-32 32s14.3 32 32 32h306.7L233.4 393.4c-12.5 12.5-12.5 32.8.0 45.3s32.8 12.5 45.3.0l160-160z"/></symbol></svg>
<script src=/js/core.bundle-analytics.en.min.ceb6a67c169a28031391976dac91e1e2f460951862201b6249516a55d0fd6109.js data-category=analytics integrity="sha256-zramfBaaKAMTkZdtrJHh4vRglRhiIBtiSVFqVdD9YQk=" crossorigin=anonymous async></script><script src=/js/core.bundle.en.min.61d422f277782351975f4db20ef2a166f8d70933660f72b11ad8399e5cd40497.js integrity="sha256-YdQi8nd4I1GXX02yDvKhZvjXCTNmD3KxGtg5nlzUBJc=" crossorigin=anonymous async></script></body></html>
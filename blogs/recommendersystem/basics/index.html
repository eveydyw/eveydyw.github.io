<!doctype html><html lang=en class=no-js><head><script src=/js/critical.bundle.min.85a7f5f23dc031d38877ecdb71b00d49e8a62c54f1ba98e75a734706ea09f30a.js integrity="sha256-haf18j3AMdOId+zbcbANSeimLFTxupjnWnNHBuoJ8wo=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.143.1"><meta name=theme content="Hinode 0.29.3"><link rel=stylesheet href="/css/main.min.2d9f08a384019794d7cb9e682556930966cd9db5fc51ca90d439a9f5b1032e59.css" integrity="sha256-LZ8Io4QBl5TXy55oJVaTCWbNnbX8UcqQ1Dmp9bEDLlk=" crossorigin=anonymous><link rel=preload href=/fonts/inter-v12-latin-regular.woff2 as=font type=font/woff2 crossorigin><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>EV's Blog - RecommenderSystem-1-概要</title>
<meta name=description content="【笔记】wangshusen-推荐系统：基本概念"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="RecommenderSystem-1-概要"><meta property="og:description" content="【笔记】wangshusen-推荐系统：基本概念"><meta property="og:url" content="https://eveydyw.github.io/blogs/recommendersystem/basics/"><meta property="og:site_name" content="EV's Blog"><meta property="article:published_time" content="2024-09-14T18:51:07+08:00"><meta property="article:modified_time" content="2024-09-14T18:51:07+08:00"><meta property="og:image" content="https://eveydyw.github.io/img/logo1280x640.png"><meta property="og:image:alt" content="RecommenderSystem-1-概要"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="RecommenderSystem-1-概要"><meta name=twitter:description content="【笔记】wangshusen-推荐系统：基本概念"><meta name=twitter:image content="https://eveydyw.github.io/img/logo1280x640.png"><meta name=twitter:image:alt content="RecommenderSystem-1-概要"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://eveydyw.github.io/#/schema/organization/1","name":"Hinode","url":"https://eveydyw.github.io/","sameAs":[null,"https://github.com/gethinode/hinode"],"logo":{"@type":"ImageObject","@id":"https://eveydyw.github.io/#/schema/image/1","url":"https://eveydyw.github.io/img/logo512x512.png","width":512,"height":512,"caption":"Hinode"},"image":{"@id":"https://eveydyw.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://eveydyw.github.io/#/schema/website/1","url":"https://eveydyw.github.io/","name":"EV\u0027s Blog","description":"Hinode is a clean documentation and blog theme for your Hugo site based on Bootstrap 5.","publisher":{"@id":"https://eveydyw.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/","url":"https://eveydyw.github.io/blogs/recommendersystem/basics/","name":"RecommenderSystem-1-概要","description":"【笔记】wangshusen-推荐系统：基本概念","isPartOf":{"@id":"https://eveydyw.github.io/#/schema/website/1"},"about":{"@id":"https://eveydyw.github.io/#/schema/organization/1"},"datePublished":"2024-09-14T18:51:07CET","dateModified":"2024-09-14T18:51:07CET","breadcrumb":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eveydyw.github.io/blogs/recommendersystem/basics/"]}]},{"@type":"BreadcrumbList","@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/","url":"https://eveydyw.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/","url":"https://eveydyw.github.io/blogs/","name":"Blogs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/recommendersystem/","url":"https://eveydyw.github.io/blogs/recommendersystem/","name":"Recommendersystem"}},{"@type":"ListItem","position":4,"item":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://eveydyw.github.io/blogs/recommendersystem/basics/#/schema/image/2","url":"https://eveydyw.github.io/img/logo1280x640.png","contentUrl":"https://eveydyw.github.io/img/logo1280x640.png","caption":"RecommenderSystem-1-概要"}]}]}</script><link rel=icon type=image/png sizes=16x16 href=/img/my_logo_hu_10729e67805acfd8.png><link rel=icon type=image/png sizes=32x32 href=/img/my_logo_hu_f267cd4735c3fb50.png><link rel=icon type=image/png sizes=48x48 href=/img/my_logo_hu_bc348718a5ba4099.png><link rel=apple-touch-icon sizes=180x180 href=/img/my_logo_hu_a8f52fe79483cdab.png><script>MathJax={loader:{load:["[tex]/html","[tex]/ams","[tex]/amscd"]},tex:{inlineMath:[["\\(","\\)"],["$","$"]],displayMath:[["\\[","\\]"],["$$","$$"]],processEscapes:!0,packages:["base","ams","amscd"],tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],renderActions:{addMenu:[0,"",""],checkLoading:[0,"",""]}},chtml:{scale:1,displayAlign:"center",displayIndent:"0em",lineWidth:"container"},svg:{fontCache:"global"}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js></script></head><body><div class="d-flex flex-column min-vh-100"><div class="d-flex flex-column"><div class="container-fluid fixed-top p-0"><nav class="navbar p-4 bg-body navbar-fixed-top navbar-expand-md"><div class="container-xxl p-0"><div class="d-flex navbar-container justify-content-center"><div class="d-flex align-items-center"><button class="navbar-toggler collapsed p-0 mx-auto invisible fw-30" type=button><svg class="svg-inline--fa fas fa-ellipsis fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-ellipsis"/></svg></button></div><div class=mx-auto><a class=navbar-brand href=/ aria-label=Home><img src=/img/my_logo.svg alt="EV's Blog logo" height=30 width=30></a></div><div class="d-flex align-items-center"><button class="navbar-toggler main-nav-toggler collapsed p-0" type=button data-bs-toggle=collapse data-bs-target=#navbar-0-collapse aria-controls=navbar-0 aria-expanded=false aria-label="Toggle main navigation">
<span class="toggler-icon top-bar emphasis"></span>
<span class="toggler-icon middle-bar emphasis"></span>
<span class="toggler-icon bottom-bar emphasis"></span></button></div></div><div class="navbar-collapse collapse" id=navbar-0-collapse><div class="d-flex flex-fill ms-md-3 mt-4 mt-md-0"><form class="search flex-fill position-relative me-auto"><input class="search-input form-control is-search" type=search placeholder="Search this site" aria-label="Search this site" autocomplete=off name=search-input><div class="search-suggestions shadow bg-body rounded d-none" data-no-results="No results for"></div></form></div><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link data-nav=main data-nav-main=home href=/><span>Home</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=blogs href=/blogs/><span>Blogs</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=tags href=/tags><span>Tags</span>&nbsp;</a></li><li class="d-flex mode-switch align-items-center" id=navbar-mode><input type=checkbox class="checkbox navbar-mode-selector" id=navbar-mode-checkbox aria-label="Toggle theme">
<label class=label for=navbar-mode-checkbox><svg class="svg-inline--fa fas fa-sun fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 512 512"><use href="#fas-sun"/></svg><svg class="svg-inline--fa fas fa-moon fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 384 512"><use href="#fas-moon"/></svg><div class=ball></div></label></li></ul></div></div></nav></div><div class=main-content></div></div><div class="container-xxl flex-fill p-4 px-xxl-0"><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3"><div class="col col-lg-2 d-none d-lg-block sidebar-overflow sticky-top pt-5"></div><div class="col-12 col-md-9 col-lg-8 mb-5 p-4"><nav aria-label=breadcrumb class=d-sm-none><ol class=breadcrumb><li class=breadcrumb-item><a href=/blogs/recommendersystem/><svg class="svg-inline--fa fas fa-angle-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-angle-left"/></svg>&nbsp;&nbsp;RecommenderSystem</a></li></ol></nav><nav aria-label=breadcrumb class="d-none d-sm-block"><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/blogs/>Blogs</a></li><li class=breadcrumb-item><a href=/blogs/recommendersystem/>RecommenderSystem</a></li><li class="breadcrumb-item active" aria-current=page>RecommenderSystem-1-概要</li></ol></nav><p class="display-4 mt-5">RecommenderSystem-1-概要</p><small class="text-body-secondary text-uppercase">Posted on September 14, 2024
&bull;
3&nbsp;min read &bull;
530&nbsp;words</small><p class="lead mb-5 mt-3">【笔记】wangshusen-推荐系统：基本概念</p><div class="d-md-none pb-5"><div class="d-grid gap-2 mx-auto"><a aria-label="On this page" href=#toc-collapse class="btn btn-outline-secondary position-relative toc-button" data-bs-toggle=collapse aria-expanded=false aria-controls=toc-collapse role=button><span class="d-flex justify-content-between"><span class=my-auto>On this page</span><span class="align-self-center ps-1"><svg class="svg-inline--fa fas fa-sort" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-sort"/></svg></span></span></a></div><div class="collapse border bg-body-tertiary rounded p-1 navbar-nav-scroll" id=toc-collapse><small><div class="toc toc-panel text-body p-2"><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统的基本概念>推荐系统的基本概念 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#转化流程>转化流程 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#消费指标>消费指标 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#北极星指标>北极星指标 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#实验流程>实验流程 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统链路>推荐系统链路 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#召回通道>召回通道 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#排序>排序 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#重排>重排 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#总结>总结 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统-ab-测试>推荐系统 A/B 测试 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#ab-测试的目的>A/B 测试的目的 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#随机分桶>随机分桶 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#分层实验>分层实验 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#holdout-机制>Holdout 机制 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#实验推全--反转实验>实验推全 & 反转实验 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#总结-1>总结</a></div></small></div></div><div class=content><h2 id=推荐系统的基本概念 class=heading>推荐系统的基本概念<a href=#%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5 aria-labelledby=推荐系统的基本概念><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=转化流程 class=heading>转化流程<a href=#%e8%bd%ac%e5%8c%96%e6%b5%81%e7%a8%8b aria-labelledby=转化流程><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401204900066.png width=50% alt></center><h3 id=消费指标 class=heading>消费指标<a href=#%e6%b6%88%e8%b4%b9%e6%8c%87%e6%a0%87 aria-labelledby=消费指标><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ul><li><p><strong>点击率</strong> = 点击次数/曝光次数</p><ul><li><p>点击率越高就说明推荐越精准，给用户展示了他感兴趣的内容。</p></li><li><p>不能把点击率作为唯一的优化目标，否则骗点击的标题就会泛滥。</p></li></ul></li><li><p><strong>点赞率</strong> = 点赞次数/点击次数</p></li><li><p><strong>收藏率</strong> = 收藏次数/点击次数</p></li><li><p><strong>转发率</strong> = 转发次数/点击次数</p></li><li><p><strong>阅读完成率</strong> = 滑动到底次数/点击次数
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">\times f</annotation></semantics></math></span>
</span>(笔记长度)</p><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mo>⋅</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(\cdot)</annotation></semantics></math></span>
</span>为归一化函数：公平对待长笔记 （笔记越长，完成阅读的比例越低）</li></ul></li></ul><p>这些短期消费指标都是有意义的，但他们 <strong>不是衡量推荐系统好坏的根本指标</strong>，一味追求短期消费指标是不对的。</p><p>如果推荐算法只看用户短期兴趣，推很多用户最近感兴趣的内容，会让这些消费指标上涨，但这样会竭泽而渔，用户很快会失去兴趣，不再活跃。反过来，如果把多样性做好，尝试一些用户没看过的话题，那么点击率不一定上涨，但是会有利于提高用户粘性，留住用户，让用户更活跃。</p><h3 id=北极星指标 class=heading>北极星指标<a href=#%e5%8c%97%e6%9e%81%e6%98%9f%e6%8c%87%e6%a0%87 aria-labelledby=北极星指标><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>北极星指标</strong> 是衡量推荐系统好坏的 <strong>根本标准</strong>。通常来说，点击率跟时长、阅读数量的涨跌是一致的，万一有冲突，要以北极星指标为准。</p><ul><li><p><strong>用户规模</strong>：</p><ul><li><p>日活用户数（<code>DAU</code>）</p></li><li><p>月活用户数(<code>MAU</code>)</p></li></ul></li><li><p><strong>消费：</strong></p><ul><li><p>人均使用推荐的时长</p></li><li><p>人均阅读笔记的数量</p></li></ul></li><li><p><strong>发布：</strong></p><ul><li><p>发布渗透率</p></li><li><p>人均发布量</p></li></ul><p>激励发布通常是由 <strong>冷启动</strong> 来负责</p></li></ul><h3 id=实验流程 class=heading>实验流程<a href=#%e5%ae%9e%e9%aa%8c%e6%b5%81%e7%a8%8b aria-labelledby=实验流程><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401205205561.png width=50% alt></center><ol><li><p><strong>离线实验</strong></p><p>用收集的历史数据做训练和测试。做离线实验不需要把算法部署到产品中，没有跟用户实际交互，因此离线实验很容易做，不需要占用线上流量，也不会对系统和用户产生负面影响。</p><p>有很多评价离线实验的指标，离线实验的结果有参考价值，能大致反映出算法的好坏，但是离线实验并没有线上实验可靠，想最终判断算法的好坏还是需要做线上实验。</p></li><li><p><strong>小流量 A/B 测试</strong></p><p>北极星指标都是线上指标，只能通过线上实验获得，做离线实验无法得到这些指标。</p><p>具体做法是开小流量 A/B 测试，把用户随机分为实验组和对照组，实验组用新策略，对照组用旧策。对比两者的业务指标，判断新策略是否会显著优于旧策略。如果新策略显著优于旧策略，可以加大流量，最终推全。</p></li><li><p><strong>全流量上线</strong></p></li></ol><h2 id=推荐系统链路 class=heading>推荐系统链路<a href=#%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f%e9%93%be%e8%b7%af aria-labelledby=推荐系统链路><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401205401738.png width=55% alt></center><ol><li><p><strong>召回</strong>：从物品的数据库中快速取回一些物品。</p><p>比如小红书有上一篇笔记，当用户刷新小红书的时候，系统会同时调用几十条召回通道，每条召回通道取回几十到几百篇笔记一共几千篇笔记。</p></li><li><p><strong>粗排</strong>：</p><p>做完召回之后，要从几千篇笔记中选出用户最感兴趣的。用规模比较小的机器学习模型给几千篇笔记逐一打分。按照分数做排序和阶段，保留分数最高的几百篇笔记。</p></li><li><p><strong>精排</strong>：</p><p>用大规模的深度神经网络给几百篇笔记逐一打分，精排的分数反映出用户对笔记的兴趣。</p><p>在精排之后可以做截断，小红书的精排不做截断，所有几百篇笔记都带着精排分数进入重排。</p></li><li><p><strong>重排</strong>：
根据精排分数和多样性分数做随机抽样得到几十篇笔记，然后把相似内容打散，并且插入广告和运营内容。</p></li></ol><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401210100899.png width=65% alt></center><h3 id=召回通道 class=heading>召回通道<a href=#%e5%8f%ac%e5%9b%9e%e9%80%9a%e9%81%93 aria-labelledby=召回通道><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>召回通道</strong>：协同过滤、双塔模型、关注的作者等等。</p><p>小红书的推荐系统有几十条召回通道，每条召回通道取回几十到几百篇笔记，这些召回通道一共会返回几千篇笔记。然后推荐系统会融合这些笔记，并且做去重和过滤。过滤指排除掉用户不喜欢的作者，不喜欢的笔记，不喜欢的话题。</p><h3 id=排序 class=heading>排序<a href=#%e6%8e%92%e5%ba%8f aria-labelledby=排序><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>排序用机器学习模型预估用户对笔记的兴趣，保留分数最高的笔记。</p><p>如果直接用一个大规模的神经网络，逐一对几千篇笔记打分，花费的代价会很大。为了解决计算量的问题，通常把排序分为 <strong>粗排</strong> 和 <strong>精排</strong> 两步。</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">[</mo><mtext>几千</mtext><mo stretchy="false">]</mo><mo>→</mo><mtext>粗排</mtext><mo>→</mo><mo stretchy="false">[</mo><mtext>几百</mtext><mo stretchy="false">]</mo><mo>→</mo><mtext>精排</mtext><mo>→</mo><mo stretchy="false">[</mo><mtext>几百</mtext><mo stretchy="false">]</mo><mo>→</mo><mtext>重排</mtext><mo>→</mo><mo stretchy="false">[</mo><mtext>几十</mtext><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">
 [\text{几千}] \rightarrow  \text{粗排} \rightarrow [ \text{几百}] \rightarrow \text{精排} \rightarrow [ \text{几百} ] \rightarrow \text{重排} \rightarrow [\text{几十}]
</annotation></semantics></math></span></div><ul><li><p><strong>粗排</strong> 用比较简单的模型快速给 <strong>几千篇</strong> 笔记打分，保留分数最高的几百篇笔记</p></li><li><p><strong>精排</strong> 用一个较大的神经网络给 <strong>几百篇</strong> 笔记打分。模型比粗排模型大很多，用的特征也更多。所以精排模型打的分数更可靠。</p><p>先用粗排做筛选，然后才用精排可以比较好的 <strong>平衡计算量和准确性</strong>。</p><p>做完粗排和精排得到几百篇笔记，每篇笔记有一个分数，表示用户对笔记的兴趣有多高。</p></li><li><p><strong>重排</strong> 主要是考虑多样性，要根据多样性做随机抽样，从几百篇笔记中选出几十篇，然后还要用规则把内容相似的笔记打散。</p><p><strong>重排的结果就是最终展示给用户的物品。</strong></p></li></ul><hr><p><strong>粗排和精排的区别</strong>：</p><p>精排模型更大，用的特征更多。</p><hr><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401210551329.png width=50% alt></center><p><strong>模型的输入</strong>：用户特征、物品的特征、统计特征。</p><p><strong>将特征输入神经网络</strong> 得到点击率、点赞率、收藏率、转发率。这些数值都是神经网络对用户行为的预估，数值越大说明用户对笔记越感兴趣。</p><p>把 <strong>多个预估值做融合</strong>，得到最终的分数（比如求加权和）。这个分数决定了笔记会不会被展示给用户，以及笔记展示的位置是靠前还是靠后。</p><p>这只是对一篇笔记的打分，粗排要对几千篇笔记打分，精排要对几百篇笔记打分。每篇笔记都有多个预估分数融合成一个分数，作为给这篇笔记排序的依据。</p><h3 id=重排 class=heading>重排<a href=#%e9%87%8d%e6%8e%92 aria-labelledby=重排><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ul><li><p><strong>重排最重要的功能是多样性抽样</strong> （<code>MMR</code>、<code>DPP</code>），从几百篇中选出几十篇。</p><p><strong>抽样依据</strong>：</p><ol><li>精排分数的大小。</li><li>多样性。</li></ol></li><li><p><strong>用规则打散相似内容</strong>。（不能把内容过于相似的笔记排在相邻的位置上）</p><p>【例】：根据精排得到的分数排前五的笔记全都是 NBA 的内容，这样就不太合适。即使用户是个篮球迷，他也未必希望看到同质化的内容。如果排第一的是 NBA 的笔记，那么接下来几个位置就不能放 NBA 的内容。<strong>相似的笔记会往后挪</strong>。</p></li><li><p><strong>插入广告、运营推广内容，根据生态要求调整排序</strong>。</p></li></ul><h3 id=总结 class=heading>总结<a href=#%e6%80%bb%e7%bb%93 aria-labelledby=总结><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ul><li><p><strong>召回</strong>：用多条通道，取回几千篇笔记。</p></li><li><p><strong>粗排</strong>：用小规模神经网络，给几千篇笔记打分，选出分数最高的几百篇 。（用一些规则保证进入精排的笔记具有多样性）</p></li><li><p><strong>精排</strong>：用大规模神经网络，给几百篇笔记打分。 （打完分之后不需要做排序和截断）</p></li><li><p><strong>重排</strong>：做多样性抽样、规则打散、插入广告和运营笔记。</p></li></ul><p>当候选笔记只有几百篇的时候，才能用大规模的神经网络做精排和用 <code>DPP</code> 这样的方法做多样性抽样。</p><h2 id=推荐系统-ab-测试 class=heading>推荐系统 A/B 测试<a href=#%e6%8e%a8%e8%8d%90%e7%b3%bb%e7%bb%9f-ab-%e6%b5%8b%e8%af%95 aria-labelledby=推荐系统-ab-测试><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=ab-测试的目的 class=heading>A/B 测试的目的<a href=#ab-%e6%b5%8b%e8%af%95%e7%9a%84%e7%9b%ae%e7%9a%84 aria-labelledby=ab-测试的目的><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>【例】</strong></p><p>召回团队实现了一种图神经网络 <code>GNN</code> 的召回通道，离线实验的结果正向。但是离线实验的指标有提升，未必意味着线上实验也会有收益。</p><p>做完离线实验，下一步是让 <code>GNN</code> 召回通道上线, 做 <strong>小流量的 A/B 测试</strong>，考察新的召回通道对线上指标的影响。</p><p>A/B 测试还可以帮助我们选择最优的参数。比如 <code>GNN</code> 神经网络的深度取值
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∈</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">\in 1, 2, 3</annotation></semantics></math></span>
</span>，不同的参数会有不同的效果，可以用 A/B 测试选取最优参数。</p><h3 id=随机分桶 class=heading>随机分桶<a href=#%e9%9a%8f%e6%9c%ba%e5%88%86%e6%a1%b6 aria-labelledby=随机分桶><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>分
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">b=10</annotation></semantics></math></span>
</span>个桶，每个桶中有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户。如果用户的数量足够大，那么每个桶的 <code>DAU</code>、留存、点击率等指标都是相等的。</p><p>首先用哈希函数把用户 ID 映射成某个区间内的整数，然后把这些整数均匀随机分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span>
</span>个桶，每个桶中有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>n</mi><mi>b</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{n}{b}</annotation></semantics></math></span>
</span>位用户。</p><p>考察 <code>GNN</code> 参数对业务指标的影响。</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:1rem" src=pics/image-20250401211645795.png width=50% alt></center><ul><li><p>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>号筒作为三个实验组，但是 <code>GNN</code> 的参数不一样。三个桶的神经网络深度分别是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>层，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>层，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>层。</p></li><li><p>用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>号同作为对照组。</p></li><li><p>如果一个用户落在了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>号桶，那么给他做推荐的时候会用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>号桶的策略，使用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>层的 <code>GNN</code> 神经网络做召回。
如果另一个用户落在了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>号筒，那么给他做推荐的时候，就不要用 <code>GNN</code> 做召回。</p></li><li><p>分别计算每个桶的业务指标，比如 <code>DAU</code>、人均使用推荐的时长、点击率等等</p></li><li><p>如果某个实验组的指标显著优于对照组，则说明策略有效，值得推全。<strong>推全</strong> 指把流量扩大到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">100\%</annotation></semantics></math></span>
</span>，给所有用户都使用该策略。</p></li></ul><h3 id=分层实验 class=heading>分层实验<a href=#%e5%88%86%e5%b1%82%e5%ae%9e%e9%aa%8c aria-labelledby=分层实验><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>分层实验</strong> 的 <strong>目标</strong>：<strong>解决流量不够用的问题。</strong></p><ul><li><p>信息流产品的公司有很多部门和团队，大家都需要做 A/B 测试。</p><ul><li>推荐系统（召回、粗排丶精排、重排)</li><li>用户界面</li><li>广告</li></ul></li><li><p>如果把用户随机分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>组，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>组做对照，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span>
</span>组做实验，那么线上只能同时做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span>
</span>组实验，无法满足产品迭代的需求。</p></li></ul><hr><p><strong>解决方案</strong> 为 <strong>分层实验</strong>：</p><p><strong>分层实验</strong>：<strong>把实验分成很多层</strong>：召回、粗排、精排、重排、用户界面、广告（例如 <code>GNN</code> 召回通道属于召回层。）</p><ul><li><p><strong>同层互斥</strong>：<code>GNN</code> 实验占了 <strong>召回层</strong> 的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个桶，其他 <strong>召回实验</strong> 只能用剩余的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span>
</span>个桶</p><p><strong>同层互斥的目的</strong> 是避免一个用户同时被两个召回实验影响。假如两个实验相互干扰，实验结果会变得不可控。</p></li><li><p><strong>不同层正交</strong>：每一层独立随机对用户做分桶。每一层都可以独立用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">100\%</annotation></semantics></math></span>
</span>的用户做实验。</p></li></ul><p><strong>【例】</strong></p><p>召回和粗排的用户是独立随机划分的，召回的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
</span>号桶跟促排的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span>
</span>号桶交集很小。</p><ul><li><p>召回层把用户分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>个桶：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>U</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>U</mi><mn>10</mn></msub></mrow><annotation encoding="application/x-tex">U_1,U_2,\cdots,U_{10}</annotation></semantics></math></span></span></p></li><li><p>精排层把用户分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>个桶：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>V</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msub><mi>V</mi><mn>10</mn></msub></mrow><annotation encoding="application/x-tex">V_1,V_2,\cdots,V_{10}</annotation></semantics></math></span>
</span>。</p></li><li><p>设系统共有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个用户，那么
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><msub><mi>U</mi><mi>i</mi></msub><mo stretchy="false">∣</mo><mo>=</mo><mo stretchy="false">∣</mo><msub><mi>V</mi><mi>j</mi></msub><mo stretchy="false">∣</mo><mo>=</mo><mfrac><mi>n</mi><mn>10</mn></mfrac></mrow><annotation encoding="application/x-tex">\lvert {U_i}\rvert=\lvert{V_j} \rvert=\frac{n}{10}</annotation></semantics></math></span>
</span>。</p></li><li><p>召回桶
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">U_i</annotation></semantics></math></span>
</span>和召回桶
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">U_j</annotation></semantics></math></span>
</span>交集为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>i</mi></msub><mo>∩</mo><msub><mi>U</mi><mi>j</mi></msub><mo>=</mo><mi mathvariant="normal">∅</mi></mrow><annotation encoding="application/x-tex">U_i \cap U_j = \empty</annotation></semantics></math></span>
</span>，两个召回实验不会同时作用到一个用户上。</p></li><li><p>召回桶
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">U_i</annotation></semantics></math></span>
</span>和精排桶
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">V_j</annotation></semantics></math></span>
</span>交集的大小为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">∣</mo><mrow><msub><mi>U</mi><mi>i</mi></msub><mo>∩</mo><msub><mi>V</mi><mi>j</mi></msub></mrow><mo stretchy="false">∣</mo><mo>=</mo><mfrac><mi>n</mi><mn>100</mn></mfrac></mrow><annotation encoding="application/x-tex">\lvert {U_i \cap V_j} \rvert  = \frac{n}{100}</annotation></semantics></math></span></span></p></li></ul><p>一个用户不能同时受两个召回实验的影响，但可以同时受一个召回实验和一个精排实验的影响。</p><p>一个召回实验和一个精排实验各自作用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>n</mi><mn>10</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{n}{10}</annotation></semantics></math></span>
</span>个用户上，那么有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>n</mi><mn>100</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{n}{100}</annotation></semantics></math></span>
</span>的用户同时受两个实验的影响，即不同层正交。</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401213043281.png width=45% alt>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401213127929.png width=45% alt></center><p><strong>同层互斥</strong></p><p>召回层：把用户随机分成十个桶，每个桶有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户。如果 <code>GNN</code> 的实验占了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个桶，那么其他实验只能用剩余的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span>
</span>个桶。两组召回实验的用户是隔离开的，两组召回实验不能同时做到一个用户上。</p><p><strong>不同层正交</strong></p><p>用户界面层的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>号桶有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户层之间的分筒是随机独立的，所以用户界面层
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>号桶的用户被均匀打散到了召回层的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>个桶。即用户界面的一个实验和召回的一个实验可能会同时作用到一个用户身上。</p><p>通常来说，用户界面实验和召回实验的效果不容易相互增强或者相互抵消。所以我们允许一个用户同时受两层实验的影响。</p><h4 id=互斥-vs-正交 class=heading>互斥 v.s. 正交<a href=#%e4%ba%92%e6%96%a5-vs-%e6%ad%a3%e4%ba%a4 aria-labelledby=互斥-vs-正交><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>如果所有实验全都用正交不用互斥，那么就可以同时做无数组实验。</p><ul><li><p><strong>同类的策略（例如精排模型的两种结构）天然互斥</strong>，对于一个用户，只能用其中一种。</p></li><li><p><strong>同类的策略</strong>（例如添加两条召回通道）效果会 <strong>相互增强</strong>（
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mn>1</mn><mo>&gt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">1+1 &gt; 2</annotation></semantics></math></span>
</span>）或 <strong>相互抵消</strong>（
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mn>1</mn><mo>&lt;</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">1+1 &lt; 2</annotation></semantics></math></span>
</span>)。如果不把两组实验用户做隔离，那么两组实验会同时作用到一部分用户上，测出的实验组和对照组的 diff 会不准。</p><p>互斥可以避免同类策略相互干扰。</p></li><li><p><strong>不同类型的策略</strong>（例如添加召回通道、优化粗排模型)<strong>通常不会相互干扰</strong>（
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>+</mo><mn>1</mn><mo>=</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">1+1 = 2</annotation></semantics></math></span>
</span>），可以作为正交的两层</p></li></ul><h3 id=holdout-机制 class=heading>Holdout 机制<a href=#holdout-%e6%9c%ba%e5%88%b6 aria-labelledby=holdout-机制><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>每个实验（召回、粗排、精排、重排）独立汇报对业务指标的提升。公司考察 <strong>一个部门（比如推荐系统）</strong> 在一段时间内对业务指标总体的提升。</p><ul><li><p>取
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户作为 <strong>holdout 桶</strong>，推荐系统使用剩余
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的用户做实验，两者互斥。</p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>holdout 桶 v.s.
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>实验桶的 diff（<strong>需要归一化</strong>）为整个部门的业务指标收益。</p></li></ul><hr><p><strong>具体做法</strong></p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401213648254.png width=45% alt>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401213702391.png width=45% alt></center><p>将整个大的系统分成 <strong>推荐系统、用户界面、广告等很多大层</strong>，这些层之间正交。</p><p>在 <strong>推荐系统层</strong> 把用户随机分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>个桶：</p><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户作为 holdout。这个桶是干净的，任何新的实验都不能作用到 holdout 用户。</p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的用户做实验。</p></li></ul><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的实验用户细分成
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>层（召回、粗排、精排、重排），这些层之间<strong>正交</strong>。即召回、粗排、精排、重排均可用全部
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的实验用户做实验。召回、粗排、精排、重排的有效实验均会带来两边指标的 diff，而且多个实验贡献的 diff 会叠加。</p><p>如果公司以双月作为考核周期，那么每两个月结束的时候计算
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>实验桶和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>holdout 桶各种指标的 diff 作为整个推荐部门对业务指标的贡献。</p><p>在每个考核周期结束之后会清除 holdout 桶，上推全的实验，从
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>用户扩大到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">100\%</annotation></semantics></math></span>
</span>的用户。</p><p>然后随机重新划分用户，得到新的 holdout 桶和实验桶开始下一轮考核周期。</p><p>由于划分是随机均匀的，新的 holdout 桶与实验桶各种指标的 diff 几乎为零，可以开始公平的实验对比。</p><p>在新的考核周期开始之后，会有召回粗排精排重排的实验上线，有的实验会取得收益并且推全。所有实验的收益都会叠加，让实验桶与 holdout 桶的 diff 逐渐扩大。</p><h3 id=实验推全--反转实验 class=heading>实验推全 & 反转实验<a href=#%e5%ae%9e%e9%aa%8c%e6%8e%a8%e5%85%a8--%e5%8f%8d%e8%bd%ac%e5%ae%9e%e9%aa%8c aria-labelledby=实验推全--反转实验><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><h4 id=实验推全 class=heading>实验推全<a href=#%e5%ae%9e%e9%aa%8c%e6%8e%a8%e5%85%a8 aria-labelledby=实验推全><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401214235791.png width=45% alt>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401214303505.png width=45% alt></center><p>实验推荐系统中所有实验都是从小流量开始的，如果业务指标的 diff 显著正向则可以 <strong>推全实验</strong>。</p><p>【例】</p><p>对于一个 <strong>重排策略</strong> 的实验：</p><ul><li><p>取一个桶作为实验组
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>，一个桶作为对照组
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>。实验一共影响了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">20\%</annotation></semantics></math></span>
</span>的用户。</p></li><li><p>如果观测到显著正向的业务指标收益则可以推全这个策略。把 <strong>重排层</strong> 的实验关掉，这样就能把两个桶空出来给其他实验用。</p></li><li><p>推全的时候 <strong>新开一层</strong> 新策略，会影响全部
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的用户。</p></li><li><p><strong>小流量阶段</strong> 新策略作用到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户上会微弱的提升实验桶与 holdout 桶的 diff。</p></li><li><p><strong>推全之后</strong>，新策略作用到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>90</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">90\%</annotation></semantics></math></span>
</span>的用户上，那么 diff 会扩大
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span>
</span>倍。</p><p>比方说 A/B 测试发现新策略会提升点击率
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span>
</span>个万分点。小流量实验只作用到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户上，所以只能把跟 holdout 桶的 diff 提升
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>个万分点。</p></li><li><p>推全之后 <strong>理论上</strong> 可以把 diff 提升到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>9</mn></mrow><annotation encoding="application/x-tex">9</annotation></semantics></math></span>
</span>个万分点，跟 A/B 测试得到的数据一致。</p></li></ul><h4 id=反转实验 class=heading>反转实验<a href=#%e5%8f%8d%e8%bd%ac%e5%ae%9e%e9%aa%8c aria-labelledby=反转实验><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>上线一个有效的策略之后，需要观测很多业务指标</p><ul><li><p>有的指标（点击、交互）<strong>立刻收到新策略影响</strong>，</p></li><li><p>有的指标（留存）<strong>有滞后性，需要长期观测。</strong></p></li></ul><p>实验观测到显著收益后 <strong>尽快推全新策略</strong>。目的是腾出中桶供其他实验使用，或需要基于新策略做后续的开发。</p><p>用 <strong>反转实验</strong> 解决上述矛盾：既可以 <strong>尽快推全</strong>，也可以 <strong>长期观测实验指标</strong>。</p><p>在推全的新层中开一个旧策略的桶，长期观测实验指标。</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250401214516950.png width=50% alt></center><ul><li><p>为推全新策略开的新层，与召回、粗排、精排、重排均正交。</p></li><li><p>在推全新策略的新层里开一个很小的反转桶，桶里的用户都用旧策略，可以把反转筒保留很久，长期观察新策略与旧策略的 diff。</p></li><li><p>一个考核周期结束之后会清除掉 holdout 桶，但这不会影响反转桶。</p></li><li><p>清除 holdout 桶会把推全的新策略应用到 holdout 的用户上，不会影响反转桶。</p></li><li><p>当反转实验完成时，关闭反转实验，新策略会应用到反转筒的用户上，也就是 <strong>实验真正推全</strong>，对所有用户都生效。</p></li></ul><h2 id=总结-1 class=heading>总结<a href=#%e6%80%bb%e7%bb%93-1 aria-labelledby=总结-1><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><ul><li><p><strong>分层实验</strong>：把容易相互增强或者相互抵消的实验放在同一层，同层互斥（不允许两个实验同时影响一位用户）、不同层正交。（实验有重叠的用户）</p></li><li><p><strong>Holdout</strong>：保留
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>的用户完全不受实验影响，<strong>可以考察整个部门对业务指标的贡献</strong>。</p></li><li><p><strong>实验推全</strong>：新建一个推全层，与其他层正交。</p></li><li><p><strong>反转实验</strong>：为了在尽早推全新策略的同时，还能长期观察各种指标。在新的推全层上，保留一个小的反转桶，使用旧策略。长期观测新旧策略的 diff。</p></li></ul><h1 id=reference class=heading>Reference<a href=#reference aria-labelledby=reference><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h1><p><a href=https://github.com/wangshusen/RecommenderSystem/ class=markdown-link>https://github.com/wangshusen/RecommenderSystem/</a></p></div><div class="row row-cols-2 mt-5 mb-3"><div class=col><a class=next href=/blogs/recommendersystem/retrieval/><svg class="svg-inline--fa fas fa-arrow-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-arrow-left"/></svg>&nbsp;RecommenderSystem-2-召回</a></div><div class="col text-end"></div></div><a href=# id=back-to-top class=back-to-top><span>▲</span>
</a><a href=# id=scroll-to-bottom class=back-to-top><span>▼</span>
</a><script>document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("back-to-top"),t=document.getElementById("scroll-to-bottom");e.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),t.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})})})</script></div><div class="col col-md-3 col-lg-2 d-none d-md-block pt-5"><div class="toc toc-sidebar mb-5 my-md-0 mb-lg-5 p-3 text-body-secondary sticky-top"><strong class="d-block h6 my-2 pt-4">On this page:</strong><nav class=toc><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统的基本概念>推荐系统的基本概念 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#转化流程>转化流程 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#消费指标>消费指标 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#北极星指标>北极星指标 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#实验流程>实验流程 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统链路>推荐系统链路 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#召回通道>召回通道 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#排序>排序 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#重排>重排 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#总结>总结 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#推荐系统-ab-测试>推荐系统 A/B 测试 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#ab-测试的目的>A/B 测试的目的 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#随机分桶>随机分桶 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#分层实验>分层实验 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#holdout-机制>Holdout 机制 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/basics/#实验推全--反转实验>实验推全 & 反转实验 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/basics/#总结-1>总结</a></nav></div></div></div></div><footer class="container-fluid footer text-center p-3"><div class="container-xxl text-center"><small>Copyright © 2025 EV's Blog All rights reserved.
|
Powered by
<a href=https://gethinode.com class="link-bg-footer markdown-link">Hinode</a>.</small></div><script src=https://eveydyw.github.io/js/image-zoom.min.3a7d43efcffd0a24c7162362607ea6a56ee3e3c19c0e260e0fbb41c0206fea83.js integrity="sha256-On1D78/9CiTHFiNiYH6mpW7j48GcDiYOD7tBwCBv6oM=" defer></script></footer></div><div id=toast-container class="toast-container position-fixed bottom-0 end-0 p-3"><div id=toast-copied-code-message class=toast role=alert aria-live=assertive aria-atomic=true><div class=toast-header><strong class=me-auto>EV's Blog</strong>
<button type=button class=btn-close data-bs-dismiss=toast aria-label=Close></button></div><div class=toast-body>Code copied to clipboard</div></div></div><svg xmlns:xlink="http://www.w3.org/1999/xlink" display="none"><symbol id="fas-ellipsis"><path d="M8 256a56 56 0 11112 0A56 56 0 118 256zm160 0a56 56 0 11112 0 56 56 0 11-112 0zm216-56a56 56 0 110 112 56 56 0 110-112z"/></symbol><symbol id="fas-sun"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 11192 0 96 96 0 11-192 0zm224 0a128 128 0 10-256 0 128 128 0 10256 0z"/></symbol><symbol id="fas-moon"><path d="M223.5 32C1e2 32 0 132.3.0 256S1e2 480 223.5 480c60.6.0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9.0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></symbol><symbol id="fas-angle-left"><path d="M41.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol><symbol id="fas-sort"><path d="M137.4 41.4c12.5-12.5 32.8-12.5 45.3.0l128 128c9.2 9.2 11.9 22.9 6.9 34.9S301 224.1 288 224.1L32 224c-12.9.0-24.6-7.8-29.6-19.8s-2.2-25.7 6.9-34.9l128-128zm0 429.3-128-128c-9.2-9.2-11.9-22.9-6.9-34.9S19.1 288 32.1 288h256c12.9.0 24.6 7.8 29.6 19.8s2.2 25.7-6.9 34.9l-128 128c-12.5 12.5-32.8 12.5-45.3.0z"/></symbol><symbol id="fas-arrow-left"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.2 288H416c17.7.0 32-14.3 32-32s-14.3-32-32-32H109.3L214.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol></svg>
<script src=/js/core.bundle-analytics.en.min.ceb6a67c169a28031391976dac91e1e2f460951862201b6249516a55d0fd6109.js data-category=analytics integrity="sha256-zramfBaaKAMTkZdtrJHh4vRglRhiIBtiSVFqVdD9YQk=" crossorigin=anonymous async></script><script src=/js/core.bundle.en.min.b2ac337ff8787d96cf35ffe28a30a119778a2736cb94d2f16606f72cda819f11.js integrity="sha256-sqwzf/h4fZbPNf/iijChGXeKJzbLlNLxZgb3LNqBnxE=" crossorigin=anonymous async></script></body></html>
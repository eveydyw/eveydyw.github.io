<!doctype html><html lang=en class=no-js><head><script src=/js/critical.bundle.min.85a7f5f23dc031d38877ecdb71b00d49e8a62c54f1ba98e75a734706ea09f30a.js integrity="sha256-haf18j3AMdOId+zbcbANSeimLFTxupjnWnNHBuoJ8wo=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.143.1"><meta name=theme content="Hinode 0.29.3"><link rel=stylesheet href="/css/main.min.2d9f08a384019794d7cb9e682556930966cd9db5fc51ca90d439a9f5b1032e59.css" integrity="sha256-LZ8Io4QBl5TXy55oJVaTCWbNnbX8UcqQ1Dmp9bEDLlk=" crossorigin=anonymous><link rel=preload href=/fonts/inter-v12-latin-regular.woff2 as=font type=font/woff2 crossorigin><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>EV's Blog - RecommenderSystem-3-排序</title>
<meta name=description content="【笔记】wangshusen-推荐系统：排序"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="RecommenderSystem-3-排序"><meta property="og:description" content="【笔记】wangshusen-推荐系统：排序"><meta property="og:url" content="https://eveydyw.github.io/blogs/recommendersystem/rank/"><meta property="og:site_name" content="EV's Blog"><meta property="article:published_time" content="2024-09-15T21:48:10+08:00"><meta property="article:modified_time" content="2024-09-15T21:48:10+08:00"><meta property="og:image" content="https://eveydyw.github.io/img/logo1280x640.png"><meta property="og:image:alt" content="RecommenderSystem-3-排序"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="RecommenderSystem-3-排序"><meta name=twitter:description content="【笔记】wangshusen-推荐系统：排序"><meta name=twitter:image content="https://eveydyw.github.io/img/logo1280x640.png"><meta name=twitter:image:alt content="RecommenderSystem-3-排序"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://eveydyw.github.io/#/schema/organization/1","name":"Hinode","url":"https://eveydyw.github.io/","sameAs":[null,"https://github.com/gethinode/hinode"],"logo":{"@type":"ImageObject","@id":"https://eveydyw.github.io/#/schema/image/1","url":"https://eveydyw.github.io/img/logo512x512.png","width":512,"height":512,"caption":"Hinode"},"image":{"@id":"https://eveydyw.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://eveydyw.github.io/#/schema/website/1","url":"https://eveydyw.github.io/","name":"EV\u0027s Blog","description":"Hinode is a clean documentation and blog theme for your Hugo site based on Bootstrap 5.","publisher":{"@id":"https://eveydyw.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/","url":"https://eveydyw.github.io/blogs/recommendersystem/rank/","name":"RecommenderSystem-3-排序","description":"【笔记】wangshusen-推荐系统：排序","isPartOf":{"@id":"https://eveydyw.github.io/#/schema/website/1"},"about":{"@id":"https://eveydyw.github.io/#/schema/organization/1"},"datePublished":"2024-09-15T21:48:10CET","dateModified":"2024-09-15T21:48:10CET","breadcrumb":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eveydyw.github.io/blogs/recommendersystem/rank/"]}]},{"@type":"BreadcrumbList","@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/","url":"https://eveydyw.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/","url":"https://eveydyw.github.io/blogs/","name":"Blogs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/recommendersystem/","url":"https://eveydyw.github.io/blogs/recommendersystem/","name":"Recommendersystem"}},{"@type":"ListItem","position":4,"item":{"@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://eveydyw.github.io/blogs/recommendersystem/rank/#/schema/image/2","url":"https://eveydyw.github.io/img/logo1280x640.png","contentUrl":"https://eveydyw.github.io/img/logo1280x640.png","caption":"RecommenderSystem-3-排序"}]}]}</script><link rel=icon type=image/png sizes=16x16 href=/img/my_logo_hu_10729e67805acfd8.png><link rel=icon type=image/png sizes=32x32 href=/img/my_logo_hu_f267cd4735c3fb50.png><link rel=icon type=image/png sizes=48x48 href=/img/my_logo_hu_bc348718a5ba4099.png><link rel=apple-touch-icon sizes=180x180 href=/img/my_logo_hu_a8f52fe79483cdab.png><script>MathJax={loader:{load:["[tex]/html","[tex]/ams","[tex]/amscd"]},tex:{inlineMath:[["\\(","\\)"],["$","$"]],displayMath:[["\\[","\\]"],["$$","$$"]],processEscapes:!0,packages:["base","ams","amscd"],tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],renderActions:{addMenu:[0,"",""],checkLoading:[0,"",""]}},chtml:{scale:1,displayAlign:"center",displayIndent:"0em",lineWidth:"container"},svg:{fontCache:"global"}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js></script></head><body><div class="d-flex flex-column min-vh-100"><div class="d-flex flex-column"><div class="container-fluid fixed-top p-0"><nav class="navbar p-4 bg-body navbar-fixed-top navbar-expand-md"><div class="container-xxl p-0"><div class="d-flex navbar-container justify-content-center"><div class="d-flex align-items-center"><button class="navbar-toggler collapsed p-0 mx-auto invisible fw-30" type=button><svg class="svg-inline--fa fas fa-ellipsis fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-ellipsis"/></svg></button></div><div class=mx-auto><a class=navbar-brand href=/ aria-label=Home><img src=/img/my_logo.svg alt="EV's Blog logo" height=30 width=30></a></div><div class="d-flex align-items-center"><button class="navbar-toggler main-nav-toggler collapsed p-0" type=button data-bs-toggle=collapse data-bs-target=#navbar-0-collapse aria-controls=navbar-0 aria-expanded=false aria-label="Toggle main navigation">
<span class="toggler-icon top-bar emphasis"></span>
<span class="toggler-icon middle-bar emphasis"></span>
<span class="toggler-icon bottom-bar emphasis"></span></button></div></div><div class="navbar-collapse collapse" id=navbar-0-collapse><div class="d-flex flex-fill ms-md-3 mt-4 mt-md-0"><form class="search flex-fill position-relative me-auto"><input class="search-input form-control is-search" type=search placeholder="Search this site" aria-label="Search this site" autocomplete=off name=search-input><div class="search-suggestions shadow bg-body rounded d-none" data-no-results="No results for"></div></form></div><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link data-nav=main data-nav-main=home href=/><span>Home</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=blogs href=/blogs/><span>Blogs</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=tags href=/tags><span>Tags</span>&nbsp;</a></li><li class="d-flex mode-switch align-items-center" id=navbar-mode><input type=checkbox class="checkbox navbar-mode-selector" id=navbar-mode-checkbox aria-label="Toggle theme">
<label class=label for=navbar-mode-checkbox><svg class="svg-inline--fa fas fa-sun fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 512 512"><use href="#fas-sun"/></svg><svg class="svg-inline--fa fas fa-moon fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 384 512"><use href="#fas-moon"/></svg><div class=ball></div></label></li></ul></div></div></nav></div><div class=main-content></div></div><div class="container-xxl flex-fill p-4 px-xxl-0"><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3"><div class="col col-lg-2 d-none d-lg-block sidebar-overflow sticky-top pt-5"></div><div class="col-12 col-md-9 col-lg-8 mb-5 p-4"><nav aria-label=breadcrumb class=d-sm-none><ol class=breadcrumb><li class=breadcrumb-item><a href=/blogs/recommendersystem/><svg class="svg-inline--fa fas fa-angle-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-angle-left"/></svg>&nbsp;&nbsp;RecommenderSystem</a></li></ol></nav><nav aria-label=breadcrumb class="d-none d-sm-block"><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/blogs/>Blogs</a></li><li class=breadcrumb-item><a href=/blogs/recommendersystem/>RecommenderSystem</a></li><li class="breadcrumb-item active" aria-current=page>RecommenderSystem-3-排序</li></ol></nav><p class="display-4 mt-5">RecommenderSystem-3-排序</p><small class="text-body-secondary text-uppercase">Posted on September 15, 2024
&bull;
5&nbsp;min read &bull;
991&nbsp;words</small><p class="lead mb-5 mt-3">【笔记】wangshusen-推荐系统：排序</p><div class="d-md-none pb-5"><div class="d-grid gap-2 mx-auto"><a aria-label="On this page" href=#toc-collapse class="btn btn-outline-secondary position-relative toc-button" data-bs-toggle=collapse aria-expanded=false aria-controls=toc-collapse role=button><span class="d-flex justify-content-between"><span class=my-auto>On this page</span><span class="align-self-center ps-1"><svg class="svg-inline--fa fas fa-sort" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-sort"/></svg></span></span></a></div><div class="collapse border bg-body-tertiary rounded p-1 navbar-nav-scroll" id=toc-collapse><small><div class="toc toc-panel text-body p-2"><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#多目标排序模型>多目标排序模型 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#多目标模型>多目标模型 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#模型训练>模型训练 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#预估值校准>预估值校准 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#multi-gate-mixture-of-expertsmmoe>Multi-gate Mixture-of-Experts(MMoE) </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#mmoe-模型结构>MMoE 模型结构 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#极化现象>极化现象 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#预估分数的融合>预估分数的融合 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#视频播放建模>视频播放建模 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#图文-vs-视频>图文 v.s. 视频 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#视频播放时长>视频播放时长 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#视频完播>视频完播 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#排序模型的特征>排序模型的特征 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征>特征 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征处理>特征处理 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征覆盖率>特征覆盖率 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#数据服务>数据服务 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#粗排>粗排 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#回顾>回顾 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#粗排的三塔模型>粗排的三塔模型</a></div></small></div></div><div class=content><h2 id=多目标排序模型 class=heading>多目标排序模型<a href=#%e5%a4%9a%e7%9b%ae%e6%a0%87%e6%8e%92%e5%ba%8f%e6%a8%a1%e5%9e%8b aria-labelledby=多目标排序模型><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727215517356.png width=45% alt=1></center><p>​</p><p><strong>用户一笔记的交互</strong></p><p>对于每篇笔记，系统记录：</p><ul><li>曝光次数(number of impressions)</li><li>点击次数（number of clicks）</li><li>点赞次数(number of likes)</li><li>收藏次数（number of collects）</li><li>转发次数((number of shares)</li></ul><hr><ul><li>点击率 = 点击次数 ／ 曝光次数</li><li>点赞率 = 点赞次数 ／ 点击次数</li><li>收藏率 = 收藏次数 ／ 点击次数</li><li>转发率 = 转发次数 ／ 点击次数</li></ul><hr><p><strong>排序的依据</strong></p><ul><li>排序模型预估点击率、点赞率、收藏率、转发率等多种分数。</li><li>融合这些预估分数。（比如加权和，权重为 A/B 测试调试出来）。</li><li>根据融合的分数做排序、截断。</li></ul><h3 id=多目标模型 class=heading>多目标模型<a href=#%e5%a4%9a%e7%9b%ae%e6%a0%87%e6%a8%a1%e5%9e%8b aria-labelledby=多目标模型><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727215909146.png width=45% alt=1></center>​<p>排序模型的输入是各种各样的特征：</p><ul><li><p><strong>用户特征</strong>：用户 id，用户画像。</p></li><li><p><strong>物品特征</strong>：物品 id，物品画像，作者信息。</p></li><li><p><strong>统计特征</strong>：用户统计特征和物品统计特征：</p><ul><li>用户在过去 30 天中一共曝光了多少篇笔记，点击了多少篇笔记，点赞了多少篇笔记。</li><li>候选物品在过去 30 天中一共获得多少次曝光机会，获得了多少次点击、点赞。</li></ul></li><li><p><strong>场景特征</strong>：随着用户请求传过来，包含当前的时间，用户所在地点。</p><ul><li>候选物品跟用户如果在同一个城市，那么用户对物品可能会有更高的兴趣。</li><li>当前是否是周末节假日，也会影响用户的兴趣。</li></ul></li></ul><p>把这些特征做 Concatenation 输入神经网络，神经网络可以是全连接网络、Wide & Deep 等更复杂的结构。</p><p>神经网络会输出一个向量，这个向量再输入
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个神经网络，每个神经网络有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>∼</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">2 \sim 3</annotation></semantics></math></span>
</span>个全联接层，最后一个激活函数是 <code>Sigmoid</code>。</p><p>四个神经网络分别输出 <strong>点击率、点赞率、收藏率、转发率</strong> 的预估值，四个预估指都
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>∼</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 \sim 1</annotation></semantics></math></span>
</span>的实数。</p><p>推荐系统的排序主要靠这
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个预估值，它们反映出用户对物品的兴趣。</p><h3 id=模型训练 class=heading>模型训练<a href=#%e6%a8%a1%e5%9e%8b%e8%ae%ad%e7%bb%83 aria-labelledby=模型训练><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727220555025.png width=45% alt=1></center><p>​</p><p><strong>模型输出</strong>的<strong>点击率</strong>、<strong>点赞率</strong>、<strong>收藏率</strong>、<strong>转发率</strong>分别记作
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">p_2</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">p_3</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">p_4</annotation></semantics></math></span>
</span>，它们都是模型做出的预估。做训练时，让这些预估值去拟合真实的目标。</p><p><strong>真实的目标</strong>记作
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_1</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_2</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_3</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>4</mn></msub></mrow><annotation encoding="application/x-tex">y_4</annotation></semantics></math></span>
</span>，分别对应<strong>点击</strong>、<strong>点赞</strong>、<strong>收藏</strong>、<strong>转发</strong>的行为，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy="false">{</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">y_i \in \{0,1\}</annotation></semantics></math></span>
</span>。</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y_1 = 1</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_2 = 0</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">y_3=0</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>4</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y_4=1</annotation></semantics></math></span>
</span>，表示用户对物品有点击，没点赞，没收藏，有转发，这些是用户真实的行为。</p><p>训练鼓励模型的预测接近目标，即做二元分类，对点击点赞收藏转发等的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>个任务，每个任务都是一个二元分类，分别使用 <strong>交叉熵损失函数</strong>。</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mtext>CrossEntropy</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>⋅</mo><mi>ln</mi><mo>⁡</mo><msub><mi>p</mi><mi>i</mi></msub><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>y</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo>⋅</mo><mi>ln</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo><mo fence="false" stretchy="true" minsize="1.2em" maxsize="1.2em">)</mo></mrow><annotation encoding="application/x-tex">
\text{CrossEntropy}(y_i, p_i)=-\big(y_i\cdot\ln p_i+(1-y_i)\cdot\ln(1-p_i)\big)
</annotation></semantics></math></span></div><p>总的损失函数:</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>4</mn></munderover><msub><mi>α</mi><mi>i</mi></msub><mo>⋅</mo><mtext>CrossEntropy</mtext><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
\sum_{i = 1}^4\alpha_i\cdot\text{CrossEntropy}(y_i, p_i)
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math></span>
</span>：根据经验设置。</li></ul><p>对损失函数求梯度，做梯度下降更新参数。</p><hr><p><strong>【困难】</strong></p><p>类别不平衡：</p><ul><li>每 100 次曝光，约有 10 次点击，90 次无点击 。</li><li>每 100 次点击，约有 10 次收藏，90 次无收藏 。</li></ul><p><strong>【解决方案】</strong></p><p>负样本降采样（down-sampling）：</p><ul><li>保留一小部分负样本。</li><li>让正负样本数量平衡，节约计算</li></ul><h3 id=预估值校准 class=heading>预估值校准<a href=#%e9%a2%84%e4%bc%b0%e5%80%bc%e6%a0%a1%e5%87%86 aria-labelledby=预估值校准><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><a href=https://research.facebook.com/publications/practical-lessons-from-predicting-clicks-on-ads-at-facebook/ class=markdown-link>Practical Lessons from Predicting Clicks on Ads at Facebook</a></p><p>正样本、负样本数量为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mo>+</mo></msub></mrow><annotation encoding="application/x-tex">n_+</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mo>−</mo></msub></mrow><annotation encoding="application/x-tex">n_-</annotation></semantics></math></span>
</span>。</p><p>对负样本做降采样，抛弃一部分负样本。使用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>⋅</mo><msub><mi>n</mi><mo>−</mo></msub></mrow><annotation encoding="application/x-tex">\alpha \cdot n_-</annotation></semantics></math></span>
</span>个负样本，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi><mo>∈</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\alpha \in (0,1)</annotation></semantics></math></span>
</span>是采样率。</p><p>由于负样本变少，<strong>预估点击率大于真实点击率</strong>。</p><ul><li><p><strong>真实点击率</strong>（期望）：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>n</mi><mo>+</mo></msub><mrow><msub><mi>n</mi><mo>+</mo></msub><mo>+</mo><msub><mi>n</mi><mo>−</mo></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
  p_{\mathrm{true}}=\frac{n_+}{n_++n_-}
  </annotation></semantics></math></span></div></li><li><p><strong>预估点击率</strong>（期望）：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi></mrow></msub><mo>=</mo><mfrac><msub><mi>n</mi><mo>+</mo></msub><mrow><msub><mi>n</mi><mo>+</mo></msub><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>n</mi><mo>−</mo></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
  p_{\mathrm{pred}}=\frac{n_+}{n_++\alpha\cdot n_-}
  </annotation></semantics></math></span></div></li><li><p><strong>校准公式</strong>：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>α</mi><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi></mrow></msub></mrow><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi></mrow></msub><mo stretchy="false">)</mo><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">d</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
  p_{\mathrm{true}}=\frac{\alpha\cdot p_{\mathrm{pred}}}{(1-p_{\mathrm{pred}})+\alpha\cdot p_{\mathrm{pred}}}
  </annotation></semantics></math></span></div></li></ul><h2 id=multi-gate-mixture-of-expertsmmoe class=heading>Multi-gate Mixture-of-Experts(<code>MMoE</code>)<a href=#multi-gate-mixture-of-expertsmmoe aria-labelledby=multi-gate-mixture-of-expertsmmoe><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=mmoe-模型结构 class=heading><code>MMoE</code> 模型结构<a href=#mmoe-%e6%a8%a1%e5%9e%8b%e7%bb%93%e6%9e%84 aria-labelledby=mmoe-模型结构><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><a href=https://dl.acm.org/doi/10.1145/3219819.3220007 class=markdown-link>Modeling Task Relationships in Multi-task Learning with Multi-gate Mixture-of-Experts</a></p><p>对神经网络输出的向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">{</mo><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><mo stretchy="false">}</mo></mrow><annotation encoding="application/x-tex">\{\mathbf{x}_i\}</annotation></semantics></math></span>
</span>做加权平均，然后用加权平均得到的向量去预估某个业务指标。</p><p><strong>下例中需要预估
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>个指标，用了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个专家</strong>。神经网络专家神经网络的数量是个超参数，需要手动调。（通常
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>或
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>8</mn></mrow><annotation encoding="application/x-tex">8</annotation></semantics></math></span>
</span>）</p><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727222421883.png width=40% alt=1>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727221629513.png width=40% alt=1></center><p>​</p><ol><li><p>模型的输入是一个向量，包含<strong>用户特征</strong>、<strong>物品特征</strong>、<strong>统计特征</strong>、<strong>场景特征</strong>。</p></li><li><p>把向量输入
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个神经网络（实践中通常为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>∼</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">4 \sim 8</annotation></semantics></math></span>
</span>），这
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个神经网络结构相同，由很多全连接层组成，但这
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个神经网络<strong>不共享参数</strong>，这三个神经网络即为 <strong>专家（Experts）</strong>。</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个神经网络各输出一个向量：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_3</annotation></semantics></math></span>
</span>。</p></li><li><p>把 <strong>用户特征</strong>、<strong>物品特征</strong>、<strong>统计特征</strong>、<strong>场景特征</strong> 拼接的特征向量输入另一个神经网络，这个神经网络也有多个全连接层。</p><p>在神经网络的最后加一个 <code>Softmax</code> 激活函数，输出一个三维的向量：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>p</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>p</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>p</mi><mn>3</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[p_1, p_2, p_3]</annotation></semantics></math></span>
</span>。</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span>
</span>满足
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">p_i \in [0,1]</annotation></semantics></math></span>
</span>且
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><msub><mi>p</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3 p_i= 1</annotation></semantics></math></span>
</span>。</p><p>分别对应
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个专家神经网络之后，用这三个元素作为权重对向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_3</annotation></semantics></math></span>
</span>做加权平均。</p></li><li><p>同理把 <strong>用户特征</strong>、<strong>物品特征</strong>、<strong>统计特征</strong>、<strong>场景特征</strong> 拼接的特征向量送入右边的神经网络，在神经网络的最后也是 <code>Softmax</code> 激活函数输出一个三维向量：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>q</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>q</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>q</mi><mn>3</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[q_1, q_2, q_3]</annotation></semantics></math></span>
</span>。</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">q_i</annotation></semantics></math></span>
</span>满足
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub><mo>∈</mo><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">q_i \in [0,1]</annotation></semantics></math></span>
</span>且
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mn>3</mn></msubsup><msub><mi>q</mi><mi>i</mi></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\sum_{i=1}^3 q_i= 1</annotation></semantics></math></span>
</span>。</p><p>这
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个元素也是之后做加权平均值的权重。</p></li></ol><hr><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727221717895.png width=45% alt=1></center><p>​</p><ol><li><p>用权重
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">p_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">p_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">p_3</annotation></semantics></math></span>
</span>对向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_3</annotation></semantics></math></span>
</span>做加权平均，得到左边向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>p</mi><mn>2</mn></msub><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>p</mi><mn>3</mn></msub><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">p_1 \mathbf{x}_1 + p_2\mathbf{x}_2 + p_3\mathbf{x}_3</annotation></semantics></math></span>
</span>。</p><p>用权重
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">q_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">q_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">q_3</annotation></semantics></math></span>
</span>对向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_3</annotation></semantics></math></span>
</span>做加权平均，得到右边向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>1</mn></msub><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>q</mi><mn>2</mn></msub><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>q</mi><mn>3</mn></msub><msub><mi mathvariant="bold">x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">q_1 \mathbf{x}_1 + q_2\mathbf{x}_2 + q_3\mathbf{x}_3</annotation></semantics></math></span>
</span>。</p></li><li><p>把左边向量输入一个神经网络，神经网络可以有一个或者多个全连接层，神经网络输出<strong>一个指标的预估</strong>。取决于具体的任务，比如神经网络输出对点击率的预估是一个介于
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>∼</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0\sim 1</annotation></semantics></math></span>
</span>之间的实数。</p><p>把右边的向量输入另一个神经网络，这个神经网络会输出 <strong>另一个指标的预估</strong>。比如对点赞略的预估也是介于 0~1 之间的实数</p></li><li><p>图中假设多目标模型只有点击率和点赞率这两个目标，所以用了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">p</mi></mrow><annotation encoding="application/x-tex">\mathbf{p}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">q</mi></mrow><annotation encoding="application/x-tex">\mathbf{q}</annotation></semantics></math></span>
</span>这两组权重。假如有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>个目标，那么就要用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>组权重。</p></li></ol><h3 id=极化现象 class=heading>极化现象<a href=#%e6%9e%81%e5%8c%96%e7%8e%b0%e8%b1%a1 aria-labelledby=极化现象><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><a href=https://dl.acm.org/doi/10.1145/3298689.3346997 class=markdown-link>Recommending what video to watch next: a multitask ranking system</a></p><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727223610585.png width=45% alt=1></center><p>​</p><p>上例中有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>个 <code>Softmax</code> 函数，各自输出一个
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>维向量，每个向量都是概率分布元素，大于
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span>
</span>相加等于
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>。</p><p><strong>极化</strong>：<code>Softmax</code> 输出的向量中一个值接近
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>，其余值接近
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span>
</span>。</p><ul><li><p>左边的 <code>Softmax</code> 输出值约等于
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0, 0, 1</annotation></semantics></math></span>
</span>，即左边的预估点击率任务只使用了第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>号专家神经网络，而没有使用其他两个专家神经网络。</p><p>这样就等于没有用 mixture of experts，没有让三个专家神经网络的输出融合，而是简单使用了一个专家</p></li><li><p>右边 <code>Softmax</code> 的输出值接近
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">0, 1, 0</annotation></semantics></math></span>
</span>，即右边的任务只使用了第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>号专家神经网络，也没有对三个专家做融合。</p></li><li><p>两个任务分别使用了第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>号和第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>号专家神经网络，第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>号专家神经网络不会被用到。</p><p>那么 <code>MMoE</code> 就相当于一个简单的多目标模型，不会对专家做融合，失去了<code>MMoE</code>的优势。</p></li></ul><h4 id=解决办法 class=heading>解决办法<a href=#%e8%a7%a3%e5%86%b3%e5%8a%9e%e6%b3%95 aria-labelledby=解决办法><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>如果有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个 “专家”，那么每个 <code>softmax</code> 的输入和输出都是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>维向量。</p><p>训练时，对 <code>Softmax</code> 的输出使用 <code>dropout</code>。</p><ul><li><code>Softmax</code> 输出的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个数值被 mask 的概率都是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>。</li><li>每个“专家”被随机丢弃的概率都是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">10\%</annotation></semantics></math></span>
</span>。</li></ul><p><code>dropout</code> 会强迫每个任务根据部分专家做预测：</p><ul><li>如果用 <code>dropout</code> 不太可能会发生极化，否则预测的结果会特别差。</li><li>假如发生极化，<code>Softmax</code> 输出的某个元素接近
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>，万一这个元素被 mask，预测的结果肯定会错得离谱。</li><li>为了让预测尽量精准，神经网络会尽量避免极化的发生，避免 <code>Softmax</code> 输出的某个元素接近
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>。</li></ul><h2 id=预估分数的融合 class=heading>预估分数的融合<a href=#%e9%a2%84%e4%bc%b0%e5%88%86%e6%95%b0%e7%9a%84%e8%9e%8d%e5%90%88 aria-labelledby=预估分数的融合><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><p><strong>简单的加权和</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><munder><munder><msub><mi>p</mi><mtext>click</mtext></msub><mo stretchy="true">⏟</mo></munder><mtext>点击率</mtext></munder><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><mo>⋅</mo><munder><munder><msub><mi>p</mi><mtext>like</mtext></msub><mo stretchy="true">⏟</mo></munder><mtext>点赞率</mtext></munder><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><mo>⋅</mo><munder><munder><msub><mi>p</mi><mtext>collect</mtext></msub><mo stretchy="true">⏟</mo></munder><mtext>收藏率</mtext></munder><mo>+</mo><mo>⋯</mo></mrow><annotation encoding="application/x-tex">
\underbrace{p_\text{click}}_{\text{点击率}}+w_1\cdot \underbrace{p_\text{like}}_{\text{点赞率}}+w_2\cdot \underbrace{p_\text{collect}}_{\text{收藏率}}+\cdots
</annotation></semantics></math></span></div><hr><p><strong>点击率乘以其他项的加权和</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi></mrow></msub><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">t</mi></mrow></msub><mo>+</mo><mo>⋯</mo><mtext> </mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
p_{\mathrm{click}}\cdot(1+w_1\cdot p_{\mathrm{like}}+w_2\cdot p_{\mathrm{collect}}+\cdots)
</annotation></semantics></math></span></div><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi></mrow></msub><mo>=</mo><mfrac><mtext>点击</mtext><mtext>曝光</mtext></mfrac></mrow><annotation encoding="application/x-tex">p_{\mathrm{click}} = \frac{\text{点击}}{\text{曝光}}</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>=</mo><mfrac><mtext>点赞</mtext><mtext>点击</mtext></mfrac></mrow><annotation encoding="application/x-tex">p_{\mathrm{like}} = \frac{\text{点赞}}{\text{点击}}</annotation></semantics></math></span></span></p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi></mrow></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow></msub><mo>=</mo><mfrac><mtext>点赞</mtext><mtext>曝光</mtext></mfrac></mrow><annotation encoding="application/x-tex">p_{\mathrm{click}}\cdot p_{\mathrm{like}} =  \frac{\text{点赞}}{\text{曝光}}</annotation></semantics></math></span></span></p></li></ul><hr><p><strong>海外某短视频APP的融分公式</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>w</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi></mrow></msub><msup><mo stretchy="false">)</mo><msub><mi>α</mi><mn>1</mn></msub></msup><mo>⋅</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow></msub><msup><mo stretchy="false">)</mo><msub><mi>α</mi><mn>2</mn></msub></msup><mo>⋯</mo></mrow><annotation encoding="application/x-tex">
(1+w_1\cdot p_{\mathrm{time}})^{\alpha_1}\cdot(1+w_2\cdot p_{\mathrm{like}})^{\alpha_2}\cdots
</annotation></semantics></math></span></div><ul><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mtext>time</mtext></msub></mrow><annotation encoding="application/x-tex">p_{\text{time}}</annotation></semantics></math></span>
</span>：预估短视频的观看时长（比如预测用户会观看
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>秒）。</p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">w_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math></span>
</span>: 超参，通过线上A/B test 确定。</p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><mo>⋅</mo><msub><mi>p</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow></msub><msup><mo stretchy="false">)</mo><msub><mi>α</mi><mn>2</mn></msub></msup></mrow><annotation encoding="application/x-tex">(1+w_2\cdot p_{\mathrm{like}})^{\alpha_2}</annotation></semantics></math></span>
</span>：对点赞率的函数变换。</p></li><li><p>取多个预估指标的函数变换取连乘作为最终的融合分数。</p></li></ul><hr><p><strong>国内某短视频APP的融分公式</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><msub><mi>w</mi><mn>1</mn></msub><mrow><msubsup><mi>r</mi><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi></mrow><msub><mi>α</mi><mn>1</mn></msub></msubsup><mo>+</mo><msub><mi>β</mi><mn>1</mn></msub></mrow></mfrac><mo>+</mo><mfrac><msub><mi>w</mi><mn>2</mn></msub><mrow><msubsup><mi>r</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi></mrow><msub><mi>α</mi><mn>2</mn></msub></msubsup><mo>+</mo><msub><mi>β</mi><mn>2</mn></msub></mrow></mfrac><mo>+</mo><mfrac><msub><mi>w</mi><mn>3</mn></msub><mrow><msubsup><mi>r</mi><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">k</mi><mi mathvariant="normal">e</mi></mrow><msub><mi>α</mi><mn>3</mn></msub></msubsup><mo>+</mo><msub><mi>β</mi><mn>3</mn></msub></mrow></mfrac><mo>+</mo><mo>⋯</mo></mrow><annotation encoding="application/x-tex">
\frac{w_1}{r_{\mathrm{time}}^{\alpha_1}+\beta_1} + \frac{w_2}{r_{\mathrm{click}}^{\alpha_2}+\beta_2} + \frac{w_3}{r_{\mathrm{like}}^{\alpha_3}+\beta_3} + \cdots
</annotation></semantics></math></span></div><ul><li><p>多目标标排序模型给
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个候选视频打分得到预估的播放时长、点击率、点赞率、转发率等指标。</p></li><li><p>根据预估时长
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mtext>time</mtext></msub></mrow><annotation encoding="application/x-tex">p_{\text{time}}</annotation></semantics></math></span>
</span>对
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>篇候选视频做排序。</p></li><li><p>如果某视频排名第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mtext>time</mtext></msub></mrow><annotation encoding="application/x-tex">r_{\text{time}}</annotation></semantics></math></span>
</span>，则它得分为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mrow><msubsup><mi>r</mi><mrow><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">e</mi></mrow><mi>α</mi></msubsup><mo>+</mo><mi>β</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{r_{\mathrm{time}}^\alpha+\beta}</annotation></semantics></math></span>
</span>，播放时长越长，排名越靠前，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mtext>time</mtext></msub></mrow><annotation encoding="application/x-tex">r_{\text{time}}</annotation></semantics></math></span>
</span>越小，得分越高。</p></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\alpha_i</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\beta_i</annotation></semantics></math></span>
</span>: 超参。</p></li><li><p>对点击、点赞、转发、评论等预估分数做类似处理。</p></li></ul><hr><p><strong>某电商的融分公式</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">k</mi></mrow><msub><mi>α</mi><mn>1</mn></msub></msubsup><mo>×</mo><msubsup><mi>p</mi><mrow><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">t</mi></mrow><msub><mi>α</mi><mn>2</mn></msub></msubsup><mo>×</mo><msubsup><mi>p</mi><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi></mrow><msub><mi>α</mi><mn>3</mn></msub></msubsup><mo>×</mo><msup><mrow><mi mathvariant="normal">p</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">e</mi></mrow><msub><mi>α</mi><mn>4</mn></msub></msup></mrow><annotation encoding="application/x-tex">
p_{\mathrm{click}}^{\alpha_1}\times p_{\mathrm{cart}}^{\alpha_2}\times p_{\mathrm{pay}}^{\alpha_3}\times \mathrm{price}^{\alpha_4}
</annotation></semantics></math></span></div><ul><li><p>电商的转化流程：曝光 -> 点击 -> 加购物车 -> 付款。</p></li><li><p>模型预估要预估中间每一步的转化率：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mtext>click</mtext></msub></mrow><annotation encoding="application/x-tex">p_\text{click}</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mtext>cart</mtext></msub></mrow><annotation encoding="application/x-tex">p_\text{cart}</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mtext>pay</mtext></msub></mrow><annotation encoding="application/x-tex">p_\text{pay}</annotation></semantics></math></span>
</span>。</p></li><li><p>当
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>α</mi><mn>1</mn></msub><mo>=</mo><msub><mi>α</mi><mn>2</mn></msub><mo>=</mo><msub><mi>α</mi><mn>3</mn></msub><mo>=</mo><msub><mi>α</mi><mn>4</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">\alpha_1 = \alpha_2 = \alpha_3 = \alpha_4 = 1</annotation></semantics></math></span>
</span>时，乘积为电商营收。</p></li></ul><h2 id=视频播放建模 class=heading>视频播放建模<a href=#%e8%a7%86%e9%a2%91%e6%92%ad%e6%94%be%e5%bb%ba%e6%a8%a1 aria-labelledby=视频播放建模><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=图文-vs-视频 class=heading>图文 v.s. 视频<a href=#%e5%9b%be%e6%96%87-vs-%e8%a7%86%e9%a2%91 aria-labelledby=图文-vs-视频><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ul><li><p>图文笔记排序的主要依据：点击、点赞、收藏、转发、评论·····</p></li><li><p>视频排序的依据还有<strong>播放时长和完播</strong>。</p></li><li><p>直接用回归拟合播放时长效果不好。</p></li></ul><h3 id=视频播放时长 class=heading>视频播放时长<a href=#%e8%a7%86%e9%a2%91%e6%92%ad%e6%94%be%e6%97%b6%e9%95%bf aria-labelledby=视频播放时长><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><a href=https://dl.acm.org/doi/10.1145/2959100.2959190 class=markdown-link>Deep Neural Networks for YouTube Recommendations</a></p><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727224746922.png width=40% alt=1>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727224823562.png width=40% alt=1></center><p>​</p><p>把用户特征、视频特征、场景特征、统计特征等排序模型需要的特征输入多层神经网络。</p><p>这个神经网络叫做 <strong>shared bottom</strong>，被所有任务共享。</p><p>在这个神经网络之上有很多个全连接层，每个全连接层对应一个目标（点击、点赞、收藏、播放时长）。</p><p><strong>考虑对播放时长的预估</strong>，假设最右边的输出对应播放时长：</p><ul><li><p>全连接层输出的实数记作
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span>
</span>。</p></li><li><p>对
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span>
</span>做 <code>Sigmod</code> 变换得到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mtext>sigmoid</mtext><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><mrow><mn>1</mn><mo>+</mo><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">p=\text{sigmoid}(z) = \frac{\exp(z)}{1+\exp(z)}</annotation></semantics></math></span>
</span>。</p></li><li><p>定义
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mfrac><mi>t</mi><mrow><mn>1</mn><mo>+</mo><mi>t</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">y=\frac t{1+t}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span>
</span>表示用户实际观看视频的时长，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span>
</span>越大则
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span>
</span>也越大。</p></li><li><p>让
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>拟合
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span>
</span>：使用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>的交叉熵作为损失函数：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">E</mi></mrow><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mi>y</mi><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>p</mi><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mrow><mo fence="true">(</mo><mfrac><mi>t</mi><mrow><mn>1</mn><mo>+</mo><mi>t</mi></mrow></mfrac><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>p</mi><mo>+</mo><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mi>t</mi></mrow></mfrac><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
    \begin{align}
    \mathrm{CE}(y,p) &amp;=y\cdot\log p+(1-y)\cdot\log(1-p)\\[7pt]
     &amp;= -\left(\frac t{1+t}\cdot\log p+\frac1{1+t}\cdot\log(1-p)\right)
    \end{align}
    </annotation></semantics></math></span></div></li><li><p>如果
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mi>y</mi></mrow><annotation encoding="application/x-tex">p=y</annotation></semantics></math></span>
</span>，那么
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><mi>t</mi></mrow><annotation encoding="application/x-tex">\exp(z)=t</annotation></semantics></math></span>
</span>。因此可以用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\exp(z)</annotation></semantics></math></span>
</span>作为播放时长的预估。</p></li><li><p><strong>训练</strong>中使用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span>
</span>与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>的交叉熵作为损失函数训练模型。</p></li><li><p>线上做<strong>推理</strong>的时候，用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>exp</mi><mo>⁡</mo><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\exp(z)</annotation></semantics></math></span>
</span>，把它作为对播放时长的预估。</p></li></ul><h3 id=视频完播 class=heading>视频完播<a href=#%e8%a7%86%e9%a2%91%e5%ae%8c%e6%92%ad aria-labelledby=视频完播><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><h4 id=回归方法 class=heading>回归方法<a href=#%e5%9b%9e%e5%bd%92%e6%96%b9%e6%b3%95 aria-labelledby=回归方法><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>【例】：视频长度
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>分钟，实际播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span>
</span>分钟，则实际播放率为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mn>0.4</mn></mrow><annotation encoding="application/x-tex">y=0.4</annotation></semantics></math></span>
</span>。</p><ul><li><p>让预估播放率
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span>
</span>拟合
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span>
</span>:</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">s</mi></mrow><mo>=</mo><mi>y</mi><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mi>p</mi><mo>+</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>y</mi><mo stretchy="false">)</mo><mo>⋅</mo><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">
    \mathrm{loss} = y\cdot \log p + (1 -y) \cdot \log(1 -p)
    </annotation></semantics></math></span></div></li><li><p>线上预估完播率，模型输出
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mn>0.73</mn></mrow><annotation encoding="application/x-tex">p=0.73</annotation></semantics></math></span>
</span>，意思是预计播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>73</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">73\%</annotation></semantics></math></span>
</span>。</p></li><li><p>预估的完播率类似点赞率、收藏率等，反映出用户对物品的兴趣。</p></li><li><p>预估的完播率会作为融分公式中的一项影响视频的排序。</p></li></ul><h4 id=二元分类方法 class=heading>二元分类方法<a href=#%e4%ba%8c%e5%85%83%e5%88%86%e7%b1%bb%e6%96%b9%e6%b3%95 aria-labelledby=二元分类方法><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p><strong>定义完播指标</strong>，比如完播
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>80</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">80\%</annotation></semantics></math></span>
</span>。</p><p>【例】：视频长度
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span>
</span>分钟，播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">&gt;8</annotation></semantics></math></span>
</span>分钟作为<strong>正样本</strong>，播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">&lt; 8</annotation></semantics></math></span>
</span>分钟作为<strong>负样本</strong>。</p><p>做二元分类训练模型：播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&gt;</mo><mn>80</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">&gt;80\%</annotation></semantics></math></span>
</span>v.s. 播放
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>&lt;</mo><mn>80</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">&lt;80\%</annotation></semantics></math></span></span></p><p>线上预估完播率，模型输出
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>=</mo><mn>0.73</mn></mrow><annotation encoding="application/x-tex">p=0.73</annotation></semantics></math></span>
</span>，意为：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="double-struck">P</mi><mo stretchy="false">(</mo><mtext>播放</mtext><mo>&gt;</mo><mn>80</mn><mi mathvariant="normal">%</mi><mo stretchy="false">)</mo><mtext> </mtext><mo>=</mo><mtext> </mtext><mn>0.73</mn></mrow><annotation encoding="application/x-tex">
\mathbb{P}(\text{播放}&gt;80\%)~=~0.73
</annotation></semantics></math></span></div><hr><p><strong>不能直接把预估的完播率用到融分公式</strong></p><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727225339151.png width=45% alt=1></center><p>​</p><p>从直觉上说，视频越长，完播率就越低。</p><p>一个
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn></mrow><annotation encoding="application/x-tex">15</annotation></semantics></math></span>
</span>秒的短视频完播率会很高，但是
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>15</mn></mrow><annotation encoding="application/x-tex">15</annotation></semantics></math></span>
</span>分钟的长视频完播率就会比较低了。如果直接用预估的完播率，那么会有利于短视频而对长视频不公平。</p><p>图中的曲线趋势显示，视频越长，完播率就越低。</p><p>用函数
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex"> f</annotation></semantics></math></span>
</span>拟合蓝色的曲线，函数
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span>
</span>的自变量是视频长度。用函数
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span>
</span>对预估的完播率做调整，这样可以公平对待长短视频的完播率。</p><ul><li>线上预估完播率，然后做调整：</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">h</mi></mrow></msub><mo>=</mo><mfrac><mtext>预估完播率</mtext><mrow><mi>f</mi><mo stretchy="false">(</mo><mtext>视频长度</mtext><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">
p_{\mathrm{finish}}=\frac{\text{预估完播率}}{f(\text{视频长度})}
</annotation></semantics></math></span></div><ul><li>把
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi mathvariant="normal">f</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">s</mi><mi mathvariant="normal">h</mi></mrow></msub></mrow><annotation encoding="application/x-tex">p_{\mathrm{finish}}</annotation></semantics></math></span>
</span>作为融分公式中的一项。</li></ul><h2 id=排序模型的特征 class=heading>排序模型的特征<a href=#%e6%8e%92%e5%ba%8f%e6%a8%a1%e5%9e%8b%e7%9a%84%e7%89%b9%e5%be%81 aria-labelledby=排序模型的特征><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=特征 class=heading>特征<a href=#%e7%89%b9%e5%be%81 aria-labelledby=特征><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><h4 id=用户画像user-profile class=heading>用户画像(User Profile)<a href=#%e7%94%a8%e6%88%b7%e7%94%bb%e5%83%8fuser-profile aria-labelledby=用户画像user-profile><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ul><li><p><strong>用户ID</strong>：用户id本身不携带任何有用的信息，但是模型学到的id embedding向量对召回、排序模型有很重要的影响，通常用
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn></mrow><annotation encoding="application/x-tex">32</annotation></semantics></math></span>
</span>位或者
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>64</mn></mrow><annotation encoding="application/x-tex">64</annotation></semantics></math></span>
</span>位向量)。</p></li><li><p><strong>人口统计学属性</strong>：性别、年龄。</p></li><li><p><strong>账号信息</strong>：新老、活跃度……（模型需要专门针对新用户、低活用户做优化）。</p></li><li><p><strong>感兴趣</strong>的类目、关键词、品牌 （用户自己填写/算法自动提取）。</p></li></ul><h4 id=物品画像item-profile class=heading>物品画像(Item Profile)<a href=#%e7%89%a9%e5%93%81%e7%94%bb%e5%83%8fitem-profile aria-labelledby=物品画像item-profile><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ul><li><p>物品ID（在召回、排序中做embedding)。</p></li><li><p>发布时间(或者年龄)</p><ul><li>小红书一篇笔记发表的时间越久，价值就越低。</li><li>强时效性话题发表的时间越久，价值就越低。</li></ul></li><li><p><code>GeoHash</code>（经纬度编码）、所在城市。</p></li><li><p>标题、类目、关键词、品牌：</p><ul><li>通常对这些离散的内容特征做 embedding。</li></ul></li><li><p>字数、图片数、视频清晰度、标签数……：</p><ul><li>反映出笔记的质量，笔记的点击和交互指标跟这些属性相关。</li></ul></li><li><p>内容信息量、图片美学：</p><ul><li>算法打的分数，事先用人工标注的数据训练 cv 和 nlp 模型。</li><li>当新笔记发布的时候用模型给笔记打分，把内容信息量、图片美学这些分数写到物品画像中。</li><li>这些分数可以作为排序模型的特征。</li></ul></li></ul><h4 id=用户统计特征 class=heading>用户统计特征<a href=#%e7%94%a8%e6%88%b7%e7%bb%9f%e8%ae%a1%e7%89%b9%e5%be%81 aria-labelledby=用户统计特征><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ul><li><p>用户最近30天（7天、1天、1小时）的曝光数、点击数、点赞数、收藏数……</p><ul><li>用各种时间粒度可以反映出用户的实时兴趣、短期兴趣、中长期兴趣。</li></ul></li><li><p>按照笔记图文/视频分桶。（比如最近7天，该用户对图文笔记的点击率、对视频笔记的点击率。）</p><ul><li>对图文和视频分别做统计，可以反映出用户对两类笔记的偏好。</li></ul></li><li><p>按照笔记类目分桶。（比如最近30天，用户对美妆笔记的点击率、对美食笔记的点击率、对科技数码笔记的点击率。）</p><ul><li>反映出用户对哪些类目更感兴趣。</li></ul></li></ul><h4 id=笔记统计特征 class=heading>笔记统计特征<a href=#%e7%ac%94%e8%ae%b0%e7%bb%9f%e8%ae%a1%e7%89%b9%e5%be%81 aria-labelledby=笔记统计特征><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ul><li><p>笔记最近30天（7天、1天、1小时）的曝光数、点击数、点赞数、收藏数……</p><ul><li>这些统计量反映出笔记的受欢迎程度。如果点击率、点赞率等指标都很高，说明笔记质量高，算法应该给这样的笔记更多的流量。</li><li>使用不同的时间粒度：有些笔记的时效性强，30天指标很高，但是最近一天的指标很差，说明这样的笔记已经过时了，不应该给更多流量。</li></ul></li><li><p>按照用户性别分桶、按照用户年龄分桶……</p><ul><li><p>比如一篇笔记是对粉色键盘的测评，笔记的总体点击点赞指标都很高，但是来自男性用户的点击率很低。</p><p>这说明不应该把这款粉色键盘推荐给男性用户。</p></li></ul></li><li><p>作者特征：</p><ul><li>发布笔记数</li><li>粉丝数</li><li>消费指标(曝光数、点击数、点赞数、收藏数)</li></ul></li></ul><h4 id=场景特征context class=heading>场景特征(Context)<a href=#%e5%9c%ba%e6%99%af%e7%89%b9%e5%be%81context aria-labelledby=场景特征context><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p>随着推荐请求传来，不用从用户画像、笔记画像的数据库中获取。</p><ul><li><p>用户定位 <code>GeoHash</code>（经纬度编码）、城市。</p></li><li><p>当前时刻（分段，做embedding）。</p></li><li><p>是否是周末、是否是节假日。</p></li><li><p>手机品牌、手机型号、操作系统。</p></li></ul><h3 id=特征处理 class=heading>特征处理<a href=#%e7%89%b9%e5%be%81%e5%a4%84%e7%90%86 aria-labelledby=特征处理><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><strong>离散特征：做embedding</strong>。</p><ul><li>用户ID、笔记ID、作者ID。</li><li>类目、关键词丶城市、手机品牌</li></ul><p><strong>连续特征：做分桶，变成离散特征</strong>。</p><ul><li>年龄、笔记字数、视频长度</li></ul><p><strong>连续特征：其他变换</strong>。</p><ul><li>曝光数、点击数、点赞数等（长尾分布）数值做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(1+x)</annotation></semantics></math></span></span><ul><li>大多数笔记只有几百次曝光，而极少数的笔记能有上百万次曝光，如果直接把曝光数作为特征输入模型，训练的时候梯度会很离谱，做推理的时候预估值会很奇怪。</li></ul></li><li>转化为点击率、点赞率等值，并做平滑。</li></ul><p>实际的推荐系统中，两种变换之后的连续特征都作为模型的输入。</p><p>比如
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mtext>曝光数</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(1+\text{曝光数})</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mtext>点击数</mtext><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\log(1+\text{点击数})</annotation></semantics></math></span>
</span>会被用到，平滑之后的点击率、点赞率也会被用到。</p><h3 id=特征覆盖率 class=heading>特征覆盖率<a href=#%e7%89%b9%e5%be%81%e8%a6%86%e7%9b%96%e7%8e%87 aria-labelledby=特征覆盖率><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>很多特征无法覆盖100%样本。</p><ul><li>例：很多用户不填年龄，因此用户年龄特征的覆盖率远小于100%。</li><li>例：很多用户设置隐私权限，APP不能获得用户地理定位，因此场景特征有缺失。</li></ul><p>提高特征覆盖率，可以让精排模型更准。</p><p>做特征工程的时候，还要考虑当特征缺失的时候，要用什么作为默认值。</p><h3 id=数据服务 class=heading>数据服务<a href=#%e6%95%b0%e6%8d%ae%e6%9c%8d%e5%8a%a1 aria-labelledby=数据服务><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ol><li><p>用户画像(User Profile)。</p></li><li><p>物品画像(Item Profile)。</p></li><li><p>统计数据。</p></li></ol><p>三个数据源都存储在内存数据库中，在线上服务的时候，排序服务器会从三个数据源取回所需的数据，然后把读取的数据做处理作为特征传给模型，模型就能预估出点击率、点赞率等指标。</p><p>​</p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727230829519.png width=40% alt=1>
<img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727230932051.png width=40% alt=1></center><p>​</p><ol><li><p>当用户刷小红书的时候，用户请求会被发送到推荐系统的主服务器上，主服务器会把请求发送到召回服务器上。</p><p>做完召回之后，召回服务器会把几十度召回的结果做归并，把几千篇笔记的id返回给主服务器。召回需要调用用户画像。</p></li><li><p>主服务器把<strong>笔记id、用户id、场景特征</strong>发送给排序服务器，包括一个用户id和几千个笔记id，笔记id是召回的结果。</p><p><strong>用户id和场景特征都是从用户请求中获取的</strong>。场景特征包括当前的时刻、用户所在的地点以及手机的型号和操作系统。</p><p>接下来排序服务器要从多个数据源中取回排序所需的特征，主要是三个数据源：<strong>用户画像、物品画像还有统计数据</strong>。取回的特征分别是<strong>用户特征、物品特征、统计特征。</strong></p><ul><li><p>用户画像数据库线上压力比较小，因为每次只读一个用户的特征。</p></li><li><p>物品画像数据库压力非常大，粗排要给几千篇笔记做排序，读取几千篇笔记的特征。</p></li><li><p>存用户统计值的数据库压力小，存物品统计值的数据库压力很大。</p></li><li><p>在工程实现的时候，用户画像里面存什么都可以，特征可以很多很大。但尽量不要往物品画像里塞很大的向量，否则物品画像会承受过大的压力。</p></li><li><p><strong>用户画像较为静态</strong>，像性别年龄这样的属性几乎不会发生变化，用户活跃度、兴趣标签这些属性通常也就是天级别的刷新，变化很慢。</p></li><li><p><strong>物品画像的变化更少，可以认为是完全静态的</strong>。物品自身的属性还有算法给物品打的标签，在很长一段时间内不会发生任何变化。</p></li><li><p>对于<strong>用户画像和物品画像最重要的是读取速度快</strong>，而不太需要考虑时效性，因为他们都是静态的。有时候甚至可以把用户画像和物品画像缓存在排序服务器本地，让读取变得更快。</p></li><li><p>不能把统计数据在本地缓存，<strong>统计数据是动态变化的，时效性很强</strong>。比如用户刷新小红书往下刷了30篇笔记，点击了5篇，点赞了1篇，那么这个用户的曝光点击点赞的统计量都发生了变化，要尽快刷新数据库。</p></li></ul></li><li><p>在收集到排序所需的特征之后，排序服务器把特征打包传递给 TF Serving。Tensorflow会给笔记打分。</p><p>把分数返回给排序服务器，排序服务器会用<strong>融合的分数、多样性分数、还有业务规则</strong>给笔记做排序，把排名最高的几十篇笔记返回给主服务器。</p><p>这些就是最终给用户曝光的笔记。</p></li></ol><h2 id=粗排 class=heading>粗排<a href=#%e7%b2%97%e6%8e%92 aria-labelledby=粗排><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><h3 id=回顾 class=heading>回顾<a href=#%e5%9b%9e%e9%a1%be aria-labelledby=回顾><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><h4 id=粗排-vs-精排 class=heading>粗排 vS 精排<a href=#%e7%b2%97%e6%8e%92-vs-%e7%b2%be%e6%8e%92 aria-labelledby=粗排-vs-精排><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><p><strong>粗排：</strong></p><ul><li>给几千篇笔记打分。</li><li>单次推理代价必须小。</li><li>预估的准确性不高。</li></ul><p><strong>精排</strong>：</p><ul><li>给几百篇笔记打分。</li><li>单次推理代价很大。</li><li>预估的准确性更高。</li></ul><h4 id=精排模型 class=heading>精排模型<a href=#%e7%b2%be%e6%8e%92%e6%a8%a1%e5%9e%8b aria-labelledby=精排模型><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727231313653.png width=45% alt></center><p>​</p><ol><li>最下面是精排模型用到的特征：用户特征、物品特征、统计特征、场景特征。</li><li>直接对这些特征做concatenation，然后输入一个神经网络，这个神经网络叫做 shared bottom，意思是它被多个任务共享。</li><li>把shared bottom输出的向量输入上面多个头，得到对点击率、点赞率等指标的预估。</li></ol><ul><li>精排模型的代价主要是在shared bottom，因为它很大，神经网络结构也很复杂。<strong>精排模型属于前期融合</strong>。</li><li><strong>前期融合</strong>：先对所有特征做concatenation，再输入神经网络。</li><li>线上推理代价大：如果有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>篇候选笔记，整个大模型要做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理。</li></ul><h4 id=双塔模型召回 class=heading>双塔模型(召回)<a href=#%e5%8f%8c%e5%a1%94%e6%a8%a1%e5%9e%8b%e5%8f%ac%e5%9b%9e aria-labelledby=双塔模型召回><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727231558767.png width=45% alt></center><p>​</p><ol><li>左边是用户塔，右边是物品塔。两个塔各输出一个向量，两个向量的余弦相似度表示用户是否对物品感兴趣。</li><li>在训练好模型之后，把物品向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi></mrow><annotation encoding="application/x-tex">\mathbf{b}</annotation></semantics></math></span>
</span>存储在向量数据库。在线上不需要用物品塔做计算，线上推理只需要用到用户塔。</li><li>每做一次推荐用户塔只做一次推理，计算出一个向量
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span>
</span>。</li></ol><ul><li>双塔模型的计算代价很小，适合做<strong>召回</strong>。双塔模型是典型的后期融合。</li><li><strong>后期融合</strong>：把用户、物品特征分别输入不同的神经网络；不对用户、物品特征做融合。</li><li>线上计算量小：<ul><li>用户塔只需要做一次线上推理，计算用户表征
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">a</mi></mrow><annotation encoding="application/x-tex">\mathbf{a}</annotation></semantics></math></span>
</span>。</li><li>物品表征
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">b</mi></mrow><annotation encoding="application/x-tex">\mathbf{b}</annotation></semantics></math></span>
</span>事先储存在向量数据库中，物品塔在线上不做推理。</li></ul></li><li>预估准确性不如精排模型。</li></ul><h3 id=粗排的三塔模型 class=heading>粗排的三塔模型<a href=#%e7%b2%97%e6%8e%92%e7%9a%84%e4%b8%89%e5%a1%94%e6%a8%a1%e5%9e%8b aria-labelledby=粗排的三塔模型><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><a href=https://arxiv.org/abs/2007.16122 class=markdown-link>COLD: Towards the Next Generation of Pre-Ranking System</a></p><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727231914871.png width=45% alt></center><p>​</p><p>粗排是三塔模型，效果介于双塔和精排之间。</p><ul><li><p>输入：</p><ul><li><p>用户塔的输入是用户特征和场景特征。</p></li><li><p>物品塔的输入只有物品特征。</p></li><li><p>交叉塔的输入包括统计特征和交叉特征，交叉特征是指用户特征与物品特征做交叉。</p></li></ul></li><li><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个塔分别输出
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个向量，对
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个向量做 concatenation 和交叉得到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>个向量。</p></li><li><p>把这个向量送入多个头，他们输出点击率、点赞率等指标的预估。</p></li><li><p>训练粗排模型的方法为正常的端到端训练跟精排完全一样。</p></li></ul><hr><p><strong>【区别】</strong></p><ul><li>最主要的区别是下面的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个塔。这个模型介于前期融合与后期融合之间。</li><li>前期融合指把底层特征做 concatenation，这里是把
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个塔输出的向量做 concatenation 。</li></ul><h4 id=底层模型 class=heading>底层模型<a href=#%e5%ba%95%e5%b1%82%e6%a8%a1%e5%9e%8b aria-labelledby=底层模型><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727232722054.png width=45% alt></center><p>​</p><ul><li><p><strong>用户塔</strong>可以很大很复杂：</p><p>线上每次给一个用户做推荐，<strong>用户塔只需要做一次推理</strong>，即使用户塔很大推理很慢也没有关系。用户塔对粗排总的计算量影响很小。</p></li><li><p><strong>物品塔</strong>每给用户做一次推荐，粗排需要给
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品打分，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>的大小是几千。理论上来说，物品塔需要做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理。但好在物品的属性相对比较稳定，短期之内不会发生变化。</p><p>可以把<strong>物品塔输出向量缓存在 parameter server</strong>，每隔一段时间刷新一次。</p><p>由于做了缓存，物品塔在线上几乎不用做推理，只有遇到新物品的时候物品塔才需要做推理。粗排给几千物品打分，物品塔实际上只需要做几十次推理，计算量还好。</p><p>所以物品塔的规模可以比较大。</p></li><li><p><strong>交叉塔</strong>输入是用户和物品的统计特征，还有用户和物品特征的交叉。</p><p>统计特征会实时动态变化，每当一个用户发生点击等行为，它的统计特征就会发生变化。每当一个物品获得曝光和交互，它的点击次数、点击率等指标就会发生变化。</p><p>由于交叉塔的输入会实时发生变化，因此不应该缓存交叉塔输出的向量，<strong>交叉塔在线上的推理</strong>避免不掉。</p><p>粗排给
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品打分，有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品的统计特征和交叉特征，交叉塔要实实在在做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理，所以交叉塔必须足够小，计算够快。</p><p>通常来说交叉塔只有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>层，宽度也比较小。</p></li><li><p>粗排模型底层
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个塔，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个塔各输出
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>个向量，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个向量融合起来作为上层多个头的输入。</p></li></ul><h4 id=上层结构 class=heading>上层结构<a href=#%e4%b8%8a%e5%b1%82%e7%bb%93%e6%9e%84 aria-labelledby=上层结构><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><center><img style="border-radius:.3125em;box-shadow:0 .2rem .4rem rgba(34,36,38,.12);margin:.5rem" src=pics/image-20250727232821034.png width=45% alt></center><ul><li>粗排给
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品打分，模型上层需要做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理，无法用缓存等方式避免计算粗排。</li><li>推理的大部分计算量在模型上层。</li><li>模型上层做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理代价大于交叉它的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理。</li></ul><h4 id=三塔模型的推理 class=heading>三塔模型的推理<a href=#%e4%b8%89%e5%a1%94%e6%a8%a1%e5%9e%8b%e7%9a%84%e6%8e%a8%e7%90%86 aria-labelledby=三塔模型的推理><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h4><ul><li><p>从多个数据源取特征：</p><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>个用户的<strong>画像</strong>、<strong>统计特征</strong>。</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品的<strong>画像</strong>、<strong>统计特征</strong>。</li></ul></li><li><p><strong>用户塔</strong>：只做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>次推理。</p></li><li><p><strong>物品塔</strong>：先缓存在parameter server上，未命中缓存时需要做推理。</p><ul><li>最坏的情况下，物品塔需要做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理。</li><li>实际上缓存的命中率非常高，99%的物品都会命中缓存，做推理给几千个候选物品，做粗排时物品塔只需要做几十次推理。</li></ul></li><li><p><strong>交叉塔</strong>：输入都是动态特征，必须做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理。</p></li><li><p><strong>上层网络</strong>做
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>次推理，给
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span>
</span>个物品打分。</p></li></ul><p><strong>粗排模型的设计理念</strong>就是<strong>尽量减少推理的计算量</strong>，使得模型可以在线上给几千篇笔记打分。</p><h1 id=reference class=heading>Reference<a href=#reference aria-labelledby=reference><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h1><p><a href=https://github.com/wangshusen/RecommenderSystem/ class=markdown-link>https://github.com/wangshusen/RecommenderSystem/</a></p></div><div class="row row-cols-2 mt-5 mb-3"><div class=col></div><div class="col text-end"><a class=previous href=/blogs/recommendersystem/retrieval/>RecommenderSystem-2-召回&nbsp;<svg class="svg-inline--fa fas fa-arrow-right" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-arrow-right"/></svg></a></div></div><a href=# id=back-to-top class=back-to-top><span>▲</span>
</a><a href=# id=scroll-to-bottom class=back-to-top><span>▼</span>
</a><script>document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("back-to-top"),t=document.getElementById("scroll-to-bottom");e.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),t.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})})})</script></div><div class="col col-md-3 col-lg-2 d-none d-md-block pt-5"><div class="toc toc-sidebar mb-5 my-md-0 mb-lg-5 p-3 text-body-secondary sticky-top"><strong class="d-block h6 my-2 pt-4">On this page:</strong><nav class=toc><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#多目标排序模型>多目标排序模型 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#多目标模型>多目标模型 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#模型训练>模型训练 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#预估值校准>预估值校准 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#multi-gate-mixture-of-expertsmmoe>Multi-gate Mixture-of-Experts(MMoE) </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#mmoe-模型结构>MMoE 模型结构 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#极化现象>极化现象 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#预估分数的融合>预估分数的融合 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#视频播放建模>视频播放建模 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#图文-vs-视频>图文 v.s. 视频 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#视频播放时长>视频播放时长 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#视频完播>视频完播 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#排序模型的特征>排序模型的特征 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征>特征 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征处理>特征处理 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#特征覆盖率>特征覆盖率 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#数据服务>数据服务 </a><a class="toc-item toc-level-1" href=/blogs/recommendersystem/rank/#粗排>粗排 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#回顾>回顾 </a><a class="toc-item toc-level-2" href=/blogs/recommendersystem/rank/#粗排的三塔模型>粗排的三塔模型</a></nav></div></div></div></div><footer class="container-fluid footer text-center p-3"><div class="container-xxl text-center"><small>Copyright © 2025 EV's Blog All rights reserved.
|
Powered by
<a href=https://gethinode.com class="link-bg-footer markdown-link">Hinode</a>.</small></div><script src=https://eveydyw.github.io/js/image-zoom.min.3a7d43efcffd0a24c7162362607ea6a56ee3e3c19c0e260e0fbb41c0206fea83.js integrity="sha256-On1D78/9CiTHFiNiYH6mpW7j48GcDiYOD7tBwCBv6oM=" defer></script></footer></div><div id=toast-container class="toast-container position-fixed bottom-0 end-0 p-3"><div id=toast-copied-code-message class=toast role=alert aria-live=assertive aria-atomic=true><div class=toast-header><strong class=me-auto>EV's Blog</strong>
<button type=button class=btn-close data-bs-dismiss=toast aria-label=Close></button></div><div class=toast-body>Code copied to clipboard</div></div></div><svg xmlns:xlink="http://www.w3.org/1999/xlink" display="none"><symbol id="fas-ellipsis"><path d="M8 256a56 56 0 11112 0A56 56 0 118 256zm160 0a56 56 0 11112 0 56 56 0 11-112 0zm216-56a56 56 0 110 112 56 56 0 110-112z"/></symbol><symbol id="fas-sun"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 11192 0 96 96 0 11-192 0zm224 0a128 128 0 10-256 0 128 128 0 10256 0z"/></symbol><symbol id="fas-moon"><path d="M223.5 32C1e2 32 0 132.3.0 256S1e2 480 223.5 480c60.6.0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9.0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></symbol><symbol id="fas-angle-left"><path d="M41.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol><symbol id="fas-sort"><path d="M137.4 41.4c12.5-12.5 32.8-12.5 45.3.0l128 128c9.2 9.2 11.9 22.9 6.9 34.9S301 224.1 288 224.1L32 224c-12.9.0-24.6-7.8-29.6-19.8s-2.2-25.7 6.9-34.9l128-128zm0 429.3-128-128c-9.2-9.2-11.9-22.9-6.9-34.9S19.1 288 32.1 288h256c12.9.0 24.6 7.8 29.6 19.8s2.2 25.7-6.9 34.9l-128 128c-12.5 12.5-32.8 12.5-45.3.0z"/></symbol><symbol id="fas-arrow-right"><path d="M438.6 278.6c12.5-12.5 12.5-32.8.0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3L338.8 224H32c-17.7.0-32 14.3-32 32s14.3 32 32 32h306.7L233.4 393.4c-12.5 12.5-12.5 32.8.0 45.3s32.8 12.5 45.3.0l160-160z"/></symbol></svg>
<script src=/js/core.bundle-analytics.en.min.ceb6a67c169a28031391976dac91e1e2f460951862201b6249516a55d0fd6109.js data-category=analytics integrity="sha256-zramfBaaKAMTkZdtrJHh4vRglRhiIBtiSVFqVdD9YQk=" crossorigin=anonymous async></script><script src=/js/core.bundle.en.min.b2ac337ff8787d96cf35ffe28a30a119778a2736cb94d2f16606f72cda819f11.js integrity="sha256-sqwzf/h4fZbPNf/iijChGXeKJzbLlNLxZgb3LNqBnxE=" crossorigin=anonymous async></script></body></html>
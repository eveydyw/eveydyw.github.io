<!doctype html><html lang=en class=no-js><head><script src=/js/critical.bundle.min.85a7f5f23dc031d38877ecdb71b00d49e8a62c54f1ba98e75a734706ea09f30a.js integrity="sha256-haf18j3AMdOId+zbcbANSeimLFTxupjnWnNHBuoJ8wo=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.143.1"><meta name=theme content="Hinode 0.29.3"><link rel=stylesheet href="/css/main.min.2035ba2641dd892fae7cbd28eb9f8ed3c3c8330a06d3f53264b92e4aa28df477.css" integrity="sha256-IDW6JkHdiS+ufL0o65+O08PIMwoG0/UyZLkuSqKN9Hc=" crossorigin=anonymous><link rel=preload href=/fonts/inter-v12-latin-regular.woff2 as=font type=font/woff2 crossorigin><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>EV's Blog - Attention</title>
<meta name=description content="Transformer Attention"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Attention"><meta property="og:description" content="Transformer Attention"><meta property="og:url" content="https://eveydyw.github.io/blogs/attention/"><meta property="og:site_name" content="EV's Blog"><meta property="article:published_time" content="2024-09-21T23:35:21+08:00"><meta property="article:modified_time" content="2024-09-21T23:35:21+08:00"><meta property="og:image" content="https://eveydyw.github.io/img/logo1280x640.png"><meta property="og:image:alt" content="Attention"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Attention"><meta name=twitter:description content="Transformer Attention"><meta name=twitter:image content="https://eveydyw.github.io/img/logo1280x640.png"><meta name=twitter:image:alt content="Attention"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://eveydyw.github.io/#/schema/organization/1","name":"Hinode","url":"https://eveydyw.github.io/","sameAs":[null,"https://github.com/gethinode/hinode"],"logo":{"@type":"ImageObject","@id":"https://eveydyw.github.io/#/schema/image/1","url":"https://eveydyw.github.io/img/logo512x512.png","width":512,"height":512,"caption":"Hinode"},"image":{"@id":"https://eveydyw.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://eveydyw.github.io/#/schema/website/1","url":"https://eveydyw.github.io/","name":"EV\u0027s Blog","description":"Hinode is a clean documentation and blog theme for your Hugo site based on Bootstrap 5.","publisher":{"@id":"https://eveydyw.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/attention/","url":"https://eveydyw.github.io/blogs/attention/","name":"Attention","description":"Transformer Attention","isPartOf":{"@id":"https://eveydyw.github.io/#/schema/website/1"},"about":{"@id":"https://eveydyw.github.io/#/schema/organization/1"},"datePublished":"2024-09-21T23:35:21CET","dateModified":"2024-09-21T23:35:21CET","breadcrumb":{"@id":"https://eveydyw.github.io/blogs/attention/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://eveydyw.github.io/blogs/attention/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://eveydyw.github.io/blogs/attention/"]}]},{"@type":"BreadcrumbList","@id":"https://eveydyw.github.io/blogs/attention/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/","url":"https://eveydyw.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://eveydyw.github.io/blogs/","url":"https://eveydyw.github.io/blogs/","name":"Blogs"}},{"@type":"ListItem","position":3,"item":{"@id":"https://eveydyw.github.io/blogs/attention/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://eveydyw.github.io/blogs/attention/#/schema/image/2","url":"https://eveydyw.github.io/img/logo1280x640.png","contentUrl":"https://eveydyw.github.io/img/logo1280x640.png","caption":"Attention"}]}]}</script><link rel=icon type=image/png sizes=16x16 href=/img/my_logo_hu_10729e67805acfd8.png><link rel=icon type=image/png sizes=32x32 href=/img/my_logo_hu_f267cd4735c3fb50.png><link rel=icon type=image/png sizes=48x48 href=/img/my_logo_hu_bc348718a5ba4099.png><link rel=apple-touch-icon sizes=180x180 href=/img/my_logo_hu_a8f52fe79483cdab.png><script>MathJax={loader:{load:["[tex]/html","[tex]/ams","[tex]/amscd"]},tex:{inlineMath:[["\\(","\\)"],["$","$"]],displayMath:[["\\[","\\]"],["$$","$$"]],processEscapes:!0,packages:["base","ams","amscd"],tags:"ams"},options:{skipHtmlTags:["script","noscript","style","textarea","pre","code"],renderActions:{addMenu:[0,"",""],checkLoading:[0,"",""]}},chtml:{scale:1,displayAlign:"center",displayIndent:"0em",lineWidth:"container"},svg:{fontCache:"global"}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js></script></head><body><div class="d-flex flex-column min-vh-100"><div class="d-flex flex-column"><div class="container-fluid fixed-top p-0"><nav class="navbar p-4 bg-body navbar-fixed-top navbar-expand-md"><div class="container-xxl p-0"><div class="d-flex navbar-container justify-content-center"><div class="d-flex align-items-center"><button class="navbar-toggler collapsed p-0 mx-auto invisible fw-30" type=button><svg class="svg-inline--fa fas fa-ellipsis fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-ellipsis"/></svg></button></div><div class=mx-auto><a class=navbar-brand href=/ aria-label=Home><img src=/img/my_logo.svg alt="EV's Blog logo" height=30 width=30></a></div><div class="d-flex align-items-center"><button class="navbar-toggler main-nav-toggler collapsed p-0" type=button data-bs-toggle=collapse data-bs-target=#navbar-0-collapse aria-controls=navbar-0 aria-expanded=false aria-label="Toggle main navigation">
<span class="toggler-icon top-bar emphasis"></span>
<span class="toggler-icon middle-bar emphasis"></span>
<span class="toggler-icon bottom-bar emphasis"></span></button></div></div><div class="navbar-collapse collapse" id=navbar-0-collapse><div class="d-flex flex-fill ms-md-3 mt-4 mt-md-0"><form class="search flex-fill position-relative me-auto"><input class="search-input form-control is-search" type=search placeholder="Search this site" aria-label="Search this site" autocomplete=off name=search-input><div class="search-suggestions shadow bg-body rounded d-none" data-no-results="No results for"></div></form></div><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link data-nav=main data-nav-main=home href=/><span>Home</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=blogs href=/Blogs/><span>Blogs</span>&nbsp;</a></li><li class=nav-item><a class=nav-link data-nav=main data-nav-main=tags href=/tags><span>Tags</span>&nbsp;</a></li><li class="d-flex mode-switch align-items-center" id=navbar-mode><input type=checkbox class="checkbox navbar-mode-selector" id=navbar-mode-checkbox aria-label="Toggle theme">
<label class=label for=navbar-mode-checkbox><svg class="svg-inline--fa fas fa-sun fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 512 512"><use href="#fas-sun"/></svg><svg class="svg-inline--fa fas fa-moon fa-fw" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 384 512"><use href="#fas-moon"/></svg><div class=ball></div></label></li></ul></div></div></nav></div><div class=main-content></div></div><div class="container-xxl flex-fill p-4 px-xxl-0"><div class="row row-cols-1 row-cols-md-2 row-cols-lg-3"><div class="col col-lg-2 d-none d-lg-block sidebar-overflow sticky-top pt-5"></div><div class="col-12 col-md-9 col-lg-8 mb-5 p-4"><nav aria-label=breadcrumb class=d-sm-none><ol class=breadcrumb><li class=breadcrumb-item><a href=/blogs/><svg class="svg-inline--fa fas fa-angle-left" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-angle-left"/></svg>&nbsp;&nbsp;Blogs</a></li></ol></nav><nav aria-label=breadcrumb class="d-none d-sm-block"><ol class=breadcrumb><li class=breadcrumb-item><a href=/>Home</a></li><li class=breadcrumb-item><a href=/blogs/>Blogs</a></li><li class="breadcrumb-item active" aria-current=page>Attention</li></ol></nav><p class="display-4 mt-5">Attention</p><small class="text-body-secondary text-uppercase">Posted on September 21, 2024
&bull;
20&nbsp;min read &bull;
4,091&nbsp;words</small><p class="lead mb-5 mt-3">Transformer Attention</p><div class="d-md-none pb-5"><div class="d-grid gap-2 mx-auto"><a aria-label="On this page" href=#toc-collapse class="btn btn-outline-secondary position-relative toc-button" data-bs-toggle=collapse aria-expanded=false aria-controls=toc-collapse role=button><span class="d-flex justify-content-between"><span class=my-auto>On this page</span><span class="align-self-center ps-1"><svg class="svg-inline--fa fas fa-sort" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 320 512"><use href="#fas-sort"/></svg></span></span></a></div><div class="collapse border bg-body-tertiary rounded p-1 navbar-nav-scroll" id=toc-collapse><small><div class="toc toc-panel text-body p-2"><a class="toc-item toc-level-1" href=/blogs/attention/#kv-cache>KV Cache </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-推理过程>KV Cache 推理过程 </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-参数量估计>KV Cache 参数量估计 </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-降低的重要性>KV Cache 降低的重要性 </a><a class="toc-item toc-level-1" href=/blogs/attention/#mha--mqa--gqa--mla>MHA & MQA & GQA & MLA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mha>MHA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mqa>MQA </a><a class="toc-item toc-level-2" href=/blogs/attention/#gqa>GQA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mla>MLA</a></div></small></div></div><div class=content><h2 id=kv-cache class=heading>KV Cache<a href=#kv-cache aria-labelledby=kv-cache><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><p><code>KV Cache</code> 在不影响任何计算精度的前提下，通过空间换时间思想，提高推理性能。</p><p><code>KV Cache</code> <strong>只能用于 Decoder 架构的模型</strong>，因为 Decoder 有 <strong>Causal Mask</strong>，在推理的时候前面已经生成的字符不需要与后面的字符产生 attention，从而使得前面已经计算的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span>
</span>可以缓存起来。</p><h3 id=kv-cache-推理过程 class=heading>KV Cache 推理过程<a href=#kv-cache-%e6%8e%a8%e7%90%86%e8%bf%87%e7%a8%8b aria-labelledby=kv-cache-推理过程><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>假设模型初始输入只有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>个 token</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mrow><annotation encoding="application/x-tex">
\mathrm{Att}(Q, K, V) = \text{softmax}({\mathbf{q_1}} \mathbf{k_1}^\top ) \mathbf{v_1}
</annotation></semantics></math></span></div><p>其中 :
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><mo fence="true">)</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">Q = \left(  \mathbf{q_1} \right) \in \mathbb{R}^{1\times d}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mo fence="true">)</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">K = \left(  \mathbf{k_1} \right) \in \mathbb{R}^{1\times d}</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub><mo fence="true">)</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mn>1</mn><mo>×</mo><mi>d</mi></mrow></msup></mrow><annotation encoding="application/x-tex">V = \left(  \mathbf{v_1} \right) \in \mathbb{R}^{1\times d}</annotation></semantics></math></span></span></p><p>当模型生成第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>个 token 时，Attention 的计算如下：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo stretchy="false">)</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext>softmax</mtext><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathrm {Att}(Q, K, V)
&amp; = \mathrm{softmax}(
	\begin{bmatrix}
    \mathbf{q_1}\mathbf{k_1}^\top&amp;-\infty \\ 
    \mathbf{q_2}\mathbf{k_1}^{\top}&amp;\mathbf{q_2}\mathbf{k_2}^{\top}
    \end{bmatrix})
	\begin{bmatrix}\mathbf{v_1}\\\mathbf{v_2}\end{bmatrix} \\[7pt]
&amp; =\begin{bmatrix}
	\text{softmax}( \mathbf{q_1}\mathbf{k_1}^\top)&amp;0\\
	\text{softmax}(\mathbf{q_2}\mathbf{k_1}^{\top})&amp;\text{softmax}(\mathbf{q_2}\mathbf{k_2}^{\top})
	\end{bmatrix}
	\begin{bmatrix}\mathbf{v_1}\\\mathbf{v_2}\end{bmatrix} \\[7pt]
&amp;=\begin{bmatrix}
	\mathrm{softmax}(\mathbf{q_1}\mathbf{k_1}^\top)\mathbf{v_1}\\[7pt]
	\mathrm{softmax}(\mathbf{q_2}\mathbf{k_1}^{\top})\mathbf{v_1}+\mathrm{softmax}(\mathbf{q_2}\mathbf{k_2}^{\top})\mathbf{v_2}
	\end{bmatrix} \\[7pt]
&amp; = \begin{bmatrix}
	\mathrm{Att_1}(Q, K, V) \\
	\mathrm{Att_2}(Q, K, V)
\end{bmatrix} 
\end{aligned}
</annotation></semantics></math></span></div><p>其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Att_1}(Q,K,V)</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Att_2}(Q,K,V)</annotation></semantics></math></span>
</span>分别表示 Attention 的第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>行：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mi mathvariant="bold">i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">k</mi><mi mathvariant="bold">i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q_i}, \mathbf{k_i} \in \mathbb R^d</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
{\mathrm{Att_1}}(Q, K, V) &amp;= \mathrm{softmax}(\mathbf{q_1}\mathbf{k_1}^\top)\mathbf{v_1} \\[7pt]
{\mathrm{Att_2}}(Q, K, V) &amp;= 	\mathrm{softmax}(\mathbf{q_2}\mathbf{k_1}^{\top})\mathbf{v_1}+\mathrm{softmax}(\mathbf{q_2}\mathbf{k_2}^{\top})\mathbf{v_2}
\end{aligned}
</annotation></semantics></math></span></div><p>由于 Decoder 有 Causal Mask，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q_2}\mathbf{k_1}^\top</annotation></semantics></math></span>
</span>这个值会被 mask</p><p>当模型生成第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>个 token 时，可推导得：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>3</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
\mathrm {Att}(Q, K, V)
 = \begin{bmatrix}
	\mathrm{Att_1}(Q, K, V) \\
	\mathrm{Att_2}(Q, K, V) \\
	\mathrm{Att_3}(Q, K, V)
\end{bmatrix} 
\end{aligned}
</annotation></semantics></math></span></div><p>其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Att_1}(Q,K,V)</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Att_2}(Q,K,V)</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>3</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Att_3}(Q,K,V)</annotation></semantics></math></span>
</span>分别表示 Attention 的第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span>
</span>行：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mi mathvariant="bold">i</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">k</mi><mi mathvariant="bold">i</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q_i}, \mathbf{k_i} \in \mathbb R^d</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>1</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">1</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>2</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">2</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mn>3</mn></msub></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">3</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">1</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">1</mn></msub><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">3</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">2</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">2</mn></msub><mo>+</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><msub><mi mathvariant="bold">q</mi><mn mathvariant="bold">3</mn></msub><msup><msub><mi mathvariant="bold">k</mi><mn mathvariant="bold">3</mn></msub><mi mathvariant="normal">⊤</mi></msup><mo stretchy="false">)</mo><msub><mi mathvariant="bold">v</mi><mn mathvariant="bold">3</mn></msub></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
{\mathrm{Att_1}}(Q, K, V) &amp;= \mathrm{softmax}(\mathbf{q_1}\mathbf{k_1}^\top)\mathbf{v_1} \\[7pt]
{\mathrm{Att_2}}(Q, K, V) &amp;= \mathrm{softmax}(\mathbf{q_2}\mathbf{k_1}^{\top})\mathbf{v_1}+\mathrm{softmax}(\mathbf{q_2}\mathbf{k_2}^{\top})\mathbf{v_2}\\[7pt]
{\mathrm{Att_3}}(Q, K, V) &amp;=\mathrm{softmax}(\mathbf{q_3}\mathbf{k_1}^{\top})\mathbf{v_1}+\mathrm{softmax}(\mathbf{q_3}\mathbf{k_2}^{\top})\mathbf{v_2}+\mathrm{softmax}(\mathbf{q_3}\mathbf{k_3}^{\top})\mathbf{v_3}
\end{aligned}
</annotation></semantics></math></span></div><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><msub><mi mathvariant="normal">t</mi><mi mathvariant="normal">k</mi></msub></mrow><annotation encoding="application/x-tex">\mathrm{Att_k}</annotation></semantics></math></span>
</span>只依赖 <strong>当前</strong> 的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mi mathvariant="bold">k</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{q_k}</annotation></semantics></math></span>
</span>和 <strong>之前</strong> 所有的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span>
</span>，所以 <strong>只有 KV cache，没有 Q cache</strong></p><ul><li>直接计算存在冗余</li><li>推理第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span>
</span>个字符的时候只需要输入第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k-1</annotation></semantics></math></span>
</span>个字符</li></ul><hr><p><strong>【实现】</strong></p><ul><li><p>在推理时使用 <code>past_key_values</code> 参数，以追加方式保存每一轮的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span>
</span>值。</p><p>保存的内容为 <code>((k,v), (k,v), ..., (k,v))</code>，即有 n_layer 个 <code>(k,v)</code> 组成的一个元组，其中 <code>k</code> 和 <code>v</code> 的维度均为 [B, n_head, L, head_dims]</p></li><li><p>推理输出的 token 直接作为下一轮的输入，不再拼接，因为上文信息已经在 <code>past_key_values</code> 中</p></li></ul><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span><span class=lnt id=hl-0-21><a class=lnlinks href=#hl-0-21>21</a>
</span><span class=lnt id=hl-0-22><a class=lnlinks href=#hl-0-22>22</a>
</span><span class=lnt id=hl-0-23><a class=lnlinks href=#hl-0-23>23</a>
</span><span class=lnt id=hl-0-24><a class=lnlinks href=#hl-0-24>24</a>
</span><span class=lnt id=hl-0-25><a class=lnlinks href=#hl-0-25>25</a>
</span><span class=lnt id=hl-0-26><a class=lnlinks href=#hl-0-26>26</a>
</span><span class=lnt id=hl-0-27><a class=lnlinks href=#hl-0-27>27</a>
</span><span class=lnt id=hl-0-28><a class=lnlinks href=#hl-0-28>28</a>
</span><span class=lnt id=hl-0-29><a class=lnlinks href=#hl-0-29>29</a>
</span><span class=lnt id=hl-0-30><a class=lnlinks href=#hl-0-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># query:[B, H, 1, H_D]</span>
</span></span><span class=line><span class=cl><span class=c1># key:[B, H, L+1, H_D]</span>
</span></span><span class=line><span class=cl><span class=c1># value:[B, H, L+1, H_D]</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>layer_past</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>past_key</span> <span class=o>=</span> <span class=n>layer_past</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>past_value</span> <span class=o>=</span> <span class=n>layer_past</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>key</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>((</span><span class=n>past_key</span><span class=p>,</span> <span class=n>key</span><span class=p>),</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>((</span><span class=n>past_value</span><span class=p>,</span> <span class=n>value</span><span class=p>),</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>use_cache</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>present</span> <span class=o>=</span> <span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>present</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1># attn_weights:[B, H, 1, L+1]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>key</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># causal mask</span>
</span></span><span class=line><span class=cl><span class=n>mask_value</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>tensor</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>finfo</span><span class=p>(</span><span class=n>attn_weights</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span><span class=o>.</span><span class=n>min</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>causal_mask</span><span class=p>,</span> <span class=n>attn_weights</span><span class=p>,</span> <span class=n>mask_value</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Softmax</span><span class=p>(</span><span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)(</span><span class=n>attn_weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># attn_output: [B, H, 1, H_D]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>attn_weights</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># merge head:[B, 1, D]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_merge_heads</span><span class=p>(</span><span class=n>attn_output</span><span class=p>,</span> <span class=n>num_attention_heads</span><span class=p>,</span> <span class=n>head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>use_cache</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>presents</span> <span class=o>=</span> <span class=n>presents</span> <span class=o>+</span> <span class=p>(</span><span class=n>outputs</span><span class=p>[</span><span class=mi>1</span><span class=p>],)</span></span></span></code></pre></td></tr></table></div></div></div><h3 id=kv-cache-参数量估计 class=heading>KV Cache 参数量估计<a href=#kv-cache-%e5%8f%82%e6%95%b0%e9%87%8f%e4%bc%b0%e8%ae%a1 aria-labelledby=kv-cache-参数量估计><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi></mrow><annotation encoding="application/x-tex">L</annotation></semantics></math></span>
</span>：输入序列长度</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span>
</span>：输入序列长度</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span>
</span>：hidden_size</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>l</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">l_n</annotation></semantics></math></span>
</span>：层数</li></ul><hr><ul><li>如果以 float16 保存（2 个字节表示一个数），占用的显存为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>⋅</mo><mi>B</mi><mo stretchy="false">(</mo><mi>L</mi><mo>+</mo><mi>N</mi><mo stretchy="false">)</mo><mi>d</mi><msub><mi>l</mi><mi>n</mi></msub><mo>⋅</mo><mn>2</mn></mrow><annotation encoding="application/x-tex">2 \cdot B(L+N)dl_n \cdot 2</annotation></semantics></math></span></span></li><li>如果以 float32 保存（4 个字节表示一个数），占用的显存为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>⋅</mo><mi>B</mi><mo stretchy="false">(</mo><mi>L</mi><mo>+</mo><mi>N</mi><mo stretchy="false">)</mo><mi>d</mi><msub><mi>l</mi><mi>n</mi></msub><mo>⋅</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">2 \cdot B(L+N)dl_n \cdot 4</annotation></semantics></math></span></span></li></ul><h3 id=kv-cache-降低的重要性 class=heading>KV Cache 降低的重要性<a href=#kv-cache-%e9%99%8d%e4%bd%8e%e7%9a%84%e9%87%8d%e8%a6%81%e6%80%a7 aria-labelledby=kv-cache-降低的重要性><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>使用 GPU 进行推理时，单张 GPU 的显存是有限的。</p><p>一部分用来存放模型的参数和前向计算的激活值，这部分依赖于模型的体量，选定模型后它就是个常数；</p><p>另外一部分用来存放模型的 <code>KV Cache</code>，由 1.2 知道，<code>KV Cache</code> 依赖于 <strong>模型的体量</strong> 和 <strong>模型的输入长度</strong>，在推理过程中 <strong>动态增长</strong>，当 Context 长度足够长时，它的大小就会占主导地位，可能超出一张卡甚至一台机（8 张卡）的总显存量。</p><p><strong>减少 <code>KV Cache</code> 的目的: 实现更快的推理速度或者更大的吞吐总量，实现更低的推理成本</strong></p><ol><li>更少的设备上推理更长的 Context</li><li>相同的 Context 长度下让推理的 batch size 更大</li></ol><h2 id=mha--mqa--gqa--mla class=heading>MHA & MQA & GQA & MLA<a href=#mha--mqa--gqa--mla aria-labelledby=mha--mqa--gqa--mla><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h2><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span>
</span>：hidden size</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">n_h</annotation></semantics></math></span>
</span>：头数</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_h</annotation></semantics></math></span>
</span>：每个头的维度</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span>
</span>：block 层数</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{h}_t \in \mathbb{R}^d</annotation></semantics></math></span>
</span>: 第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span>
</span>个 token 的 hidden state</li></ul><h3 id=mha class=heading>MHA<a href=#mha aria-labelledby=mha><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">k</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left [\mathbf{q}_{t}^1;\mathbf{q}_{t}^2;...;\mathbf{q}_{t}^{n_h} \right]=\mathbf{q}_t = \mathbf{h}_t \mathbf{W}^Q\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{q}_{t}^{i}\in \mathbb{R}^{d_h}, \quad \mathbf{W}^Q\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left [\mathbf{k}_{t}^1;\mathbf{k}_{t}^2;...;\mathbf{k}_{t}^{n_h}\right]=\mathbf{k}_t = \mathbf{h}_t \mathbf{W}^K \in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{k}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^K\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left[\mathbf{v}_{t}^1;\mathbf{v}_{t}^2;...;\mathbf{v}_{t}^{n_h}\right]=\mathbf{v}_t = \mathbf{h}_t \mathbf{W}^V\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{v}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^V\in \mathbb{R}^{d \times d_h \cdot n_h}
\end{align}
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{q}_{t}^{i}</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{k}_{t}^{i}</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{v}_{t}^{i}</annotation></semantics></math></span>
</span>表示第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
</span>个注意力头的查询、键和值。</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>n</mi><mi>h</mi></msub></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">u</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
&amp;\mathbf{o}_t =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \in \mathbb{R}^{d_h\cdot n_h}\\[7pt]
&amp;\mathbf{o}_{t}^{i}=\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^{i} {}^{\top}}{\sqrt{d_h}})\mathbf{v}_{j}^{i} \in \mathbb{R}^{n_h} \\[7pt]
&amp;\mathbf{u}_t =\mathbf{o}_t\mathbf{W}^O =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \mathbf{W}^O  \in \mathbb{R}^{d}, \quad \mathbf{W}^O \in \mathbb{R}^{d_h \cdot n_h\times d}
\end{align}
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^O  </annotation></semantics></math></span>
</span>表示输出投影矩阵</li></ul><p>在推断阶段，所有 <code>key</code> 和 <code>value</code> 都必须被缓存起来以加快推断速度(KV Cache)。</p><p><strong>因此对于每一个 token 来说，<code>MHA</code> 需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msub><mi>n</mi><mi>h</mi></msub><msub><mi>d</mi><mi>h</mi></msub><mi>l</mi></mrow><annotation encoding="application/x-tex">2n_hd_hl</annotation></semantics></math></span>
</span>个元素</strong>。</p><p>在模型部署中，KV Cache 成为了制约最大批次大小以及序列长度的一个大瓶颈。</p><p><code>KV Cache</code>：在 token by token 递归生成时，新预测出来的第
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">t+1</annotation></semantics></math></span>
</span>个 token，并不会影响到已经算好的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>k</mi><mrow><mo>≤</mo><mi>t</mi></mrow><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">k^{i}_{\le t}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>v</mi><mrow><mo>≤</mo><mi>t</mi></mrow><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">v^{i}_{\le t}</annotation></semantics></math></span>
</span>，因此这部分结果我们可以缓存下来供后续生成调用，避免不必要的重复计算</p><h3 id=mqa class=heading>MQA<a href=#mqa aria-labelledby=mqa><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mo>∗</mo></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mo>∗</mo></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">k</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mo>∗</mo></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mo>∗</mo></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mo lspace="0em" rspace="0em">∗</mo></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left [\mathbf{q}_{t}^1;\mathbf{q}_{t}^2;...;\mathbf{q}_{t}^{n_h} \right]=\mathbf{q}_t = \mathbf{h}_t \mathbf{W}^Q\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{q}_{t}^{i}\in \mathbb{R}^{d_h}, \quad \mathbf{W}^Q\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left [\mathbf{k}_{t}^*;\mathbf{k}_{t}^*;...;\mathbf{k}_{t}^{*}\right] =\mathbf{k}_t = \mathbf{h}_t \mathbf{W}^K \in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{k}_{t}^{*} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^K\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left [\mathbf{v}_{t}^*;\mathbf{v}_{t}^*;...;\mathbf{v}_{t}^{*}\right] =\mathbf{v}_t = \mathbf{h}_t \mathbf{W}^V\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{v}_{t}^{*} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^V\in \mathbb{R}^{d \times d_h \cdot n_h}
\end{align}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mo>∗</mo></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mo>∗</mo></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>n</mi><mi>h</mi></msub></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">u</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
&amp;\mathbf{o}_t =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \in \mathbb{R}^{d_h\cdot n_h}\\[7pt]
&amp;\mathbf{o}_{t}^{i}=\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^* {}^{\top}}{\sqrt{d_h}})\mathbf{v}_{j}^* \in \mathbb{R}^{n_h} \\[7pt]
&amp;\mathbf{u}_t =\mathbf{o}_t\mathbf{W}^O =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \mathbf{W}^O  \in \mathbb{R}^{d}, \quad \mathbf{W}^O \in \mathbb{R}^{d_h \cdot n_h\times d}
\end{align}
</annotation></semantics></math></span></div><p><strong><code>MQA</code> 将 <code>KV Cache</code> 减少到了原来的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><msub><mi>n</mi><mi>h</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{1}{n_h}</annotation></semantics></math></span>
</span>, 对于每一个 token 来说，<code>MQA</code> 需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><msub><mi>d</mi><mi>h</mi></msub><mi>l</mi></mrow><annotation encoding="application/x-tex">2d_hl</annotation></semantics></math></span>
</span>个元素</strong> 。</p><p>效果方面，目前看来大部分任务的损失都比较有限，且 MQA 的支持者相信这部分损失可以通过进一步训练来弥补回。</p><p>此外，<code>MQA</code> 由于共享了 K、V，将会导致 Attention 的参数量减少了将近一半，而为了模型总参数量的不变，通常会相应地增大 FFN/GLU 的规模，这也能弥补一部分效果损失。</p><h3 id=gqa class=heading>GQA<a href=#gqa aria-labelledby=gqa><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p><code>GQA</code> 将所有 Head 分为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span>
</span>个组（
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span>
</span>可以整除
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">n_h</annotation></semantics></math></span>
</span>），每组共享同一对
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span></span></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><munder><munder><mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>1</mn></msubsup></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">⌈</mo><mfrac><msub><mi>n</mi><mi>h</mi></msub><mi>g</mi></mfrac><mo stretchy="false">⌉</mo></mrow></munder><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><munder><munder><mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>g</mi></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>g</mi></msubsup></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">⌈</mo><mfrac><msub><mi>n</mi><mi>h</mi></msub><mi>g</mi></mfrac><mo stretchy="false">⌉</mo></mrow></munder><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">k</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>K</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><munder><munder><mrow><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>1</mn></msubsup></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">⌈</mo><mfrac><msub><mi>n</mi><mi>h</mi></msub><mi>g</mi></mfrac><mo stretchy="false">⌉</mo></mrow></munder><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><munder><munder><mrow><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>g</mi></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>g</mi></msubsup></mrow><mo stretchy="true">⏟</mo></munder><mrow><mo stretchy="false">⌈</mo><mfrac><msub><mi>n</mi><mi>h</mi></msub><mi>g</mi></mfrac><mo stretchy="false">⌉</mo></mrow></munder><mo fence="true">]</mo></mrow><mo>=</mo><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>V</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left [\mathbf{q}_{t}^1;\mathbf{q}_{t}^2;...;\mathbf{q}_{t}^{n_h} \right]=\mathbf{q}_t = \mathbf{h}_t \mathbf{W}^Q\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{q}_{t}^{i}\in \mathbb{R}^{d_h}, \quad \mathbf{W}^Q\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left[
\underbrace{\mathbf{k}_{t}^1;\cdots;\mathbf{k}_{t}^1}_{\lceil \frac{n_h}{g} \rceil};
\cdots\ \underbrace{\mathbf{k}_{t}^g;\cdots;\mathbf{k}_{t}^g}_{\lceil \frac{n_h}{g} \rceil}
\right]
=\mathbf{k}_t
= \mathbf{h}_t \mathbf{W}^K \in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{k}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^K\in \mathbb{R}^{d \times d_h \cdot n_h}\\[7pt]
\left[
\underbrace{\mathbf{v}_{t}^1;\cdots;\mathbf{v}_{t}^1}_{\lceil \frac{n_h}{g} \rceil};
\cdots\ \underbrace{\mathbf{v}_{t}^g;\cdots;\mathbf{v}_{t}^g}_{\lceil \frac{n_h}{g} \rceil}
\right]
=\mathbf{v}_t = \mathbf{h}_t \mathbf{W}^V\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{v}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^V\in \mathbb{R}^{d \times d_h \cdot n_h}
\end{align}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>n</mi><mi>h</mi></msub></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">u</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
&amp;\mathbf{o}_t =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \in \mathbb{R}^{d_h\cdot n_h}\\[7pt]
&amp;\mathbf{o}_{t}^{i}=\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{d_h}})\mathbf{v}_{j}^i \in \mathbb{R}^{n_h} \\[7pt]
&amp;\mathbf{u}_t =\mathbf{o}_t\mathbf{W}^O =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \mathbf{W}^O  \in \mathbb{R}^{d}, \quad \mathbf{W}^O \in \mathbb{R}^{d_h \cdot n_h\times d}
\end{align}
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">g=n_h</annotation></semantics></math></span>
</span>：<code>MHA</code></li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">g=1</annotation></semantics></math></span>
</span>：<code>MQA</code></li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>&lt;</mo><mi>g</mi><mo>&lt;</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">1&lt;g&lt;n_h</annotation></semantics></math></span>
</span>：<code>KV Cache</code> 减少到了原来的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mi>g</mi><msub><mi>n</mi><mi>h</mi></msub></mfrac></mrow><annotation encoding="application/x-tex">\frac{g}{n_h}</annotation></semantics></math></span>
</span>。</li></ul><p><strong>对于每一个 token 来说，<code>GQA</code> 需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>g</mi><msub><mi>d</mi><mi>h</mi></msub><mi>l</mi></mrow><annotation encoding="application/x-tex">2gd_hl</annotation></semantics></math></span>
</span>个元素</strong></p><p>Llama2/3-70B 中，<code>GQA</code> 的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">g=8</annotation></semantics></math></span>
</span>，其他用了 GQA 的同体量模型基本上也保持了这个设置。由于 Attention 的每个 Head 实际上是独立运算然后拼接起来的，一般情况下对于一机 8 卡的配置，当
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi><mo>=</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">g=8</annotation></semantics></math></span>
</span>时，正好可以每张卡负责计算一组
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span>
</span>对应的 Attention Head，这样可以在尽可能保证
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span>
</span>多样性的同时最大程度上减少卡间通信。</p><h3 id=mla class=heading>MLA<a href=#mla aria-labelledby=mla><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h3><p>MLA 的核心是对 key 和 value 进行低秩联合压缩，减少 KV cache</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>Q</mi></msup><mo>∈</mo><msup><mi>R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">k</mi><mi>t</mi></msub><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>c</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>c</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left [\mathbf{q}_{t}^1;\mathbf{q}_{t}^2;...;\mathbf{q}_{t}^{n_h} \right]= &amp;\mathbf{q}_t = \mathbf{h}_t \mathbf{W}^Q\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{q}_{t}^{i}\in \mathbb{R}^{d_h}, \quad \mathbf{W}^Q\in {R}^{d \times d_h \cdot n_h}\\[7pt]
\left [\mathbf{k}_{t}^1;\mathbf{k}_{t}^2;...;\mathbf{k}_{t}^{n_h}\right]= &amp;\mathbf{k}_t = \mathbf{c}_t^{KV} \mathbf{W}^{UK} \in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{k}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^{UK}\in \mathbb{R}^{d_c \times d_h \cdot n_h}\\[7pt]
\left [\mathbf{v}_{t}^1;\mathbf{v}_{t}^2;...;\mathbf{v}_{t}^{n_h}\right]= &amp;\mathbf{v}_t = \mathbf{c}_t^{KV} \mathbf{W}^{UV}\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{v}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^{UV}\in \mathbb{R}^{d_c \times d_h \cdot n_h}\\[7pt]
&amp;\mathbf{c}_t^{KV} = \mathbf{h}_t \mathbf{W}^{DKV}\in\mathbb{R}^{d_c},\quad \mathbf{W}^{DKV}\in\mathbb{R}^{d\times d_c} 
\end{align}
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_{t}^{KV}</annotation></semantics></math></span>
</span>：keys 和 values 的压缩隐向量</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span>
</span>：KV 压缩维度，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>≪</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_c \ll d_h \cdot n_h</annotation></semantics></math></span></span></li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{DKV}</annotation></semantics></math></span>
</span>：down-projection 矩阵</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{UK}</annotation></semantics></math></span>
</span>,
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{UV}</annotation></semantics></math></span>
</span>：分别为 key 和 value 的 up-projection 矩阵</li></ul><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">u</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
&amp;\mathbf{o}_t =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \in \mathbb{R}^{d_h\cdot n_h}\\[7pt]
&amp;\mathbf{o}_{t}^{i}=\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{d_h}})\mathbf{v}_{j}^i \in \mathbb{R}^{d_h} \\[7pt]
&amp;\mathbf{u}_t =\mathbf{o}_t\mathbf{W}^O =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \mathbf{W}^O  \in \mathbb{R}^{d}, \quad \mathbf{W}^O \in \mathbb{R}^{d_h \cdot n_h\times d}
\end{align}
</annotation></semantics></math></span></div><hr><p><strong>推理阶段</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right" columnspacing=""><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo fence="true">)</mo></mrow><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo fence="true">)</mo></mrow><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>=</mo><munder><munder><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo fence="true">)</mo></mrow></mrow><mo stretchy="true">⏟</mo></munder><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><msup><mrow></mrow><mi>i</mi></msup></mrow></munder><munder><munder><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mo stretchy="true">⏟</mo></munder><mrow><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><msup><mrow></mrow><mi>i</mi></msup></mrow></munder><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msubsup><mi mathvariant="bold">u</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mi>i</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>=</mo><munder><munder><mrow><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>h</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><mo stretchy="true">⏟</mo></munder><mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><msup><mrow></mrow><mi>i</mi></msup></mrow></munder><munder><munder><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo fence="true">)</mo></mrow><mo stretchy="true">⏟</mo></munder><mrow><msup><mi mathvariant="bold">W</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><msup><mrow></mrow><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mrow></munder></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\mathbf{q}_t^{i} \mathbf{k}_j^{i}{}^{\top} = \left(\mathbf{h}_t\mathbf{W}^{Q, i}\right) \left(\mathbf{c}_j^{KV}\mathbf{W}^{UK, i}\right){}^{\top} = \underbrace{\mathbf{h}_t\left(\mathbf{W}^{Q, i}\mathbf{W}^{UK, i}{}^{\top}\right)}_{\mathbf{q}^{\prime}_t{}^i} \underbrace{\mathbf{c}_j^{KV}}_{\mathbf{k}^{\prime}_j{}^i}{}^{\top} \\[7pt]
\mathbf{u}_t^{i} = \mathbf{o}_{t}^{i}\mathbf{W}^{O, i} =\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{d_h}})\mathbf{v}_{j}^i \mathbf{W}^{O, i} = \underbrace{\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{d_h}})\mathbf{c}_j^{KV}}_{\mathbf{o}^{\prime}_t{}^i} \underbrace{\left(\mathbf{W}^{UV, i} \mathbf{W}^{O, i}\right)}_{\mathbf{W}^{\prime}{}^{O, i}}
\end{align}
</annotation></semantics></math></span></div><ul><li>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{Q,i}\mathbf{W}^{UK,i}{}^{\top}</annotation></semantics></math></span>
</span>合并作为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span>
</span>的投影矩阵，则
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_j^{KV}</annotation></semantics></math></span>
</span>取代了原本的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">k</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{k}_j</annotation></semantics></math></span></span></li><li>将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{UK,i} \mathbf{W}^{O,i}</annotation></semantics></math></span>
</span>合并作为输出投影矩阵，则
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_j^{KV}</annotation></semantics></math></span>
</span>取代了原本的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">v</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{v}_j</annotation></semantics></math></span></span></li></ul><p>此时，<code>MLA</code> 的 <code>KV Cache</code> 只需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>c</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf{c}^{KV}_t \in\mathbb{R}^{d_c}</annotation></semantics></math></span>
</span>, 而不是存下所有的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">k</mi><mi mathvariant="bold">t</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{k_t}, \mathbf{v}_t  \in \mathbb{R}^{d_h\cdot n_h}</annotation></semantics></math></span>
</span>。 注意到
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>≪</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_c \ll d_h \cdot n_h</annotation></semantics></math></span>
</span>，且
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}^{KV}_t</annotation></semantics></math></span>
</span>跟 head
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span>
</span>无关，即所有头共享，因此 <code>MLA</code> 在推理阶段可以恒等变换为一个 <code>MQA</code>。此外，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span>
</span>可以取更小的值，对 <code>KV Cache</code> 更进一步进行压缩。</p><p><strong>对于每一个 token 来说，<code>MLA</code> 需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mi>l</mi></mrow><annotation encoding="application/x-tex">d_cl</annotation></semantics></math></span>
</span>个元素。</strong></p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{Q,i}\mathbf{W}^{UK,i}{}^{\top}</annotation></semantics></math></span>
</span>合并成一个矩阵的恒等变换，<strong>理论上只有在无限精度下才成立</strong>，实际上如果我们使用单精度尤其是 BF16 的话，经过变换后的精度损失往往还是挺明显的，经过多层累积后可能放大到比较可观的程度，这里可能要根据实际误差看要不要做一些后处理。</p><hr><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\left [\mathbf{q}_{t}^1;\mathbf{q}_{t}^2;...;\mathbf{q}_{t}^{n_h} \right]=&amp;\mathbf{q}_t = \mathbf{c}_t^{Q} \mathbf{W}^{UQ}\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{q}_{t}^{i}\in \mathbb{R}^{d_h}, \quad \mathbf{W}^{UQ}\in \mathbb{R}^{d_c^{\prime} \times d_h \cdot n_h}\\[7pt]
&amp;\mathbf{c}_t^{Q} = \mathbf{h}_t \mathbf{W}^{DQ}\in\mathbb{R}^{d_c^{\prime}},\quad \mathbf{W}^{DQ}\in\mathbb{R}^{d\times d_c^{\prime}} \\
\end{align}
</annotation></semantics></math></span></div><ul><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_{t}^{Q}</annotation></semantics></math></span>
</span>：query 的压缩隐向量</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal">′</mo></msubsup></mrow><annotation encoding="application/x-tex">d_c^\prime</annotation></semantics></math></span>
</span>：query 压缩维度，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal">′</mo></msubsup><mo>≪</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_c^\prime \ll d_h \cdot n_h</annotation></semantics></math></span></span></li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{DQ}</annotation></semantics></math></span>
</span>： down-projection 矩阵</li><li><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UQ}</annotation></semantics></math></span>
</span>：up-projection 矩阵</li></ul><hr><p><strong>解耦 RoPE</strong></p><p><code>RoPE</code> 与位置相关，在 <code>MLA</code> 中加入 <code>ROPE</code> 时</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">(</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle><mo fence="true">)</mo></mrow><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>j</mi></msub></mstyle><mo fence="true">)</mo></mrow><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mrow><mo fence="true">(</mo><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mrow><mi>t</mi><mo>−</mo><mi>j</mi></mrow></msub></mstyle><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo fence="true">)</mo></mrow><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
\mathbf{q}_t^i &amp;= \mathbf{h}_t \mathbf{W}^{Q, i}\textcolor{#6D8E14}{\mathbf{\mathcal{R}}_t}\\[7pt]
\mathbf{k}_t^i &amp;= \mathbf{c}_t^{KV} \mathbf{W}^{UK, i} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_t} \\[7pt]
\mathbf{q}_t^{i} \mathbf{k}_j^{i}{}^{\top} &amp;= \left(\mathbf{h}_t\mathbf{W}^{Q, i}\textcolor{#6D8E14}{\mathbf{\mathcal{R}}_t} \right) \left( \mathbf{c}_j^{KV}\mathbf{W}^{UK, i} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_j} \right){}^{\top} = \mathbf{h}_t\left(\mathbf{W}^{Q, i} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_{t-j}}\mathbf{W}^{UK, i}{}^{\top}\right)
\mathbf{c}_j^{KV}\\[7pt]
\end{align}
</annotation></semantics></math></span></div><p>此时
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mrow><mi>t</mi><mo>−</mo><mi>j</mi></mrow></msub></mstyle><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{Q,i} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_{t-j}}\mathbf{W}^{UK,i}{}^{\top}</annotation></semantics></math></span>
</span>无法合并为一个固定的投影矩阵，因为这时
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mrow><mi>t</mi><mo>−</mo><mi>j</mi></mrow></msub></mstyle><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{W}^{Q,i} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_{t-j}}\mathbf{W}^{UK,i}{}^{\top}</annotation></semantics></math></span>
</span>跟位置差
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>−</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">t-j</annotation></semantics></math></span>
</span>相关。</p><p>每个 Attention Head 的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span>
</span>、
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span>新增
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d_h^R</annotation></semantics></math></span>
</span>个维度用来添加 <code>RoPE</code>，其中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span>
</span><strong>新增的维度每个 Head 共享</strong>：</p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>C</mi></msubsup><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mi>i</mi></mrow></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi>R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup><mo separator="true">;</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">;</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>R</mi></msubsup><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup><mo>∈</mo><msup><mi>R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">;</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">;</mo><mo>⋯</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mrow><mi>R</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp;\mathbf{c}_t^{Q} = \mathbf{h}_t \mathbf{W}^{DQ}\in\mathbb{R}^{d_c^{\prime}},\quad \mathbf{W}^{DQ}\in\mathbb{R}^{d\times d_c^{\prime}}\\[7pt]
\left[\mathbf{q}_{t}^{C,1};\mathbf{q}_{t}^{C,2};\cdots;\mathbf{q}_{t}^{C, n_h} \right]
= &amp;\mathbf{q}_t^C 
= \mathbf{c}_t^Q \mathbf{W}^{UQ} \in \mathbb{R}^{d_h\cdot n_h}, 
\quad \mathbf{q}_{t}^{C, i}\in \mathbb{R}^{d_h}, 
\quad \mathbf{W}^{UQ}\in {R}^{d_c^{\prime} \times d_h \cdot n_h}\\[7pt]
\left[\mathbf{q}_{t}^{R,1};\mathbf{q}_{t}^{R,2};\cdots;\mathbf{q}_{t}^{R, n_h} \right]= 
&amp;\mathbf{q}_t^R = \mathbf{c}_t^Q \mathbf{W}^{QR} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_t} \in \mathbb{R}^{d_h^R\cdot n_h}, \quad \mathbf{q}_{t}^{R, i}\in \mathbb{R}^{d_h^R}, \quad \mathbf{W}^{QR}\in {R}^{d_c^{\prime} \times d_h^R \cdot n_h}\\[7pt]
\left[
\begin{pmatrix}\mathbf{q}_{t}^{C,1} &amp; \mathbf{q}_{t}^{R,1} \end{pmatrix};
\begin{pmatrix}\mathbf{q}_{t}^{C,2} &amp; \mathbf{q}_{t}^{R,2} \end{pmatrix}; \cdots
\begin{pmatrix}\mathbf{q}_{t}^{C, n_h} &amp; \mathbf{q}_{t}^{R, n_h} \end{pmatrix}
\right]
=&amp;\mathbf{q}_{t} \in \mathbb{R}^{(d_h+d_h^R)\cdot n_h} \\
\end{aligned}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>c</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>c</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>C</mi></msubsup><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mi>i</mi></mrow></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>R</mi></msubsup><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>1</mn></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>R</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">;</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><mn>2</mn></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>R</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo separator="true">;</mo><mo>⋯</mo><mrow><mo fence="true">(</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mrow><mi>C</mi><mo separator="true">,</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>R</mi></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">)</mo></mrow><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">k</mi><mi>t</mi></msub><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">;</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">;</mo><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>=</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">v</mi><mi>t</mi></msub><mo>=</mo><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msubsup><mi mathvariant="bold">v</mi><mi>t</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
&amp;\mathbf{c}_t^{KV} = \mathbf{h}_t \mathbf{W}^{DKV}\in\mathbb{R}^{d_c},\quad \mathbf{W}^{DKV}\in\mathbb{R}^{d\times d_c} \\[7pt]
\left [\mathbf{k}_{t}^{C,1};\mathbf{k}_{t}^{C,2};...;\mathbf{k}_{t}^{C, n_h}\right]= &amp;\mathbf{k}_t^C = \mathbf{c}_t^{KV} \mathbf{W}^{UK} \in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{k}_{t}^{C, i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^{UK}\in \mathbb{R}^{d_c \times d_h \cdot n_h}\\[7pt]
&amp;\mathbf{k}_t^R = \mathbf{h}_t  \mathbf{W}^{KR} \textcolor{#6D8E14}{\mathbf{\mathcal{R}}_t} \in \mathbb{R}^{d_h^R},  \quad \mathbf{W}^{KR}\in \mathbb{R}^{d \times d_h^R}\\[7pt]
\left[
\begin{pmatrix}\mathbf{k}_{t}^{C,1} &amp; \mathbf{k}_{t}^{R} \end{pmatrix};
\begin{pmatrix}\mathbf{k}_{t}^{C,2} &amp; \mathbf{k}_{t}^{R} \end{pmatrix}; \cdots
\begin{pmatrix}\mathbf{k}_{t}^{C, n_h} &amp; \mathbf{k}_{t}^{R} \end{pmatrix}
\right]
=&amp;\mathbf{k}_{t} \in \mathbb{R}^{(d_h+d_h^R)\cdot n_h}\\[10pt]
\left [\mathbf{v}_{t}^1;\mathbf{v}_{t}^2;...;\mathbf{v}_{t}^{n_h}\right]= &amp;\mathbf{v}_t = \mathbf{c}_t^{KV} \mathbf{W}^{UV}\in \mathbb{R}^{d_h\cdot n_h}, \quad \mathbf{v}_{t}^{i} \in \mathbb{R}^{d_h}, \quad \mathbf{W}^{UV}\in \mathbb{R}^{d_c \times d_h \cdot n_h}\\[7pt]
\end{aligned}
</annotation></semantics></math></span></div><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo></mrow></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">v</mi><mi>j</mi><mi>i</mi></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>h</mi></msub></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><msub><mi mathvariant="bold">u</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">o</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>=</mo><mrow><mo fence="true">[</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>1</mn></msubsup><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mn>2</mn></msubsup><mo separator="true">,</mo><mo>⋯</mo><mtext> </mtext><mo separator="true">,</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><msub><mi>n</mi><mi>h</mi></msub></msubsup><mo fence="true">]</mo></mrow><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mi>d</mi></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub><mo>×</mo><mi>d</mi></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align}
&amp;\mathbf{o}_t =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \in \mathbb{R}^{d_h\cdot n_h}\\[7pt]
&amp;\mathbf{o}_{t}^{i}=\sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{(d_h+d_h^R)}})\mathbf{v}_{j}^i \in \mathbb{R}^{d_h} \\[7pt]
&amp;\mathbf{u}_t =\mathbf{o}_t\mathbf{W}^O =\left [\mathbf{o}_t^1, \mathbf{o}_t^{2}, \cdots, \mathbf{o}_t^{n_h}\right] \mathbf{W}^O  \in \mathbb{R}^{d}, \quad \mathbf{W}^O \in \mathbb{R}^{d_h \cdot n_h\times d}
\end{align}
</annotation></semantics></math></span></div><ul><li>没有 <code>RoPE</code> 的维度（
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>C</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{q}_{t}^{C}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>C</mi></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{k}_{t}^{C}</annotation></semantics></math></span>
</span>） 就可以重复之前的操作，在推理时 <code>KV Cache</code> 只需要存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>c</mi></msub></msup></mrow><annotation encoding="application/x-tex">\mathbf{c}^{KV}_t \in\mathbb{R}^{d_c}</annotation></semantics></math></span>
</span>，</li><li>新增的带 <code>RoPE</code> 的维度就可以用来补充位置信息，并且由于所有 Head 共享，所以只在 K Cache 这里增加了
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d_h^R</annotation></semantics></math></span></span></li></ul><p>对于每一个 token 来说，加入 <code>RoPE</code> 的 <code>MLA</code> 需要缓存
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>c</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo><mi>l</mi></mrow><annotation encoding="application/x-tex">(d_c+d_h^R)l</annotation></semantics></math></span>
</span>个元素</p><p>对于 DeepSeek-V2，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span>
</span>设置为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><msub><mi>d</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">4d_h</annotation></semantics></math></span>
</span>，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d^R_h</annotation></semantics></math></span>
</span>设置为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><msub><mi>d</mi><mi>h</mi></msub><mn>2</mn></mfrac></mrow><annotation encoding="application/x-tex">\frac{d_h}{2}</annotation></semantics></math></span>
</span>。</p><hr><p><strong>Forward</strong></p><p><strong>DeepSeek-V2 参数</strong></p><table class=table><thead><tr><th></th><th></th><th>Config</th><th>Value</th></tr></thead><tbody><tr><td><strong>hidden_size</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span></span></td><td><code>hidden_size</code></td><td>5120</td></tr><tr><td><strong>头数</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">n_h</annotation></semantics></math></span></span></td><td><code>num_attention_heads</code></td><td>128</td></tr><tr><td><strong>Key Value 压缩维度</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span></span></td><td><code>kv_lora_rank</code></td><td>512</td></tr><tr><td><strong>Query 压缩维度</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal">′</mo></msubsup></mrow><annotation encoding="application/x-tex">d_c^\prime</annotation></semantics></math></span></span></td><td><code>q_lora_rank</code></td><td>1536</td></tr><tr><td><strong>head_size</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_h</annotation></semantics></math></span></span></td><td><code>qk_nope_head_dim</code></td><td>128</td></tr><tr><td><strong>RoPE 新增 head_size</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d_h^R</annotation></semantics></math></span></span></td><td><code>qk_rope_head_dim</code></td><td>64</td></tr><tr><td><strong>value head_size</strong></td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_h</annotation></semantics></math></span></span></td><td><code>v_head_dim</code></td><td>128</td></tr></tbody></table><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><msub><mi>d</mi><mi>c</mi></msub></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msub><mi>d</mi><mi>c</mi></msub></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align} 
\mathbf{c}_t^{Q} &amp;= \mathbf{h}_t \mathbf{W}^{DQ}\in\mathbb{R}^{d_c^{\prime}},\quad \mathbf{W}^{DQ}\in\mathbb{R}^{d\times d_c^{\prime}}\\[7pt]
\mathbf{c}_t^{KV} &amp;= \mathbf{h}_t \mathbf{W}^{DKV}\in\mathbb{R}^{d_c},\quad \mathbf{W}^{DKV}\in\mathbb{R}^{d\times d_c} 
\end{align}
</annotation></semantics></math></span></div><hr><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mstyle mathcolor="#86422F"><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mstyle></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow></msup><mo separator="true">,</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mstyle mathcolor="#86422F"><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mstyle></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">u</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo></mrow></msqrt></mfrac><mo stretchy="false">)</mo><mrow><mo fence="true">(</mo><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mo fence="true">)</mo></mrow><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align} 
\mathbf{q}_t^{i} &amp;= 
\begin{bmatrix}
\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}} 
&amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
\end{bmatrix}
\in\mathbb{R}^{\textcolor{#86422F}{d_h + d_h^R}},\quad \mathbf{W}^{UQ, i}\in\mathbb{R}^{d_c&#x27;\times d_h},
\quad \mathbf{W}^{QR, i}\in\mathbb{R}^{d_c&#x27;\times d_h^R},\\[7pt]
\mathbf{k}_t^{i} &amp;= 
\begin{bmatrix}
\mathbf{c}_t^{KV}\textcolor{#A54F08}{\mathbf{W}^{UK, i}}
&amp; \mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
\end{bmatrix}
\in\mathbb{R}^{\textcolor{#86422F}{d_h + d_h^R}},
\quad \mathbf{W}^{UK, i}\in\mathbb{R}^{d_c\times d_h},
\quad \mathbf{W}^{KR} \in\mathbb{R}^{d\times d_h^R} \\[15pt] 
\mathbf{u}_t^{i} &amp;= \mathbf{o}_{t}^{i}\mathbf{W}^{O, i}  = \sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{(d_h+d_h^R)}})\left(\mathbf{c}_j^{KV} \textcolor{#A54F08}{\mathbf{W}^{UV, i}} \right)\textcolor{#A54F08}{\mathbf{W}^{O, i}}\\[7pt]
\end{align}
</annotation></semantics></math></span></div><hr><p><strong>推理阶段</strong></p><div class=mathjax-display><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>i</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mstyle mathcolor="#86422F"><msub><mi>d</mi><mi>c</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mstyle></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>×</mo><msub><mi>d</mi><mi>h</mi></msub></mrow></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msubsup><mi>d</mi><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msubsup><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow></msup><mo separator="true">,</mo></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">k</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mstyle mathcolor="#86422F"><msub><mi>d</mi><mi>c</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mstyle></msup><mo separator="true">,</mo><mspace width="1em"/><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>d</mi><mo>×</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow></msup></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr><mtr><mtd class ="mtr-glue"></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><msubsup><mi mathvariant="bold">u</mi><mi>t</mi><mi>i</mi></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><msubsup><mi mathvariant="bold">o</mi><mi>t</mi><mi>i</mi></msubsup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><mo>=</mo><munderover><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>t</mi></munderover><msub><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mi>j</mi></msub><mo stretchy="false">(</mo><mfrac><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><msqrt><mrow><mo stretchy="false">(</mo><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup><mo stretchy="false">)</mo></mrow></msqrt></mfrac><mo stretchy="false">)</mo><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mrow><mo fence="true">(</mo><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>O</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mo fence="true">)</mo></mrow></mrow></mstyle></mtd><mtd class ="mtr-glue"></mtd><mtd class ="mml-eqn-num"></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{align} 
\mathbf{q}_t^{i} &amp;= 
\begin{bmatrix}
\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}\mathbf{W}^{UK, i}{}^{\top}} 
&amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_i}
\end{bmatrix}
\in\mathbb{R}^{\textcolor{#86422F}{d_c + d_h^R}},
\quad \mathbf{W}^{UQ, i}\in\mathbb{R}^{d_c&#x27;\times d_h},
\quad \mathbf{W}^{UK, i}\in\mathbb{R}^{d_c\times d_h},
\quad \mathbf{W}^{QR, i}\in\mathbb{R}^{d_c&#x27;\times d_h^R},
\\[7pt]
\mathbf{k}_t^{i} &amp;= 
\begin{bmatrix}
\mathbf{c}_t^{KV} 
&amp; \mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
\end{bmatrix}
\in\mathbb{R}^{\textcolor{#86422F}{d_c + d_h^R}},
\quad \mathbf{W}^{KR} \in\mathbb{R}^{d\times d_h^R} 
\\[15pt] 
\mathbf{u}_t^{i} &amp;= \mathbf{o}_{t}^{i}\mathbf{W}^{O, i}  = \sum_{j = 1}^t\mathrm{Softmax}_j(\frac{\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}}{\sqrt{(d_h+d_h^R)}})\mathbf{c}_j^{KV} \left(\textcolor{#A54F08}{\mathbf{W}^{UV, i} \mathbf{W}^{O, i}}\right)\\[7pt]
\end{align}
</annotation></semantics></math></span></div><ul><li>计算
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>i</mi></msubsup><msubsup><mi mathvariant="bold">k</mi><mi>j</mi><mi>i</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q}_{t}^{i}\mathbf{k}_{j}^i {}^{\top}</annotation></semantics></math></span>
</span>时，<strong>训练阶段</strong> 与 <strong>推理阶段</strong> 的 head_size 分别为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d_h+d_h^R</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>+</mo><msubsup><mi>d</mi><mi>h</mi><mi>R</mi></msubsup></mrow><annotation encoding="application/x-tex">d_c+d_h^R</annotation></semantics></math></span>
</span>, 虽然在 DeepSeek-V2 中
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub><mo>&lt;</mo><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_h&lt;d_c</annotation></semantics></math></span>
</span>, <strong>即推理时的计算量 > 训练时的计算量</strong>，但 <code>KV Cache</code> 的减少降低了显存和带宽的压力，推理速度还是能得到提升。</li><li>通常的 LLM 架构有
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><msub><mi>d</mi><mi>h</mi></msub><mo>⋅</mo><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d  = d_h\cdot n_h</annotation></semantics></math></span>
</span>，但是 DeepSeek-V2 的
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">n_h</annotation></semantics></math></span>
</span>更大。这是因为 MLA 的 <code>KV Cache大小</code> 跟
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span>
</span>无关，增大
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span>
</span>只会增加计算量和提升模型能力，但不会增加 <code>KV Cache</code>，所以不会带来速度瓶颈。</li></ul><hr><p><strong>Code</strong></p><p><a href=https://huggingface.co/deepseek-ai/DeepSeek-V2/blob/main/modeling_deepseek.py class=markdown-link>MLA 开源代码</a></p><ol><li>初始化<ul><li><code>q_a_proj</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>D</mi><mi>Q</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{DQ}</annotation></semantics></math></span></span></li><li><code>q_b_proj</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mi>W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><mo separator="true">,</mo><msup><mi>W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[W^{UQ}, W^{QR}]</annotation></semantics></math></span></span></li><li><code>kv_a_proj_with_mqa</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mi>W</mi><mrow><mi>D</mi><mi>K</mi><mi>V</mi></mrow></msup><mo separator="true">,</mo><msup><mi>W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[W^{DKV}, W^{KR}]</annotation></semantics></math></span></span></li><li><code>kv_b_proj</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><mo separator="true">,</mo><msup><mi>W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[W^{UK},W^{UV}]</annotation></semantics></math></span></span></li><li><code>o_proj</code>：
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">W^O</annotation></semantics></math></span></span></li></ul></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span><span class=lnt id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a>
</span><span class=lnt id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a>
</span><span class=lnt id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a>
</span><span class=lnt id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a>
</span><span class=lnt id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a>
</span><span class=lnt id=hl-1-21><a class=lnlinks href=#hl-1-21>21</a>
</span><span class=lnt id=hl-1-22><a class=lnlinks href=#hl-1-22>22</a>
</span><span class=lnt id=hl-1-23><a class=lnlinks href=#hl-1-23>23</a>
</span><span class=lnt id=hl-1-24><a class=lnlinks href=#hl-1-24>24</a>
</span><span class=lnt id=hl-1-25><a class=lnlinks href=#hl-1-25>25</a>
</span><span class=lnt id=hl-1-26><a class=lnlinks href=#hl-1-26>26</a>
</span><span class=lnt id=hl-1-27><a class=lnlinks href=#hl-1-27>27</a>
</span><span class=lnt id=hl-1-28><a class=lnlinks href=#hl-1-28>28</a>
</span><span class=lnt id=hl-1-29><a class=lnlinks href=#hl-1-29>29</a>
</span><span class=lnt id=hl-1-30><a class=lnlinks href=#hl-1-30>30</a>
</span><span class=lnt id=hl-1-31><a class=lnlinks href=#hl-1-31>31</a>
</span><span class=lnt id=hl-1-32><a class=lnlinks href=#hl-1-32>32</a>
</span><span class=lnt id=hl-1-33><a class=lnlinks href=#hl-1-33>33</a>
</span><span class=lnt id=hl-1-34><a class=lnlinks href=#hl-1-34>34</a>
</span><span class=lnt id=hl-1-35><a class=lnlinks href=#hl-1-35>35</a>
</span><span class=lnt id=hl-1-36><a class=lnlinks href=#hl-1-36>36</a>
</span><span class=lnt id=hl-1-37><a class=lnlinks href=#hl-1-37>37</a>
</span><span class=lnt id=hl-1-38><a class=lnlinks href=#hl-1-38>38</a>
</span><span class=lnt id=hl-1-39><a class=lnlinks href=#hl-1-39>39</a>
</span><span class=lnt id=hl-1-40><a class=lnlinks href=#hl-1-40>40</a>
</span><span class=lnt id=hl-1-41><a class=lnlinks href=#hl-1-41>41</a>
</span><span class=lnt id=hl-1-42><a class=lnlinks href=#hl-1-42>42</a>
</span><span class=lnt id=hl-1-43><a class=lnlinks href=#hl-1-43>43</a>
</span><span class=lnt id=hl-1-44><a class=lnlinks href=#hl-1-44>44</a>
</span><span class=lnt id=hl-1-45><a class=lnlinks href=#hl-1-45>45</a>
</span><span class=lnt id=hl-1-46><a class=lnlinks href=#hl-1-46>46</a>
</span><span class=lnt id=hl-1-47><a class=lnlinks href=#hl-1-47>47</a>
</span><span class=lnt id=hl-1-48><a class=lnlinks href=#hl-1-48>48</a>
</span><span class=lnt id=hl-1-49><a class=lnlinks href=#hl-1-49>49</a>
</span><span class=lnt id=hl-1-50><a class=lnlinks href=#hl-1-50>50</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># q_head_dim: d_h+d_h^R</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_lora_rank</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>q_proj</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1># W^{DQ}:[d, d_c&#39;]</span>
</span></span><span class=line><span class=cl>    <span class=c1># [5120, 1536]</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>.</span><span class=n>q_lora_rank</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>attention_bias</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span> <span class=o>=</span> <span class=n>DeepseekV2RMSNorm</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>q_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># [W^{UQ}, W^{QR}]:[d_c&#39;, n_h*(d_h+d_h^R)]</span>
</span></span><span class=line><span class=cl>    <span class=c1># [1536， 128*(128+64)]</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>config</span><span class=o>.</span><span class=n>q_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>,</span> <span class=n>bias</span><span class=o>=</span><span class=kc>False</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [W^{DKV}, W^{KR}]:[d, d_c+d_h^R]</span>
</span></span><span class=line><span class=cl><span class=c1># [5120， (512+64)]</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>kv_a_proj_with_mqa</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>kv_lora_rank</span> <span class=o>+</span> <span class=n>config</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bias</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>attention_bias</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>kv_a_layernorm</span> <span class=o>=</span> <span class=n>DeepseekV2RMSNorm</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [W^{UK},W^{UV}]:[d_c, n_h*(d_h+d_h)]</span>
</span></span><span class=line><span class=cl><span class=c1># [512, 128*(128+128)]</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>config</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>),</span>
</span></span><span class=line><span class=cl>    <span class=n>bias</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># W^O:[n_h*d_h, d]</span>
</span></span><span class=line><span class=cl><span class=c1># [128*128, 5120]</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>Linear</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>bias</span><span class=o>=</span><span class=n>config</span><span class=o>.</span><span class=n>attention_bias</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>_init_rope</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># softmax_scale: \sqrt{128+64}</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span> <span class=o>**</span> <span class=p>(</span><span class=o>-</span><span class=mf>0.5</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><ol start=2><li>计算 <code>q_nope</code> 和 <code>q_pe</code></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a>
</span><span class=lnt id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a>
</span><span class=lnt id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B,L，5120] -&gt; [B, L, 1536] -&gt;  [B, L，24576] = [B, L，128*(128+64)]</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span><span class=p>(</span><span class=n>hidden_states</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L，128*(128+64)] -&gt; [B, 128, L, (128+64)]</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128+64] -&gt; [B, 128, L, 128], [B, 128, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>q_nope</span><span class=p>,</span> <span class=n>q_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>   <span class=n>q</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><ol start=3><li>计算 <code>k_nope</code>, <code>k_pe</code> 和 <code>value_states</code></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span><span class=lnt id=hl-3-16><a class=lnlinks href=#hl-3-16>16</a>
</span><span class=lnt id=hl-3-17><a class=lnlinks href=#hl-3-17>17</a>
</span><span class=lnt id=hl-3-18><a class=lnlinks href=#hl-3-18>18</a>
</span><span class=lnt id=hl-3-19><a class=lnlinks href=#hl-3-19>19</a>
</span><span class=lnt id=hl-3-20><a class=lnlinks href=#hl-3-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B,L，5120] -&gt; [B, L, (512+64)]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_a_proj_with_mqa</span><span class=p>(</span><span class=n>hidden_states</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, (512+64)] -&gt; [B, L, 512], [B, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, 1, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 512] -&gt; [B, L, 128*(128+128)] -&gt; [B, 128, L, 128+128]</span>
</span></span><span class=line><span class=cl><span class=n>kv</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_a_layernorm</span><span class=p>(</span><span class=n>compressed_kv</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128+128] -&gt; [B, 128, L, 128], [B, 128, L, 128]</span>
</span></span><span class=line><span class=cl><span class=n>k_nope</span><span class=p>,</span> <span class=n>value_states</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><ol start=4><li>计算 <code>query_states</code> 和 <code>key_states</code></li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># RoPE</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>k_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>position_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128]+ [B, 128, L, 64] -&gt; [B, 128, L, (128+64)]</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>q_nope</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>q_pe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#  [B, 1, L, 64] -&gt; [B, 128, L, 64] </span>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128]+ [B, 128, L, 64] -&gt; [B, 128, L, (128+64)]</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>k_nope</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>k_pe</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, (128+64)] * [B, 128, (128+64), L] -&gt; [B, 128, L, L]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>query_states</span><span class=p>,</span> <span class=n>key_states</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><ol start=5><li>计算 attention</li></ol><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>attn_weights</span> <span class=o>+</span> <span class=n>attention_mask</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># upcast attention to fp32</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>query_states</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>dropout</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>p</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>attention_dropout</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>training</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, L] -&gt; [B, 128, L, 128]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>attn_weights</span><span class=p>,</span> <span class=n>value_states</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128] -&gt; [B, L, 128, 128]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>contiguous</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 128, 128] -&gt; [B, L, 128*128]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 128*128] -&gt; [B, L, 5120]</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=p>(</span><span class=n>attn_output</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><hr><p><a href=https://github.com/madsys-dev/deepseekv2-profile/tree/main/mla/impl class=markdown-link>MLA 模块优化</a></p><table class=table><thead><tr><th class=text-start>实现版本</th><th>KV Cache</th><th class=text-center>每 token 每层 Cache 大小</th><th class=text-center>每 token 每层计算量</th><th>描述</th></tr></thead><tbody><tr><td class=text-start>Cache Decompressed (CD)</td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{KV}\textcolor{#A54F08}{\mathbf{W}^{UK, i}} &amp; \mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span>+
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_j^{KV} \textcolor{#A54F08}{\mathbf{W}^{UV, i}} </annotation></semantics></math></span></span></td><td class=text-center>81.92 kB</td><td class=text-center>0.08 MFLOP</td><td>qkv 无融合<br>矩阵相乘</td></tr><tr><td class=text-start>Cache Compressed (CC)</td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span></span></td><td class=text-center>1.152 kB</td><td class=text-center>33.64 MFLOP</td><td>qkv 融合<br>矩阵相乘</td></tr><tr><td class=text-start>Absorbed Cache Compressed (A_CC)</td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span></span></td><td class=text-center>1.152 kB</td><td class=text-center>0.28 MFLOP</td><td>qkv 无融合<br>矩阵相乘</td></tr><tr><td class=text-start>Absorbed Cache Compressed Move Elision (A_CC_ME)</td><td><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span></span></td><td class=text-center>1.152 kB</td><td class=text-center>0.28 MFLOP</td><td>qkv 融合<br>MoveElision</td></tr></tbody></table><p>Cache Decompressed (CD)</p><ul><li><p><strong>KV Cache</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{KV}\textcolor{#A54F08}{\mathbf{W}^{UK, i}} &amp; \mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>j</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_j^{KV} \textcolor{#A54F08}{\mathbf{W}^{UV, i}}</annotation></semantics></math></span></span></p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>L</mi><mo>⋅</mo><mn>128</mn><mo>⋅</mo><mo stretchy="false">(</mo><mn>128</mn><mo>+</mo><mn>64</mn><mo>+</mo><mn>128</mn><mo stretchy="false">)</mo><mo>=</mo><mn>40960</mn><mo>⋅</mo><mi>B</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">BL\cdot 128 \cdot (128+64+128) = 40960 \cdot BL</annotation></semantics></math></span></span></p></li></ul><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B,L，5120] -&gt; [B, L, (512+64)]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_a_proj_with_mqa</span><span class=p>(</span><span class=n>hidden_states_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, (512+64)] -&gt; [B, L, 512], [B, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 512] -&gt; [B, L, 128*(128+128)] -&gt; [B, 128, L, 128+128]</span>
</span></span><span class=line><span class=cl><span class=n>kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_a_layernorm</span><span class=p>(</span><span class=n>compressed_kv</span><span class=p>))</span><span class=o>.</span><span class=n>view</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128], [B, 128, L, 128]</span>
</span></span><span class=line><span class=cl><span class=n>k_nope</span><span class=p>,</span> <span class=n>value_states</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>value_states</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>k_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>kv_position_ids</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128+64] </span>
</span></span><span class=line><span class=cl><span class=n>key_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>k_nope</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>k_pe</span></span></span></code></pre></td></tr></table></div></div></div><ul><li><p><strong>forward</strong></p><ul><li><p>计算 <code>q_nope</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}}</annotation></semantics></math></span>
</span>和 <code>q_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span></span></p><p>q = self.q_b_proj(self.q_a_layernorm(self.q_a_proj(hidden_states_q)))
q = q.view(bsz, q_len, self.num_heads, self.q_head_dim).transpose(1, 2)
q_nope, q_pe = torch.split(
q, [self.qk_nope_head_dim, self.qk_rope_head_dim], dim=-1
)</p><p>cos, sin = self.rotary_emb(q_pe)
q_pe = apply_rotary_pos_emb(q_pe, cos, sin, position_ids)</p></li><li><p><code>query_states</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}} &amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
        \end{bmatrix}</annotation></semantics></math></span>
</span>: <strong>[B, 128, L, 128+64]</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span><span class=lnt id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B, 128, L, 128+64]</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span> <span class=o>=</span> <span class=n>q_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>q_nope</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>q_pe</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>计算 attention</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1> 1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2> 2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3> 3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4> 4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5> 5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6> 6</a>
</span><span class=lnt id=hl-8-7><a class=lnlinks href=#hl-8-7> 7</a>
</span><span class=lnt id=hl-8-8><a class=lnlinks href=#hl-8-8> 8</a>
</span><span class=lnt id=hl-8-9><a class=lnlinks href=#hl-8-9> 9</a>
</span><span class=lnt id=hl-8-10><a class=lnlinks href=#hl-8-10>10</a>
</span><span class=lnt id=hl-8-11><a class=lnlinks href=#hl-8-11>11</a>
</span><span class=lnt id=hl-8-12><a class=lnlinks href=#hl-8-12>12</a>
</span><span class=lnt id=hl-8-13><a class=lnlinks href=#hl-8-13>13</a>
</span><span class=lnt id=hl-8-14><a class=lnlinks href=#hl-8-14>14</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 直接矩阵相乘 [B, 128, L, 128+64]*[B, 128, L, 128+64]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>query_states</span><span class=p>,</span> <span class=n>key_states</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>kv_seq_len</span> <span class=o>=</span> <span class=n>key_states</span><span class=o>.</span><span class=n>size</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># upcast attention to fp32</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>query_states</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>attn_weights</span><span class=p>,</span> <span class=n>value_states</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>contiguous</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=p>(</span><span class=n>attn_output</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li></ul></li></ul><hr><p><strong>Cache Compressed (CC)</strong></p><p>将 <code>RoPE</code> 后的 <code>k_pe</code> 一并缓存入 <code>KV Cache</code></p><ul><li><p><strong>KV Cache</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span></span></p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>L</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>512</mn><mo>+</mo><mn>64</mn><mo stretchy="false">)</mo><mo>=</mo><mn>576</mn><mo>⋅</mo><mi>B</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">BL \cdot (512+64) = 576 \cdot BL</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span><span class=lnt id=hl-9-12><a class=lnlinks href=#hl-9-12>12</a>
</span><span class=lnt id=hl-9-13><a class=lnlinks href=#hl-9-13>13</a>
</span><span class=lnt id=hl-9-14><a class=lnlinks href=#hl-9-14>14</a>
</span><span class=lnt id=hl-9-15><a class=lnlinks href=#hl-9-15>15</a>
</span><span class=lnt id=hl-9-16><a class=lnlinks href=#hl-9-16>16</a>
</span><span class=lnt id=hl-9-17><a class=lnlinks href=#hl-9-17>17</a>
</span><span class=lnt id=hl-9-18><a class=lnlinks href=#hl-9-18>18</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B,L，5120] -&gt; [B, L, (512+64)]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_a_proj_with_mqa</span><span class=p>(</span><span class=n>hidden_states_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, (512+64)] -&gt; [B, L, 512], [B, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 512]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_a_layernorm</span><span class=p>(</span><span class=n>compressed_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># [B, 1, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>k_pe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>k_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>kv_position_ids</span><span class=p>)</span><span class=o>.</span><span class=n>view</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 512+64]</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cat</span><span class=p>([</span><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><strong>forward</strong></p><ul><li><p>计算 <code>q_nope</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}}</annotation></semantics></math></span>
</span>和 <code>q_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span>
</span>: 同 Cache Decompressed (CD)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span><span class=lnt id=hl-10-4><a class=lnlinks href=#hl-10-4>4</a>
</span><span class=lnt id=hl-10-5><a class=lnlinks href=#hl-10-5>5</a>
</span><span class=lnt id=hl-10-6><a class=lnlinks href=#hl-10-6>6</a>
</span><span class=lnt id=hl-10-7><a class=lnlinks href=#hl-10-7>7</a>
</span><span class=lnt id=hl-10-8><a class=lnlinks href=#hl-10-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span><span class=p>(</span><span class=n>hidden_states_q</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_nope</span><span class=p>,</span> <span class=n>q_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>position_ids</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>展开 <code>compressed_kv</code> 得到</p><ul><li><code>compressed_kv</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{KV}</annotation></semantics></math></span></span></li><li><code>k_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span></span></li></ul><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 展开 compressed，得到 compressed_kv, k_pe</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>将 <code>kv_b_proj</code> 拆分为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UV}</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># kv_b_proj.weight:[W^{UK},W^{UV}]:[ n_h, (d_h+d_h), d_c]</span>
</span></span><span class=line><span class=cl><span class=c1># [128, (128+128), 512]</span>
</span></span><span class=line><span class=cl><span class=n>kv_b_proj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=o>.</span><span class=n>weight</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># W^{UK} 与 c_t^{Q} W^{UQ} 融合</span>
</span></span><span class=line><span class=cl><span class=n>q_absorb</span> <span class=o>=</span> <span class=n>kv_b_proj</span><span class=p>[:,</span> <span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=c1># W^{UV} 与 W^O 融合</span>
</span></span><span class=line><span class=cl><span class=n>out_absorb</span> <span class=o>=</span> <span class=n>kv_b_proj</span><span class=p>[:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:,</span> <span class=p>:]</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>query_states</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>i</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{Q}\textcolor{#A54F08}{{\mathbf{W}^{UQ, i}}\mathbf{W}^{UK, i}{}^{\top}} &amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_i}
        \end{bmatrix}</annotation></semantics></math></span>
</span>: <strong>[B, 128, L, 512+64]</strong></p><p><code>q_nope</code> 融合进 <code>q_absorb</code> :
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span><span class=lnt id=hl-13-4><a class=lnlinks href=#hl-13-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B, 128, 512+64]</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=n>qk_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;hdc,bhid-&gt;bhic&#39;</span><span class=p>,</span> <span class=n>q_absorb</span><span class=p>,</span> <span class=n>q_nope</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>:]</span> <span class=o>=</span> <span class=n>q_pe</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>key_states</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t} \end{bmatrix}</annotation></semantics></math></span>
</span>: <strong>[B, 128, L, 512+64]</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a>
</span><span class=lnt id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a>
</span><span class=lnt id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a>
</span><span class=lnt id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a>
</span><span class=lnt id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B, 128, 512+64]</span>
</span></span><span class=line><span class=cl><span class=n>qk_head_dim</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=n>qk_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>]</span> <span class=o>=</span> <span class=n>compressed_kv</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>:]</span> <span class=o>=</span> <span class=n>k_pe</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>计算 attention</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-15-1><a class=lnlinks href=#hl-15-1> 1</a>
</span><span class=lnt id=hl-15-2><a class=lnlinks href=#hl-15-2> 2</a>
</span><span class=lnt id=hl-15-3><a class=lnlinks href=#hl-15-3> 3</a>
</span><span class=lnt id=hl-15-4><a class=lnlinks href=#hl-15-4> 4</a>
</span><span class=lnt id=hl-15-5><a class=lnlinks href=#hl-15-5> 5</a>
</span><span class=lnt id=hl-15-6><a class=lnlinks href=#hl-15-6> 6</a>
</span><span class=lnt id=hl-15-7><a class=lnlinks href=#hl-15-7> 7</a>
</span><span class=lnt id=hl-15-8><a class=lnlinks href=#hl-15-8> 8</a>
</span><span class=lnt id=hl-15-9><a class=lnlinks href=#hl-15-9> 9</a>
</span><span class=lnt id=hl-15-10><a class=lnlinks href=#hl-15-10>10</a>
</span><span class=lnt id=hl-15-11><a class=lnlinks href=#hl-15-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 直接矩阵相乘 [B, 128, L, 512+64]*[B, 128, L, 512+64]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>query_states</span><span class=p>,</span> <span class=n>key_states</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># upcast attention to fp32</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>q_nope</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 与融合版v相乘</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bhql,blc-&gt;bhqc&#39;</span><span class=p>,</span> <span class=n>attn_weights</span><span class=p>,</span> <span class=n>compressed_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bhqc,hdc-&gt;bhqd&#39;</span><span class=p>,</span> <span class=n>attn_output</span><span class=p>,</span> <span class=n>out_absorb</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li></ul></li></ul><hr><p><strong>Absorbed Cache Compressed (A_CC)</strong></p><p>将 <code>RoPE</code> 后的 <code>k_pe</code> 一并缓存入 <code>KV Cache</code></p><ul><li><p><strong>KV Cache</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span>: 同 Cache Compressed (CC)</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>L</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>512</mn><mo>+</mo><mn>64</mn><mo stretchy="false">)</mo><mo>=</mo><mn>576</mn><mo>⋅</mo><mi>B</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">BL \cdot (512+64) = 576 \cdot BL</annotation></semantics></math></span></span></p></li><li><p><strong>forward</strong></p><ul><li><p>计算 <code>q_nope</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ}}</annotation></semantics></math></span>
</span>和 <code>q_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span>
</span>: 同 Cache Decompressed (CD)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a>
</span><span class=lnt id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a>
</span><span class=lnt id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a>
</span><span class=lnt id=hl-16-4><a class=lnlinks href=#hl-16-4>4</a>
</span><span class=lnt id=hl-16-5><a class=lnlinks href=#hl-16-5>5</a>
</span><span class=lnt id=hl-16-6><a class=lnlinks href=#hl-16-6>6</a>
</span><span class=lnt id=hl-16-7><a class=lnlinks href=#hl-16-7>7</a>
</span><span class=lnt id=hl-16-8><a class=lnlinks href=#hl-16-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span><span class=p>(</span><span class=n>hidden_states_q</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_nope</span><span class=p>,</span> <span class=n>q_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>position_ids</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>query_states</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ}} &amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
        \end{bmatrix}</annotation></semantics></math></span>
</span><strong>[B, 128, L, 128+64]</strong>: 同 Cache Decompressed (CD)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a>
</span><span class=lnt id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a>
</span><span class=lnt id=hl-17-3><a class=lnlinks href=#hl-17-3>3</a>
</span><span class=lnt id=hl-17-4><a class=lnlinks href=#hl-17-4>4</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># [B, 128, L, 128+64]</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span> <span class=o>=</span> <span class=n>q_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>q_nope</span>
</span></span><span class=line><span class=cl><span class=n>query_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>q_pe</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>key_states</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{KV}\textcolor{#A54F08}{\mathbf{W}^{UK}} &amp; \mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}
        \end{bmatrix}</annotation></semantics></math></span>
</span><strong>[B, 128, L, 128+64]</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-18-1><a class=lnlinks href=#hl-18-1> 1</a>
</span><span class=lnt id=hl-18-2><a class=lnlinks href=#hl-18-2> 2</a>
</span><span class=lnt id=hl-18-3><a class=lnlinks href=#hl-18-3> 3</a>
</span><span class=lnt id=hl-18-4><a class=lnlinks href=#hl-18-4> 4</a>
</span><span class=lnt id=hl-18-5><a class=lnlinks href=#hl-18-5> 5</a>
</span><span class=lnt id=hl-18-6><a class=lnlinks href=#hl-18-6> 6</a>
</span><span class=lnt id=hl-18-7><a class=lnlinks href=#hl-18-7> 7</a>
</span><span class=lnt id=hl-18-8><a class=lnlinks href=#hl-18-8> 8</a>
</span><span class=lnt id=hl-18-9><a class=lnlinks href=#hl-18-9> 9</a>
</span><span class=lnt id=hl-18-10><a class=lnlinks href=#hl-18-10>10</a>
</span><span class=lnt id=hl-18-11><a class=lnlinks href=#hl-18-11>11</a>
</span><span class=lnt id=hl-18-12><a class=lnlinks href=#hl-18-12>12</a>
</span><span class=lnt id=hl-18-13><a class=lnlinks href=#hl-18-13>13</a>
</span><span class=lnt id=hl-18-14><a class=lnlinks href=#hl-18-14>14</a>
</span><span class=lnt id=hl-18-15><a class=lnlinks href=#hl-18-15>15</a>
</span><span class=lnt id=hl-18-16><a class=lnlinks href=#hl-18-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>kv_seq_len</span> <span class=o>=</span> <span class=n>compressed_kv</span><span class=o>.</span><span class=n>size</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, (512+64)] -&gt; [B, L, 512], [B, L, 64]   </span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, L, 512] -&gt; [B, L, 128*(128+128)] -&gt; [B, 128, L, 128+128]</span>
</span></span><span class=line><span class=cl><span class=n>kv</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=p>(</span><span class=n>compressed_kv</span><span class=p>)</span><span class=o>.</span><span class=n>view</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># [B, 128, L, 128], [B, 128, L, 128]</span>
</span></span><span class=line><span class=cl><span class=n>k_nope</span><span class=p>,</span> <span class=n>value_states</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>key_states</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>new_empty</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>]</span> <span class=o>=</span> <span class=n>k_nope</span>
</span></span><span class=line><span class=cl><span class=n>key_states</span><span class=p>[:,</span> <span class=p>:,</span> <span class=p>:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:]</span> <span class=o>=</span> <span class=n>k_pe</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>计算 attention</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-19-1><a class=lnlinks href=#hl-19-1> 1</a>
</span><span class=lnt id=hl-19-2><a class=lnlinks href=#hl-19-2> 2</a>
</span><span class=lnt id=hl-19-3><a class=lnlinks href=#hl-19-3> 3</a>
</span><span class=lnt id=hl-19-4><a class=lnlinks href=#hl-19-4> 4</a>
</span><span class=lnt id=hl-19-5><a class=lnlinks href=#hl-19-5> 5</a>
</span><span class=lnt id=hl-19-6><a class=lnlinks href=#hl-19-6> 6</a>
</span><span class=lnt id=hl-19-7><a class=lnlinks href=#hl-19-7> 7</a>
</span><span class=lnt id=hl-19-8><a class=lnlinks href=#hl-19-8> 8</a>
</span><span class=lnt id=hl-19-9><a class=lnlinks href=#hl-19-9> 9</a>
</span><span class=lnt id=hl-19-10><a class=lnlinks href=#hl-19-10>10</a>
</span><span class=lnt id=hl-19-11><a class=lnlinks href=#hl-19-11>11</a>
</span><span class=lnt id=hl-19-12><a class=lnlinks href=#hl-19-12>12</a>
</span><span class=lnt id=hl-19-13><a class=lnlinks href=#hl-19-13>13</a>
</span><span class=lnt id=hl-19-14><a class=lnlinks href=#hl-19-14>14</a>
</span><span class=lnt id=hl-19-15><a class=lnlinks href=#hl-19-15>15</a>
</span><span class=lnt id=hl-19-16><a class=lnlinks href=#hl-19-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 直接矩阵相乘 [B, 128, L, 128+64]*[B, 128, L, 128+64]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>query_states</span><span class=p>,</span> <span class=n>key_states</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>))</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># avoid copying key-states</span>
</span></span><span class=line><span class=cl><span class=c1># attn_weights = torch.matmul(q_nope, k_nope.transpose(2, 3)) + torch.matmul(q_pe, k_pe.transpose(2, 3))</span>
</span></span><span class=line><span class=cl><span class=c1># attn_weights *= self.softmax_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># upcast attention to fp32</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>q_pe</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>attn_weights</span><span class=p>,</span> <span class=n>value_states</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>contiguous</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=p>(</span><span class=n>attn_output</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li></ul></li></ul><hr><p><strong>Absorbed Cache Compressed Move Elision (A_CC_ME)</strong></p><p>将 <code>RoPE</code> 后的 <code>k_pe</code> 一并缓存入 <code>KV Cache</code></p><ul><li><p><strong>KV Cache</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span>: 同 Cache Compressed (CC)</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>L</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>512</mn><mo>+</mo><mn>64</mn><mo stretchy="false">)</mo><mo>=</mo><mn>576</mn><mo>⋅</mo><mi>B</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">BL \cdot (512+64) = 576 \cdot BL</annotation></semantics></math></span></span></p></li><li><p><strong>forward</strong></p><ul><li><p>计算 <code>q_nope</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ}}</annotation></semantics></math></span>
</span>和 <code>q_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span>
</span>: 同 Cache Decompressed (CD)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a>
</span><span class=lnt id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a>
</span><span class=lnt id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a>
</span><span class=lnt id=hl-20-4><a class=lnlinks href=#hl-20-4>4</a>
</span><span class=lnt id=hl-20-5><a class=lnlinks href=#hl-20-5>5</a>
</span><span class=lnt id=hl-20-6><a class=lnlinks href=#hl-20-6>6</a>
</span><span class=lnt id=hl-20-7><a class=lnlinks href=#hl-20-7>7</a>
</span><span class=lnt id=hl-20-8><a class=lnlinks href=#hl-20-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span><span class=p>(</span><span class=n>hidden_states_q</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=n>q</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_nope</span><span class=p>,</span> <span class=n>q_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>q</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>position_ids</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>展开 <code>compressed_kv</code> 得到</p><ul><li><code>compressed_kv</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">\mathbf{c}_t^{KV}</annotation></semantics></math></span></span></li><li><code>k_pe</code>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow><annotation encoding="application/x-tex">\mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}</annotation></semantics></math></span></span></li></ul><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a>
</span><span class=lnt id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a>
</span><span class=lnt id=hl-21-3><a class=lnlinks href=#hl-21-3>3</a>
</span><span class=lnt id=hl-21-4><a class=lnlinks href=#hl-21-4>4</a>
</span><span class=lnt id=hl-21-5><a class=lnlinks href=#hl-21-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 展开 compressed，得到 compressed_kv, k_pe</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>将 <code>kv_b_proj</code> 拆分为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UV}</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a>
</span><span class=lnt id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a>
</span><span class=lnt id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a>
</span><span class=lnt id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a>
</span><span class=lnt id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a>
</span><span class=lnt id=hl-22-6><a class=lnlinks href=#hl-22-6>6</a>
</span><span class=lnt id=hl-22-7><a class=lnlinks href=#hl-22-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># kv_b_proj.weight:[W^{UK},W^{UV}]:[ n_h, (d_h+d_h), d_c]</span>
</span></span><span class=line><span class=cl><span class=c1># [128, (128+128), 512]</span>
</span></span><span class=line><span class=cl><span class=n>kv_b_proj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=o>.</span><span class=n>weight</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># W^{UK} 与 c_t^{Q} W^{UQ} 融合</span>
</span></span><span class=line><span class=cl><span class=n>q_absorb</span> <span class=o>=</span> <span class=n>kv_b_proj</span><span class=p>[:,</span> <span class=p>:</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=p>:]</span>
</span></span><span class=line><span class=cl><span class=c1># W^{UV} 与 W^O 融合</span>
</span></span><span class=line><span class=cl><span class=n>out_absorb</span> <span class=o>=</span> <span class=n>kv_b_proj</span><span class=p>[:,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>:,</span> <span class=p>:]</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>q_nope</code> 融合进 <code>q_absorb</code> :
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-23-1><a class=lnlinks href=#hl-23-1>1</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>q_nope</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>q_nope</span><span class=p>,</span> <span class=n>q_absorb</span><span class=p>)</span> </span></span></code></pre></td></tr></table></div></div></div></li><li><p>计算 attention</p><p><strong>MoveElision 优化策略</strong>: 省略此处的拼接 RoPE 部分和非 RoPE 部分的过程，而是直接分别计算量部分的额 Attention Score 并相加（考虑
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><msub><mi mathvariant="bold">k</mi><mi>j</mi></msub><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>=</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>C</mi></msubsup><msubsup><mi mathvariant="script">k</mi><mi>j</mi><mi>C</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>+</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>R</mi></msubsup><msubsup><mi>k</mi><mi>j</mi><mi>R</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q}_{t}\mathbf{k}_{j}{}^{\top} = \mathbf{q}_{t}^C \mathcal{k}_j^C{}^{\top}+ {\mathbf{q}_t^R} k_j^R{}^{\top}</annotation></semantics></math></span>
</span>)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a>
</span><span class=lnt id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a>
</span><span class=lnt id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a>
</span><span class=lnt id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a>
</span><span class=lnt id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a>
</span><span class=lnt id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a>
</span><span class=lnt id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a>
</span><span class=lnt id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a>
</span><span class=lnt id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a>
</span><span class=lnt id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a>
</span><span class=lnt id=hl-24-11><a class=lnlinks href=#hl-24-11>11</a>
</span><span class=lnt id=hl-24-12><a class=lnlinks href=#hl-24-12>12</a>
</span><span class=lnt id=hl-24-13><a class=lnlinks href=#hl-24-13>13</a>
</span><span class=lnt id=hl-24-14><a class=lnlinks href=#hl-24-14>14</a>
</span><span class=lnt id=hl-24-15><a class=lnlinks href=#hl-24-15>15</a>
</span><span class=lnt id=hl-24-16><a class=lnlinks href=#hl-24-16>16</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># MoveElision [B, 128, L, 512]*[B, 128, L, 512] + [B, 128, L, 64]*[B, 128, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>mT</span><span class=p>)</span> <span class=o>+</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>q_nope</span><span class=p>,</span> <span class=n>compressed_kv</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=o>-</span><span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>mT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># upcast attention to fp32</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>q_nope</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bhql,blc-&gt;bhqc&#39;</span><span class=p>,</span> <span class=n>attn_weights</span><span class=p>,</span> <span class=n>compressed_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># torch.einsum(&#39;bhqc,hdc-&gt;bhqd&#39;, attn_output, out_absorb)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>attn_output</span><span class=p>,</span> <span class=n>out_absorb</span><span class=o>.</span><span class=n>mT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>transpose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span><span class=o>.</span><span class=n>contiguous</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>attn_output</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=n>q_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=p>(</span><span class=n>attn_output</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li></ul></li></ul><hr><p><strong>Absorbed materialized Cache Compressed Move elision (AM_CC_ME)</strong></p><p>将 <code>RoPE</code> 后的 <code>k_pe</code> 一并缓存入 <code>KV Cache</code></p><ul><li><p><strong>KV Cache</strong>:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix} \mathbf{c}_t^{KV} &amp;\mathbf{h}_t \textcolor{#A54F08}{\mathbf{W}^{KR}} \color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span>: 同 Cache Compressed (CC)</p><p><span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mi>L</mi><mo>⋅</mo><mo stretchy="false">(</mo><mn>512</mn><mo>+</mo><mn>64</mn><mo stretchy="false">)</mo><mo>=</mo><mn>576</mn><mo>⋅</mo><mi>B</mi><mi>L</mi></mrow><annotation encoding="application/x-tex">BL \cdot (512+64) = 576 \cdot BL</annotation></semantics></math></span></span></p></li><li><p><strong>forward</strong></p></li><li><p>计算
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>Q</mi><mi>R</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{QR}</annotation></semantics></math></span>
</span>和融合矩阵
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{#A54F08}{\mathbf{W}^{UQ}\mathbf{W}^{UK}{}^{\top}}</annotation></semantics></math></span>
</span>和
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mi>O</mi></msup></mstyle></mrow><annotation encoding="application/x-tex">\textcolor{#A54F08}{\mathbf{W}^{UV} \mathbf{W}^{O}}</annotation></semantics></math></span></span></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a>
</span><span class=lnt id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a>
</span><span class=lnt id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a>
</span><span class=lnt id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a>
</span><span class=lnt id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a>
</span><span class=lnt id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a>
</span><span class=lnt id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a>
</span><span class=lnt id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a>
</span><span class=lnt id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a>
</span><span class=lnt id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a>
</span><span class=lnt id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a>
</span><span class=lnt id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a>
</span><span class=lnt id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a>
</span><span class=lnt id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a>
</span><span class=lnt id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a>
</span><span class=lnt id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a>
</span><span class=lnt id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a>
</span><span class=lnt id=hl-25-18><a class=lnlinks href=#hl-25-18>18</a>
</span><span class=lnt id=hl-25-19><a class=lnlinks href=#hl-25-19>19</a>
</span><span class=lnt id=hl-25-20><a class=lnlinks href=#hl-25-20>20</a>
</span><span class=lnt id=hl-25-21><a class=lnlinks href=#hl-25-21>21</a>
</span><span class=lnt id=hl-25-22><a class=lnlinks href=#hl-25-22>22</a>
</span><span class=lnt id=hl-25-23><a class=lnlinks href=#hl-25-23>23</a>
</span><span class=lnt id=hl-25-24><a class=lnlinks href=#hl-25-24>24</a>
</span><span class=lnt id=hl-25-25><a class=lnlinks href=#hl-25-25>25</a>
</span><span class=lnt id=hl-25-26><a class=lnlinks href=#hl-25-26>26</a>
</span><span class=lnt id=hl-25-27><a class=lnlinks href=#hl-25-27>27</a>
</span><span class=lnt id=hl-25-28><a class=lnlinks href=#hl-25-28>28</a>
</span><span class=lnt id=hl-25-29><a class=lnlinks href=#hl-25-29>29</a>
</span><span class=lnt id=hl-25-30><a class=lnlinks href=#hl-25-30>30</a>
</span><span class=lnt id=hl-25-31><a class=lnlinks href=#hl-25-31>31</a>
</span><span class=lnt id=hl-25-32><a class=lnlinks href=#hl-25-32>32</a>
</span><span class=lnt id=hl-25-33><a class=lnlinks href=#hl-25-33>33</a>
</span><span class=lnt id=hl-25-34><a class=lnlinks href=#hl-25-34>34</a>
</span><span class=lnt id=hl-25-35><a class=lnlinks href=#hl-25-35>35</a>
</span><span class=lnt id=hl-25-36><a class=lnlinks href=#hl-25-36>36</a>
</span><span class=lnt id=hl-25-37><a class=lnlinks href=#hl-25-37>37</a>
</span><span class=lnt id=hl-25-38><a class=lnlinks href=#hl-25-38>38</a>
</span><span class=lnt id=hl-25-39><a class=lnlinks href=#hl-25-39>39</a>
</span><span class=lnt id=hl-25-40><a class=lnlinks href=#hl-25-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_absorbed_proj</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 只计算一次</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s1>&#39;_absorbed&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># 只适用于无 bias 的情况</span>
</span></span><span class=line><span class=cl>        <span class=k>assert</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=o>.</span><span class=n>bias</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=o>.</span><span class=n>bias</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=o>.</span><span class=n>bias</span> <span class=ow>is</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=c1># [128, (128+64), 1536]</span>
</span></span><span class=line><span class=cl>        <span class=n>q_b_proj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_b_proj</span><span class=o>.</span><span class=n>weight</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># W^{UQ}, W^{QR}</span>
</span></span><span class=line><span class=cl>        <span class=c1># [n_h, nope_hd, q_lora_rank], [n_h, rope_hd, q_lora_rank]</span>
</span></span><span class=line><span class=cl>        <span class=c1># [128, 128, 1536], [128, 64, 1536]</span>
</span></span><span class=line><span class=cl>        <span class=n>q_b_proj_nope</span><span class=p>,</span> <span class=n>q_b_proj_rope</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>           <span class=n>q_b_proj</span><span class=p>,</span>
</span></span><span class=line><span class=cl>           <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span>
</span></span><span class=line><span class=cl>           <span class=n>dim</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># [128, (128+128), 1536]</span>
</span></span><span class=line><span class=cl>        <span class=n>kv_b_proj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_b_proj</span><span class=o>.</span><span class=n>weight</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1># W^{UK}, W^{UV}</span>
</span></span><span class=line><span class=cl>        <span class=c1># [n_h, nope_hd, kv_lora_rank], [n_h, v_hd, kv_lora_rank]</span>
</span></span><span class=line><span class=cl>        <span class=c1># [128, 128, 512], [128, 64, 512]</span>
</span></span><span class=line><span class=cl>        <span class=n>q_absorb</span><span class=p>,</span> <span class=n>out_absorb</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=n>kv_b_proj</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>qk_nope_head_dim</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1># [5120, 128, 128]</span>
</span></span><span class=line><span class=cl>        <span class=n>o_proj</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>o_proj</span><span class=o>.</span><span class=n>weight</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>hidden_size</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>num_heads</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>v_head_dim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># q_abosrbed: W^{UQ}*W^{UK}^T</span>
</span></span><span class=line><span class=cl>        <span class=c1># [n_h, kv_lora_rank, q_lora_rank]</span>
</span></span><span class=line><span class=cl>        <span class=c1># [128, 512, 1536]</span>
</span></span><span class=line><span class=cl>        <span class=n>q_absorbed</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;hdq,hdk-&gt;hkq&#39;</span><span class=p>,</span> <span class=n>q_b_proj_nope</span><span class=p>,</span> <span class=n>q_absorb</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     	<span class=c1># out_absorbed: W^{UV}*W^{O}</span>
</span></span><span class=line><span class=cl>    	<span class=c1># [hidden_size, n_h, kv_lora_rank]</span>
</span></span><span class=line><span class=cl>        <span class=c1># [5120, 128, 512]</span>
</span></span><span class=line><span class=cl>    	<span class=n>out_absorbed</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;hvk,dhv-&gt;dhk&#39;</span><span class=p>,</span> <span class=n>out_absorb</span><span class=p>,</span> <span class=n>o_proj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_absorbed</span> <span class=o>=</span> <span class=n>q_b_proj_rope</span><span class=p>,</span> <span class=n>q_absorbed</span><span class=p>,</span> <span class=n>out_absorbed</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_absorbed</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>q</code>: [<code>q_nope</code>, <code>q_pe</code>]:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>Q</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mi mathvariant="bold">W</mi><mrow><mi>U</mi><mi>K</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mstyle></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mi>Q</mi></msubsup><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>Q</mi><mi>R</mi><mo separator="true">,</mo><mi>i</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>i</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{UQ, i}\mathbf{W}^{UK, i}{}^{\top}} 
    &amp; \mathbf{c}_t^{Q}\textcolor{#A54F08}{\mathbf{W}^{QR, i}}\color{#6D8E14}{\mathbf{\mathcal{R}}_i}\end{bmatrix}</annotation></semantics></math></span>
</span><strong>[B, 128, L, 512+64]</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a>
</span><span class=lnt id=hl-26-2><a class=lnlinks href=#hl-26-2>2</a>
</span><span class=lnt id=hl-26-3><a class=lnlinks href=#hl-26-3>3</a>
</span><span class=lnt id=hl-26-4><a class=lnlinks href=#hl-26-4>4</a>
</span><span class=lnt id=hl-26-5><a class=lnlinks href=#hl-26-5>5</a>
</span><span class=lnt id=hl-26-6><a class=lnlinks href=#hl-26-6>6</a>
</span><span class=lnt id=hl-26-7><a class=lnlinks href=#hl-26-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>q_b_proj_rope</span><span class=p>,</span> <span class=n>q_absorbed</span><span class=p>,</span> <span class=n>out_absorbed</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_absorbed_proj</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>q</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>q_a_layernorm</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>q_a_proj</span><span class=p>(</span><span class=n>hidden_states_q</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>q_nope</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bqc,hdc-&gt;bhqd&#39;</span><span class=p>,</span> <span class=n>q</span><span class=p>,</span> <span class=n>q_absorbed</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bqc,hdc-&gt;bhqd&#39;</span><span class=p>,</span> <span class=n>q</span><span class=p>,</span> <span class=n>q_b_proj_rope</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cos</span><span class=p>,</span> <span class=n>sin</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>rotary_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>q_pe</span> <span class=o>=</span> <span class=n>apply_rotary_pos_emb</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>cos</span><span class=p>,</span> <span class=n>sin</span><span class=p>,</span> <span class=n>q_position_ids</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p><code>k</code>: [<code>compressed_kv</code>, <code>k_pe</code>]:
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi mathvariant="bold">c</mi><mi>t</mi><mrow><mi>K</mi><mi>V</mi></mrow></msubsup></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">h</mi><mi>t</mi></msub><mstyle mathcolor="#A54F08"><msup><mi mathvariant="bold">W</mi><mrow><mi>K</mi><mi>R</mi></mrow></msup></mstyle><mstyle mathcolor="#6D8E14"><msub><mi mathvariant="script">R</mi><mi>t</mi></msub></mstyle></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><annotation encoding="application/x-tex">\begin{bmatrix}\mathbf{c}_t^{KV}&amp;\mathbf{h}_t\textcolor{#A54F08}{\mathbf{W}^{KR}}\color{#6D8E14}{\mathbf{\mathcal{R}}_t}\end{bmatrix}</annotation></semantics></math></span>
</span><strong>[B, 128, L, 512+64]</strong></p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-27-1><a class=lnlinks href=#hl-27-1>1</a>
</span><span class=lnt id=hl-27-2><a class=lnlinks href=#hl-27-2>2</a>
</span><span class=lnt id=hl-27-3><a class=lnlinks href=#hl-27-3>3</a>
</span><span class=lnt id=hl-27-4><a class=lnlinks href=#hl-27-4>4</a>
</span><span class=lnt id=hl-27-5><a class=lnlinks href=#hl-27-5>5</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>kv_seq_len</span> <span class=o>=</span> <span class=n>compressed_kv</span><span class=o>.</span><span class=n>size</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>compressed_kv</span><span class=p>,</span> <span class=n>k_pe</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>split</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>compressed_kv</span><span class=p>,</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>kv_lora_rank</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>],</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>k_pe</span> <span class=o>=</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>view</span><span class=p>(</span><span class=n>bsz</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>kv_seq_len</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>qk_rope_head_dim</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div></li><li><p>计算 attention</p><p><strong>MoveElision 优化策略</strong>: 省略此处的拼接 RoPE 部分和非 RoPE 部分的过程，而是直接分别计算量部分的额 Attention Score 并相加（考虑
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">q</mi><mi>t</mi></msub><msub><mi mathvariant="bold">k</mi><mi>j</mi></msub><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>=</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>C</mi></msubsup><msubsup><mi mathvariant="script">k</mi><mi>j</mi><mi>C</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup><mo>+</mo><msubsup><mi mathvariant="bold">q</mi><mi>t</mi><mi>R</mi></msubsup><msubsup><mi>k</mi><mi>j</mi><mi>R</mi></msubsup><msup><mrow></mrow><mi mathvariant="normal">⊤</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{q}_{t}\mathbf{k}_{j}{}^{\top} = \mathbf{q}_{t}^C \mathcal{k}_j^C{}^{\top}+ {\mathbf{q}_t^R} k_j^R{}^{\top}</annotation></semantics></math></span>
</span>)</p><div class="mb-3 syntax-highlight"><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-28-1><a class=lnlinks href=#hl-28-1>1</a>
</span><span class=lnt id=hl-28-2><a class=lnlinks href=#hl-28-2>2</a>
</span><span class=lnt id=hl-28-3><a class=lnlinks href=#hl-28-3>3</a>
</span><span class=lnt id=hl-28-4><a class=lnlinks href=#hl-28-4>4</a>
</span><span class=lnt id=hl-28-5><a class=lnlinks href=#hl-28-5>5</a>
</span><span class=lnt id=hl-28-6><a class=lnlinks href=#hl-28-6>6</a>
</span><span class=lnt id=hl-28-7><a class=lnlinks href=#hl-28-7>7</a>
</span><span class=lnt id=hl-28-8><a class=lnlinks href=#hl-28-8>8</a>
</span><span class=lnt id=hl-28-9><a class=lnlinks href=#hl-28-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># MoveElision [B, 128, L, 512]*[B, 128, L, 512] + [B, 128, L, 64]*[B, 128, L, 64]</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>q_pe</span><span class=p>,</span> <span class=n>k_pe</span><span class=o>.</span><span class=n>mT</span><span class=p>)</span> <span class=o>+</span> <span class=n>torch</span><span class=o>.</span><span class=n>matmul</span><span class=p>(</span><span class=n>q_nope</span><span class=p>,</span> <span class=n>compressed_kv</span><span class=o>.</span><span class=n>unsqueeze</span><span class=p>(</span><span class=o>-</span><span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>mT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>softmax_scale</span>
</span></span><span class=line><span class=cl><span class=n>attn_weights</span> <span class=o>=</span> <span class=n>nn</span><span class=o>.</span><span class=n>functional</span><span class=o>.</span><span class=n>softmax</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>attn_weights</span><span class=p>,</span> <span class=n>dim</span><span class=o>=-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>float32</span>
</span></span><span class=line><span class=cl><span class=p>)</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>q_nope</span><span class=o>.</span><span class=n>dtype</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bhql,blc-&gt;bhqc&#39;</span><span class=p>,</span> <span class=n>attn_weights</span><span class=p>,</span> <span class=n>compressed_kv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>attn_output</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>einsum</span><span class=p>(</span><span class=s1>&#39;bhqc,dhc-&gt;bqd&#39;</span><span class=p>,</span> <span class=n>attn_output</span><span class=p>,</span> <span class=n>out_absorbed</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div></div><p>作者认为没有必要再改变顺序，对模型参数进行预处理，将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span>
</span>与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UQ}</annotation></semantics></math></span>
</span>相乘，以及将
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UV}</annotation></semantics></math></span>
</span>与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">W^O</annotation></semantics></math></span>
</span>相乘。</p><p>这是因为，
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>K</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UK}</annotation></semantics></math></span>
</span>与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>Q</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UQ}</annotation></semantics></math></span>
</span>相乘后的结果可以视为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span>
</span>个大小为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1536</mn><mo>×</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">1536 \times 512</annotation></semantics></math></span>
</span>的低秩（不超过 128）矩阵，而
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mrow><mi>U</mi><mi>V</mi></mrow></msup></mrow><annotation encoding="application/x-tex">W^{UV}</annotation></semantics></math></span>
</span>与
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>O</mi></msup></mrow><annotation encoding="application/x-tex">W^O</annotation></semantics></math></span>
</span>相乘的结果可以视为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi></mrow><annotation encoding="application/x-tex">H</annotation></semantics></math></span>
</span>个大小为
<span class=mathjax-inline><span class=katex><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5120</mn><mo>×</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">5120 \times 512</annotation></semantics></math></span>
</span>的低秩矩阵。相比用这些特别大的低秩矩阵做投影，明显不如按照低秩分解形式依次相乘来得划算。</p></li></ul><h1 id=reference class=heading>Reference<a href=#reference aria-labelledby=reference><svg class="svg-inline--fa fas fa-link anchor" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 640 512"><use href="#fas-link"/></svg></a></h1><ul><li><a href=https://kexue.fm/archives/10091 class=markdown-link>缓存与效果的极限拉扯：从 MHA、MQA、GQA 到 MLA</a></li><li><a href=https://zhuanlan.zhihu.com/p/700214123 class=markdown-link>DeepSeek-V2 高性能推理 (1)：通过矩阵吸收十倍提速 MLA 算子</a></li></ul></div><div class="row row-cols-2 mt-5 mb-3"><div class=col></div><div class="col text-end"><a class=previous href=/blogs/rope/>RoPE&nbsp;<svg class="svg-inline--fa fas fa-arrow-right" fill="currentcolor" aria-hidden="true" role="img" viewBox="0 0 448 512"><use href="#fas-arrow-right"/></svg></a></div></div><a href=# id=back-to-top class=back-to-top><span>▲</span>
</a><a href=# id=scroll-to-bottom class=back-to-top><span>▼</span>
</a><script>document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("back-to-top"),t=document.getElementById("scroll-to-bottom");e.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:0,behavior:"smooth"})}),t.addEventListener("click",function(e){e.preventDefault(),window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})})})</script></div><div class="col col-md-3 col-lg-2 d-none d-md-block pt-5"><div class="toc toc-sidebar mb-5 my-md-0 mb-lg-5 p-3 text-body-secondary sticky-top"><strong class="d-block h6 my-2 pt-4">On this page:</strong><nav class=toc><a class="toc-item toc-level-1" href=/blogs/attention/#kv-cache>KV Cache </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-推理过程>KV Cache 推理过程 </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-参数量估计>KV Cache 参数量估计 </a><a class="toc-item toc-level-2" href=/blogs/attention/#kv-cache-降低的重要性>KV Cache 降低的重要性 </a><a class="toc-item toc-level-1" href=/blogs/attention/#mha--mqa--gqa--mla>MHA & MQA & GQA & MLA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mha>MHA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mqa>MQA </a><a class="toc-item toc-level-2" href=/blogs/attention/#gqa>GQA </a><a class="toc-item toc-level-2" href=/blogs/attention/#mla>MLA</a></nav></div></div></div></div><footer class="container-fluid footer text-center p-3"><div class="container-xxl text-center"><small>Copyright © 2025 EV's Blog All rights reserved.
|
Powered by
<a href=https://gethinode.com class="link-bg-footer markdown-link">Hinode</a>.</small></div></footer></div><div id=toast-container class="toast-container position-fixed bottom-0 end-0 p-3"><div id=toast-copied-code-message class=toast role=alert aria-live=assertive aria-atomic=true><div class=toast-header><strong class=me-auto>EV's Blog</strong>
<button type=button class=btn-close data-bs-dismiss=toast aria-label=Close></button></div><div class=toast-body>Code copied to clipboard</div></div></div><svg xmlns:xlink="http://www.w3.org/1999/xlink" display="none"><symbol id="fas-ellipsis"><path d="M8 256a56 56 0 11112 0A56 56 0 118 256zm160 0a56 56 0 11112 0 56 56 0 11-112 0zm216-56a56 56 0 110 112 56 56 0 110-112z"/></symbol><symbol id="fas-sun"><path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 11192 0 96 96 0 11-192 0zm224 0a128 128 0 10-256 0 128 128 0 10256 0z"/></symbol><symbol id="fas-moon"><path d="M223.5 32C1e2 32 0 132.3.0 256S1e2 480 223.5 480c60.6.0 115.5-24.2 155.8-63.4 5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6-96.9.0-175.5-78.8-175.5-176 0-65.8 36-123.1 89.3-153.3 6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z"/></symbol><symbol id="fas-angle-left"><path d="M41.4 233.4c-12.5 12.5-12.5 32.8.0 45.3l160 160c12.5 12.5 32.8 12.5 45.3.0s12.5-32.8.0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8.0-45.3s-32.8-12.5-45.3.0l-160 160z"/></symbol><symbol id="fas-sort"><path d="M137.4 41.4c12.5-12.5 32.8-12.5 45.3.0l128 128c9.2 9.2 11.9 22.9 6.9 34.9S301 224.1 288 224.1L32 224c-12.9.0-24.6-7.8-29.6-19.8s-2.2-25.7 6.9-34.9l128-128zm0 429.3-128-128c-9.2-9.2-11.9-22.9-6.9-34.9S19.1 288 32.1 288h256c12.9.0 24.6 7.8 29.6 19.8s2.2 25.7-6.9 34.9l-128 128c-12.5 12.5-32.8 12.5-45.3.0z"/></symbol><symbol id="fas-arrow-right"><path d="M438.6 278.6c12.5-12.5 12.5-32.8.0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3.0s-12.5 32.8.0 45.3L338.8 224H32c-17.7.0-32 14.3-32 32s14.3 32 32 32h306.7L233.4 393.4c-12.5 12.5-12.5 32.8.0 45.3s32.8 12.5 45.3.0l160-160z"/></symbol></svg>
<script src=/js/core.bundle-analytics.en.min.ceb6a67c169a28031391976dac91e1e2f460951862201b6249516a55d0fd6109.js data-category=analytics integrity="sha256-zramfBaaKAMTkZdtrJHh4vRglRhiIBtiSVFqVdD9YQk=" crossorigin=anonymous async></script><script src=/js/core.bundle.en.min.b8e0ff5c57c63ab837cb41abc2ff86ef6273c77fcd65b75f1705a49a993acd9d.js integrity="sha256-uOD/XFfGOrg3y0Grwv+G72Jzx3/NZbdfFwWkmpk6zZ0=" crossorigin=anonymous async></script></body></html>